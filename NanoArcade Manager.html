<!DOCTYPE HTML>
<!--
	NanoArcade
	Based on Hyperspace by HTML5 UP (html5up.net | @ajlkn)
-->
<html>
	<head>
		<title>NanoArcade</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
			/* Custom styles for NanoArcade */
			#sidebar nav ul li {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			#sidebar nav ul li img.console-icon {
				width: 32px;
				height: 32px;
				object-fit: contain;
			}

			#sidebar nav ul li .game-count {
				margin-left: auto;
				background: rgba(255,255,255,0.1);
				padding: 2px 8px;
				border-radius: 10px;
				font-size: 0.8em;
			}

			#sidebar nav ul li .warning {
				color: #60a5fa;
			}

			.games-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
				gap: 1.5em;
				padding: 1em 0;
				align-items: start;
			}

			.game-card {
				background: rgba(255,255,255,0.05);
				border-radius: 10px;
				transition: transform 0.3s, box-shadow 0.3s;
				cursor: pointer;
				display: flex;
				flex-direction: column;
			}

			.game-card:hover {
				transform: translateY(-5px);
				box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
			}

			.game-card .image-container {
				width: 100%;
				background: rgba(0,0,0,0.3);
				position: relative;
				border-radius: 10px 10px 0 0;
				overflow: hidden;
			}

			.game-card .image-container img {
				width: 100%;
				height: auto;
				display: block;
			}

			.game-card .no-image {
				color: rgba(255,255,255,0.3);
				font-size: 3em;
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 180px;
			}

			.game-card .game-name {
				padding: 10px;
				font-size: 0.8em;
				text-align: center;
				white-space: normal;
				word-wrap: break-word;
				overflow-wrap: break-word;
				line-height: 1.3;
				color: #fff;
			}

			.game-card .missing-badge {
				position: absolute;
				top: 5px;
				right: 5px;
				background: #3b82f6;
				color: #fff;
				padding: 3px 8px;
				border-radius: 3px;
				font-size: 0.7em;
			}

			.stats-row {
				display: flex;
				gap: 2em;
				margin-bottom: 2em;
				flex-wrap: wrap;
			}

			.stat-box {
				background: rgba(255,255,255,0.05);
				padding: 1em 2em;
				border-radius: 10px;
				text-align: center;
			}

			.stat-box .value {
				font-size: 2em;
				color: #60a5fa;
				font-weight: bold;
			}

			.stat-box .label {
				font-size: 0.9em;
				color: rgba(255,255,255,0.55);
			}

			.controls-bar {
				display: flex;
				gap: 1em;
				align-items: center;
				flex-wrap: wrap;
				margin-bottom: 2em;
			}

			/* Hero Select Drive Button */
			.hero-select-btn {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
				color: #fff;
				border: none;
				padding: 8px 16px;
				border-radius: 8px;
				cursor: pointer;
				font-size: 0.75em;
				font-weight: 600;
				letter-spacing: 0.5px;
				text-transform: uppercase;
				transition: all 0.3s ease;
				box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4), 0 0 0 0 rgba(59, 130, 246, 0.5);
				position: relative;
				overflow: hidden;
				animation: pulse-glow 2s ease-in-out infinite;
			}

			@keyframes pulse-glow {
				0%, 100% { box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4), 0 0 0 0 rgba(59, 130, 246, 0.5); }
				50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6), 0 0 12px 3px rgba(59, 130, 246, 0.3); }
			}

			.hero-select-btn::before {
				content: '';
				position: absolute;
				top: 0;
				left: -100%;
				width: 100%;
				height: 100%;
				background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
				transition: left 0.5s ease;
			}

			.hero-select-btn:hover {
				transform: translateY(-2px) scale(1.02);
				box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5), 0 0 15px 5px rgba(59, 130, 246, 0.2);
				animation: none;
			}

			.hero-select-btn:hover::before {
				left: 100%;
			}

			.hero-select-btn:active {
				transform: translateY(-1px) scale(1.01);
			}

			.hero-select-btn .icon {
				font-size: 1em;
			}

			.hero-select-btn::after {
				display: none !important;
			}

			.search-input {
				flex: 1;
				min-width: 200px;
			}

			/* Modal styles */
			.modal-overlay {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.85);
				z-index: 10000;
				align-items: center;
				justify-content: center;
			}

			.modal-overlay.active {
				display: flex;
			}

			.modal-box {
				background: #1e293b;
				padding: 1.5em;
				border-radius: 12px;
				max-width: 600px;
				width: 90%;
				border: 2px solid #2563eb;
				position: relative;
			}

			.modal-box .modal-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1em;
			}

			.modal-box h3 {
				color: #60a5fa;
				margin: 0;
				font-size: 1.1em;
			}

			.modal-box .close-btn {
				background: none !important;
				border: none !important;
				color: #fff;
				cursor: pointer;
				font-size: 1.25em;
				padding: 0 !important;
				opacity: 0.7;
				transition: opacity 0.2s;
				box-shadow: none !important;
				width: auto !important;
				height: auto !important;
				line-height: 1 !important;
			}

			.modal-box .close-btn:before,
			.modal-box .close-btn:after {
				display: none !important;
			}

			.modal-box .close-btn:hover {
				opacity: 1;
				background: none !important;
			}

			/* Game modal specific */
			.game-modal-content {
				display: flex;
				gap: 1em;
			}

			.game-modal-left {
				flex-shrink: 0;
			}

			.game-modal-right {
				flex: 1;
				display: flex;
				flex-direction: column;
				gap: 0.5em;
				min-width: 0;
			}

			.image-preview {
				min-width: 160px;
				min-height: 160px;
				max-width: 200px;
				background: rgba(0,0,0,0.3);
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 8px;
				overflow: hidden;
				padding: 8px;
			}

			.image-preview img {
				max-width: 100%;
				max-height: 200px;
				width: auto;
				height: auto;
				object-fit: contain;
			}

			.compact-field {
				margin-bottom: 0.25em;
			}

			.compact-field label {
				font-size: 0.8em;
				margin-bottom: 0.2em;
				display: block;
				color: rgba(255,255,255,0.7);
			}

			.compact-field input {
				padding: 0.4em 0.6em;
				font-size: 0.85em;
				width: 100%;
				box-sizing: border-box;
			}

			.compact-actions {
				display: flex;
				gap: 0.4em;
				margin-top: 0.25em;
				flex-wrap: wrap;
			}

			/* Modern sleek button styling */
			.modal-box .sleek-btn {
				display: inline-flex;
				align-items: center;
				gap: 6px;
				background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
				color: #fff;
				border: none;
				padding: 8px 14px;
				border-radius: 8px;
				cursor: pointer;
				font-size: 0.8em;
				font-weight: 500;
				letter-spacing: 0.3px;
				transition: all 0.2s ease;
				box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
				position: relative;
				overflow: hidden;
			}

			.modal-box .sleek-btn::before {
				content: '';
				position: absolute;
				top: 0;
				left: -100%;
				width: 100%;
				height: 100%;
				background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
				transition: left 0.4s ease;
			}

			.modal-box .sleek-btn:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
			}

			.modal-box .sleek-btn:hover::before {
				left: 100%;
			}

			.modal-box .sleek-btn:active {
				transform: translateY(0);
				box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
			}

			.modal-box .sleek-btn.secondary {
				background: linear-gradient(135deg, #475569 0%, #334155 100%);
				box-shadow: 0 2px 8px rgba(71, 85, 105, 0.3);
			}

			.modal-box .sleek-btn.secondary:hover {
				box-shadow: 0 4px 12px rgba(71, 85, 105, 0.4);
			}

			.modal-box .sleek-btn.success {
				background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
				box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
			}

			.modal-box .sleek-btn.success:hover {
				box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
			}

			.modal-box .sleek-btn .icon {
				font-size: 0.9em;
			}

			.modal-box .google-link {
				color: #60a5fa;
				text-decoration: none;
				font-size: 0.85em;
				margin-left: 0.5em;
			}

			.modal-box .google-link:hover {
				text-decoration: underline;
			}

			/* Image picker modal - fullscreen */
			.image-picker-overlay {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0,0,0,0.9);
				z-index: 10001;
				display: none;
				flex-direction: column;
				padding: 1em;
			}

			.image-picker-overlay.active {
				display: flex;
			}

			.image-picker-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1em;
				flex-shrink: 0;
			}

			.image-picker-header h3 {
				color: #60a5fa;
				margin: 0;
			}

			.image-picker-search {
				display: flex;
				gap: 0.5em;
				flex: 1;
				max-width: 500px;
				margin: 0 2em;
				align-items: center;
			}

			.image-picker-search input {
				flex: 1;
				padding: 0.4em 0.8em;
				border-radius: 4px;
				border: 1px solid #475569;
				background: #1e293b;
				color: #fff;
				font-size: 0.85em;
				height: 32px;
				box-sizing: border-box;
			}

			.image-picker-search .styled-btn {
				padding: 0 12px;
				height: 32px;
				font-size: 0.65em;
			}

			.image-picker-close {
				background: none !important;
				border: none !important;
				color: #fff;
				font-size: 2em;
				cursor: pointer;
				opacity: 0.7;
				padding: 0 !important;
				line-height: 1;
				box-shadow: none !important;
				width: auto !important;
				height: auto !important;
			}

			.image-picker-close:hover {
				opacity: 1;
				background: none !important;
			}

			.image-picker-close::before,
			.image-picker-close::after {
				display: none !important;
			}

			.image-picker-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
				gap: 1em;
				overflow-y: auto;
				flex: 1;
				padding: 0.5em;
				align-items: start;
			}

			.image-picker-grid img {
				max-width: 100%;
				width: auto;
				height: auto;
				object-fit: contain;
				border-radius: 8px;
				cursor: pointer;
				border: 3px solid transparent;
				transition: border-color 0.2s, transform 0.2s;
				background: rgba(0,0,0,0.3);
			}

			.image-picker-grid img:hover {
				border-color: #3b82f6;
				transform: scale(1.03);
			}

			.image-picker-grid img.selected {
				border-color: #22c55e;
			}

			.image-picker-grid .loading,
			.image-picker-grid .no-results {
				grid-column: 1 / -1;
				text-align: center;
				color: rgba(255,255,255,0.5);
				padding: 3em;
				font-size: 1.2em;
			}

			.image-picker-footer {
				display: flex;
				justify-content: flex-end;
				align-items: center;
				margin-top: 1em;
				flex-shrink: 0;
				padding-top: 1em;
				border-top: 1px solid #334155;
			}

			.image-picker-footer .select-btn {
				display: inline-flex;
				align-items: center;
				gap: 8px;
				padding: 10px 24px;
				background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
				border: none;
				border-radius: 8px;
				color: #fff;
				cursor: pointer;
				font-size: 1em;
				font-weight: 500;
				box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
				transition: all 0.2s ease;
			}

			.image-picker-footer .select-btn:hover:not(:disabled) {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
			}

			.image-picker-footer .select-btn:disabled {
				background: linear-gradient(135deg, #475569 0%, #334155 100%);
				box-shadow: 0 2px 8px rgba(71, 85, 105, 0.3);
				cursor: not-allowed;
			}

			.drop-zone {
				border: 3px dashed rgba(37, 99, 235, 0.5);
				border-radius: 10px;
				padding: 2em;
				text-align: center;
				margin-bottom: 1em;
				transition: all 0.3s;
			}

			.drop-zone.dragover {
				border-color: #3b82f6;
				background: rgba(59, 130, 246, 0.1);
			}

			/* Modern styled buttons for modals */
			.styled-btn {
				display: inline-flex;
				align-items: center;
				gap: 5px;
				background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
				color: #fff;
				border: none;
				padding: 6px 12px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 0.7em;
				font-weight: 600;
				letter-spacing: 0.3px;
				text-transform: uppercase;
				transition: all 0.3s ease;
				box-shadow: 0 3px 12px rgba(59, 130, 246, 0.4);
				position: relative;
				overflow: hidden;
			}

			.styled-btn::before {
				content: '';
				position: absolute;
				top: 0;
				left: -100%;
				width: 100%;
				height: 100%;
				background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
				transition: left 0.5s ease;
			}

			.styled-btn:hover {
				transform: translateY(-2px) scale(1.02);
				box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
			}

			.styled-btn:hover::before {
				left: 100%;
			}

			.styled-btn:active {
				transform: translateY(-1px) scale(1.01);
			}

			.styled-btn::after {
				display: none !important;
			}

			.styled-btn.green {
				background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
				box-shadow: 0 3px 12px rgba(34, 197, 94, 0.4);
			}

			.styled-btn.green:hover {
				box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
			}

			.styled-btn.red {
				background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
				box-shadow: 0 3px 12px rgba(239, 68, 68, 0.4);
			}

			.styled-btn.red:hover {
				box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
			}

			.styled-btn.small {
				padding: 5px 10px;
				font-size: 0.65em;
			}

			.styled-btn:disabled {
				background: linear-gradient(135deg, #475569 0%, #334155 100%);
				box-shadow: 0 2px 8px rgba(71, 85, 105, 0.3);
				cursor: not-allowed;
				opacity: 0.7;
			}

			.styled-btn:disabled:hover {
				transform: none;
				box-shadow: 0 2px 8px rgba(71, 85, 105, 0.3);
			}

			.file-list {
				max-height: 200px;
				overflow-y: auto;
			}

			.file-item {
				display: flex;
				flex-direction: column;
				padding: 0.5em;
				background: rgba(255,255,255,0.05);
				margin-bottom: 5px;
				border-radius: 5px;
			}

			.file-item .original {
				color: rgba(255,255,255,0.4);
				font-size: 0.8em;
			}

			.file-item .clean {
				color: #4ade80;
			}

			.status-msg {
				padding: 0.75em 1em;
				border-radius: 5px;
				margin-top: 1em;
				display: none;
			}

			.status-msg.success {
				background: rgba(74, 222, 128, 0.2);
				color: #4ade80;
				display: block;
			}

			.status-msg.error {
				background: rgba(239, 68, 68, 0.2);
				color: #f87171;
				display: block;
			}

			#sidebar {
				width: 20em;
			}

			/* Hide scrollbar but allow scrolling */
			#sidebar::-webkit-scrollbar {
				display: none;
			}

			#sidebar {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}

			#sidebar nav ul {
				max-height: calc(100vh - 100px);
				overflow-y: auto;
				-ms-overflow-style: none;
				scrollbar-width: none;
			}

			#sidebar nav ul::-webkit-scrollbar {
				display: none;
			}

			@media screen and (max-width: 1280px) {
				#sidebar {
					width: 18em;
				}
			}

			@media screen and (max-width: 736px) {
				.games-grid {
					grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
				}
			}

			/* Floating upload button */
			.floating-upload {
				position: fixed;
				top: 20px;
				right: 20px;
				z-index: 1000;
				display: none;
				align-items: center;
				gap: 6px;
				background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
				color: #fff;
				border: none;
				padding: 8px 16px;
				border-radius: 8px;
				cursor: pointer;
				font-size: 0.75em;
				font-weight: 600;
				letter-spacing: 0.5px;
				text-transform: uppercase;
				transition: all 0.3s ease;
				box-shadow: 0 4px 16px rgba(34, 197, 94, 0.4), 0 0 0 0 rgba(34, 197, 94, 0.5);
				overflow: hidden;
				animation: pulse-glow-green 2s ease-in-out infinite;
			}

			@keyframes pulse-glow-green {
				0%, 100% { box-shadow: 0 4px 16px rgba(34, 197, 94, 0.4), 0 0 0 0 rgba(34, 197, 94, 0.5); }
				50% { box-shadow: 0 4px 20px rgba(34, 197, 94, 0.6), 0 0 12px 3px rgba(34, 197, 94, 0.3); }
			}

			.floating-upload::before {
				content: '';
				position: absolute;
				top: 0;
				left: -100%;
				width: 100%;
				height: 100%;
				background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
				transition: left 0.5s ease;
			}

			.floating-upload:hover {
				transform: translateY(-2px) scale(1.02);
				box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5), 0 0 15px 5px rgba(34, 197, 94, 0.2);
				animation: none;
			}

			.floating-upload:hover::before {
				left: 100%;
			}

			.floating-upload:active {
				transform: translateY(-1px) scale(1.01);
			}

			.floating-upload .icon {
				font-size: 1em;
			}

			.floating-upload::after {
				display: none !important;
			}

			.floating-upload.visible {
				display: inline-flex;
			}

			/* Modern Hero Section */
			.hero-section {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				text-align: center;
				min-height: 100vh;
				padding: 2em;
			}

			.hero-logo {
				width: 700px;
				max-width: 90vw;
				height: auto;
				margin-bottom: 1.5em;
				filter: drop-shadow(0 15px 40px rgba(59, 130, 246, 0.4));
				animation: float 3s ease-in-out infinite;
			}

			@keyframes float {
				0%, 100% { transform: translateY(0); }
				50% { transform: translateY(-12px); }
			}

			.hero-tagline {
				font-size: 0.95em;
				color: rgba(255, 255, 255, 0.6);
				max-width: 400px;
				margin: 0 auto 1.5em auto;
				line-height: 1.5;
			}

			.hero-stats {
				display: flex;
				gap: 3em;
				margin-top: 3em;
				justify-content: center;
				flex-wrap: wrap;
			}

			.hero-stat {
				text-align: center;
			}

			.hero-stat .value {
				font-size: 2.5em;
				font-weight: 700;
				color: #60a5fa;
				line-height: 1;
			}

			.hero-stat .label {
				font-size: 0.85em;
				color: rgba(255, 255, 255, 0.5);
				text-transform: uppercase;
				letter-spacing: 1px;
				margin-top: 0.5em;
			}

			.footer-content {
				display: flex;
				align-items: center;
				gap: 12px;
				justify-content: center;
			}

			.footer-logo {
				width: 50px;
				height: auto;
				opacity: 0.7;
				transition: opacity 0.3s;
			}

			.footer-logo:hover {
				opacity: 1;
			}

			.footer-text {
				font-size: 0.9em;
				opacity: 0.6;
			}

			@media screen and (max-width: 736px) {
				.hero-logo {
					width: 320px;
				}
				.hero-stats {
					gap: 2em;
				}
			}

			/* Apply intro background stripes to games section */
			#games {
				background-attachment: fixed;
				background-image: url("assets/css/images/intro.svg");
				background-position: top right;
				background-repeat: no-repeat;
				background-size: 100% 100%;
			}

			@media screen and (max-width: 1280px) {
				#games {
					background-attachment: scroll;
				}
			}

			/* Filter and Sort Controls */
			.filter-btn {
				display: inline-flex;
				align-items: center;
				gap: 5px;
				background: rgba(255,255,255,0.1);
				color: #fff;
				border: 1px solid rgba(255,255,255,0.2);
				padding: 6px 12px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 0.75em;
				font-weight: 500;
				transition: all 0.2s ease;
			}

			.filter-btn:hover {
				background: rgba(255,255,255,0.15);
				border-color: rgba(255,255,255,0.3);
			}

			.filter-btn.active {
				background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
				border-color: #3b82f6;
				box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
			}

			.sort-select {
				background: rgba(255,255,255,0.1);
				color: #fff;
				border: 1px solid rgba(255,255,255,0.2);
				padding: 6px 12px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 0.75em;
				font-weight: 500;
				min-width: 140px;
			}

			.sort-select:focus {
				outline: none;
				border-color: #3b82f6;
			}

			.sort-select option {
				background: #1e293b;
				color: #fff;
			}

			/* Game count badge in header */
			.console-header {
				display: flex;
				align-items: center;
				gap: 0.75em;
				flex-wrap: wrap;
			}

			.game-count-badge {
				background: rgba(59, 130, 246, 0.2);
				color: #60a5fa;
				padding: 4px 12px;
				border-radius: 20px;
				font-size: 0.5em;
				font-weight: 500;
			}

			.game-count-badge .missing {
				color: #fbbf24;
				margin-left: 8px;
			}

			/* Next Game button in modal */
			.next-game-btn {
				display: inline-flex;
				align-items: center;
				gap: 5px;
				background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%);
				color: #fff;
				border: none;
				padding: 6px 12px;
				border-radius: 6px;
				cursor: pointer;
				font-size: 0.7em;
				font-weight: 600;
				letter-spacing: 0.3px;
				text-transform: uppercase;
				transition: all 0.3s ease;
				box-shadow: 0 3px 12px rgba(139, 92, 246, 0.4);
			}

			.next-game-btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
			}

			.next-game-btn:disabled {
				background: linear-gradient(135deg, #475569 0%, #334155 100%);
				box-shadow: 0 2px 8px rgba(71, 85, 105, 0.3);
				cursor: not-allowed;
				opacity: 0.7;
			}

			/* Right-click context menu */
			.context-menu {
				position: fixed;
				background: #1e293b;
				border: 1px solid #3b82f6;
				border-radius: 8px;
				box-shadow: 0 10px 40px rgba(0,0,0,0.5);
				z-index: 10002;
				min-width: 180px;
				padding: 6px 0;
				display: none;
			}

			.context-menu.active {
				display: block;
			}

			.context-menu-item {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 10px 16px;
				color: #fff;
				cursor: pointer;
				font-size: 0.85em;
				transition: background 0.2s;
			}

			.context-menu-item:hover {
				background: rgba(59, 130, 246, 0.2);
			}

			.context-menu-item .icon {
				color: #60a5fa;
				width: 16px;
				text-align: center;
			}

			.context-menu-item.danger {
				color: #f87171;
			}

			.context-menu-item.danger .icon {
				color: #f87171;
			}

			.context-menu-divider {
				height: 1px;
				background: rgba(255,255,255,0.1);
				margin: 6px 0;
			}

		</style>
	</head>
	<body class="is-preload">

		<!-- Floating Upload Button -->
		<button class="floating-upload" id="floatingUpload" onclick="openUploadModal()">
			<span class="icon solid fa-upload"></span> Upload Games
		</button>

		<!-- Sidebar -->
		<section id="sidebar">
			<div class="inner">
				<nav>
					<ul id="consoleList">
						<li><a href="#intro">Home</a></li>
					</ul>
				</nav>
			</div>
		</section>

		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Intro -->
			<section id="intro" class="wrapper style1 fullscreen fade-up">
				<div class="hero-section">
					<img src="assets/images/logo.png" alt="NanoArcade" class="hero-logo">
					<p class="hero-tagline">Your retro game collection, beautifully organized. Browse by console, manage box art, and keep your library sharp.</p>
					<button class="hero-select-btn" onclick="scanDrive()">
						<span class="icon solid fa-folder-open"></span> Select Folder
					</button>
					<div class="hero-stats" id="statsRow" style="display:none;">
						<div class="hero-stat">
							<div class="value" id="statConsoles">0</div>
							<div class="label">Consoles</div>
						</div>
						<div class="hero-stat">
							<div class="value" id="statGames">0</div>
							<div class="label">Games</div>
						</div>
						<div class="hero-stat">
							<div class="value" id="statMissing">0</div>
							<div class="label">Missing Art</div>
						</div>
					</div>
				</div>
			</section>

			<!-- Games Section -->
			<section id="games" class="wrapper style1 fade-up" style="display:none;">
				<div class="inner">
					<div class="console-header">
						<h2 id="currentConsoleName">Select a console to view games</h2>
						<span class="game-count-badge" id="gameCountBadge" style="display:none;">
							<span id="totalGameCount">0</span> games
							<span class="missing" id="missingArtCount" style="display:none;">(<span id="missingCount">0</span> missing art)</span>
						</span>
					</div>
					<div class="controls-bar">
						<input type="text" id="searchBox" class="search-input" placeholder="Search games..." oninput="filterGames()">
						<button class="filter-btn" id="filterMissingBtn" onclick="toggleMissingFilter()">
							<span class="icon solid fa-filter"></span> Missing Art Only
						</button>
						<select class="sort-select" id="sortSelect" onchange="sortGames()">
							<option value="az">Sort: A-Z</option>
							<option value="za">Sort: Z-A</option>
							<option value="missing">Missing Art First</option>
							<option value="hasart">Has Art First</option>
						</select>
					</div>
					<div class="games-grid" id="gamesGrid">
						<p>Scan your drive to view games</p>
					</div>
				</div>
			</section>

		</div>

		<!-- Game Modal -->
		<div class="modal-overlay" id="gameModal">
			<div class="modal-box">
				<div class="modal-header">
					<h3 id="modalGameName">Game Name</h3>
					<button class="close-btn" onclick="closeModal('gameModal')">&times;</button>
				</div>
				<div class="game-modal-content">
					<div class="game-modal-left">
						<div class="image-preview" id="modalImagePreview">
							<span class="no-image">?</span>
						</div>
					</div>
					<div class="game-modal-right">
						<div class="compact-actions" style="margin-bottom: 0.75em;">
							<button class="styled-btn" onclick="openImagePicker()"><span class="icon solid fa-search"></span> Search</button>
							<button class="styled-btn" onclick="selectLocalImage()"><span class="icon solid fa-folder-open"></span> Local</button>
						</div>
						<div class="compact-field">
							<label>Or paste image URL: <a href="#" class="google-link" onclick="openGoogleImages(); return false;">Google Images</a></label>
							<input type="url" id="imageUrl" placeholder="https://...">
						</div>
						<div class="compact-actions" style="margin-top: 0.5em;">
							<button class="styled-btn green" onclick="downloadAndResizeImage()"><span class="icon solid fa-download"></span> Download</button>
							<button class="styled-btn red" onclick="confirmDeleteGame()"><span class="icon solid fa-trash"></span> Delete</button>
						</div>
						<div class="compact-actions" style="margin-top: 0.5em;">
							<button class="next-game-btn" id="nextGameBtn" onclick="goToNextMissingArt()"><span class="icon solid fa-forward"></span> Next Missing Art</button>
						</div>
						<div class="status-msg" id="imageStatus"></div>
					</div>
				</div>
				<input type="file" id="localImageInput" accept="image/*" style="display:none;" onchange="handleLocalImage(event)">
			</div>
		</div>

		<!-- Upload Modal -->
		<div class="modal-overlay" id="uploadModal">
			<div class="modal-box">
				<div class="modal-header">
					<h3><span class="icon solid fa-upload"></span> Upload Games</h3>
					<button class="close-btn" onclick="closeModal('uploadModal')">&times;</button>
				</div>
				<div class="field">
					<label>Target Console:</label>
					<select id="uploadConsoleSelect">
						<option value="">Select a console...</option>
					</select>
				</div>
				<div class="drop-zone" id="dropZone">
					<p><span class="icon solid fa-file-import"></span> Drag & drop ROM files here</p>
					<p>or</p>
					<button class="styled-btn small" onclick="document.getElementById('fileInput').click()"><span class="icon solid fa-folder-open"></span> Select Files</button>
					<input type="file" id="fileInput" multiple style="display:none;" onchange="handleFileSelect(event)">
				</div>
				<div class="file-list" id="fileList"></div>
				<div style="text-align: center; margin-top: 1em;">
					<button class="styled-btn green" onclick="uploadFiles()"><span class="icon solid fa-check"></span> Upload & Clean Names</button>
				</div>
				<div class="status-msg" id="uploadStatus"></div>
			</div>
		</div>

		<!-- Delete Confirmation Modal -->
		<div class="modal-overlay" id="deleteModal">
			<div class="modal-box" style="max-width: 400px;">
				<div class="modal-header">
					<h3 style="color: #ef4444;"><span class="icon solid fa-exclamation-triangle"></span> Delete Game</h3>
					<button class="close-btn" onclick="closeModal('deleteModal')">&times;</button>
				</div>
				<p id="deleteConfirmText" style="margin-bottom: 1.5em; text-align: center;">Are you sure you want to delete this game?</p>
				<div style="display: flex; gap: 1em; justify-content: center;">
					<button class="styled-btn" onclick="closeModal('deleteModal')"><span class="icon solid fa-times"></span> Cancel</button>
					<button class="styled-btn red" onclick="executeDeleteGame()"><span class="icon solid fa-trash"></span> Delete</button>
				</div>
			</div>
		</div>

		<!-- Image Picker Modal (fullscreen) -->
		<div class="image-picker-overlay" id="imagePicker">
			<div class="image-picker-header">
				<h3>Select Box Art</h3>
				<div class="image-picker-search">
					<input type="text" id="pickerSearchQuery" placeholder="Search for game..." onkeypress="if(event.key==='Enter')searchImagesInPicker()">
					<button class="styled-btn" onclick="searchImagesInPicker()"><span class="icon solid fa-search"></span> Search</button>
				</div>
				<button class="image-picker-close" onclick="closeImagePicker()">&times;</button>
			</div>
			<div class="image-picker-grid" id="pickerGrid">
				<div class="no-results">Enter a game name and click Search</div>
			</div>
			<div class="image-picker-footer">
				<button class="styled-btn green" id="pickerSelectBtn" onclick="confirmImageSelection()" disabled><span class="icon solid fa-check"></span> Select Image</button>
			</div>
		</div>

		<!-- Context Menu -->
		<div class="context-menu" id="contextMenu">
			<div class="context-menu-item" onclick="contextMenuAction('edit')">
				<span class="icon solid fa-edit"></span> Edit Box Art
			</div>
			<div class="context-menu-item" onclick="contextMenuAction('search')">
				<span class="icon solid fa-search"></span> Search Art
			</div>
			<div class="context-menu-item" onclick="contextMenuAction('google')">
				<span class="icon solid fa-external-link-alt"></span> Google Images
			</div>
			<div class="context-menu-divider"></div>
			<div class="context-menu-item" onclick="contextMenuAction('rename')">
				<span class="icon solid fa-i-cursor"></span> Rename
			</div>
			<div class="context-menu-item danger" onclick="contextMenuAction('delete')">
				<span class="icon solid fa-trash"></span> Delete Game
			</div>
		</div>

		<!-- Rename Modal -->
		<div class="modal-overlay" id="renameModal">
			<div class="modal-box" style="max-width: 450px;">
				<div class="modal-header">
					<h3><span class="icon solid fa-i-cursor"></span> Rename Game</h3>
					<button class="close-btn" onclick="closeModal('renameModal')">&times;</button>
				</div>
				<div class="compact-field" style="margin-bottom: 1em;">
					<label>New name (without extension):</label>
					<input type="text" id="renameInput" placeholder="Enter new name...">
				</div>
				<p style="font-size: 0.8em; color: rgba(255,255,255,0.5); margin-bottom: 1em;">This will rename both the ROM file and its box art image.</p>
				<div style="display: flex; gap: 1em; justify-content: flex-end;">
					<button class="styled-btn" onclick="closeModal('renameModal')"><span class="icon solid fa-times"></span> Cancel</button>
					<button class="styled-btn green" onclick="executeRename()"><span class="icon solid fa-check"></span> Rename</button>
				</div>
				<div class="status-msg" id="renameStatus"></div>
			</div>
		</div>

		<!-- Footer -->
		<footer id="footer" class="wrapper style1-alt">
			<div class="inner">
				<ul class="menu">
					<li>
						<div class="footer-content">
							<img src="assets/images/logo.png" alt="" class="footer-logo">
							<span class="footer-text">NanoArcade</span>
						</div>
					</li>
				</ul>
			</div>
		</footer>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>

		<script>
			// Global state
			let directoryHandle = null;
			let consoles = {};
			let currentConsole = null;
			let currentGame = null;
			let filesToUpload = [];
			let filterMissingOnly = false;
			let currentSort = 'az';
			let contextMenuTarget = null;

			// IndexedDB for persisting directory handle
			const DB_NAME = 'NanoArcade';
			const DB_VERSION = 1;
			const STORE_NAME = 'handles';

			function openDB() {
				return new Promise((resolve, reject) => {
					const request = indexedDB.open(DB_NAME, DB_VERSION);
					request.onerror = () => reject(request.error);
					request.onsuccess = () => resolve(request.result);
					request.onupgradeneeded = (e) => {
						const db = e.target.result;
						if (!db.objectStoreNames.contains(STORE_NAME)) {
							db.createObjectStore(STORE_NAME);
						}
					};
				});
			}

			async function saveHandle(handle) {
				const db = await openDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction(STORE_NAME, 'readwrite');
					tx.objectStore(STORE_NAME).put(handle, 'directoryHandle');
					tx.oncomplete = () => resolve();
					tx.onerror = () => reject(tx.error);
				});
			}

			async function getSavedHandle() {
				const db = await openDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction(STORE_NAME, 'readonly');
					const request = tx.objectStore(STORE_NAME).get('directoryHandle');
					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(request.error);
				});
			}

			async function tryRestoreHandle() {
				try {
					const savedHandle = await getSavedHandle();
					if (savedHandle) {
						// Request permission on the saved handle
						const permission = await savedHandle.requestPermission({ mode: 'readwrite' });
						if (permission === 'granted') {
							directoryHandle = savedHandle;
							await scanExistingDirectory();
							return true;
						}
					}
				} catch (e) {
					console.log('Could not restore saved handle:', e);
				}
				return false;
			}

			async function scanExistingDirectory() {
				if (!directoryHandle) return;
				consoles = {};

				for await (const entry of directoryHandle.values()) {
					if (entry.kind === 'directory') {
						const consoleName = entry.name;
						const games = [];
						try {
							const consoleDir = await directoryHandle.getDirectoryHandle(consoleName);
							for await (const file of consoleDir.values()) {
								if (file.kind === 'file') {
									const ext = '.' + file.name.split('.').pop().toLowerCase();
									if (!['.png', '.jpg', '.jpeg', '.txt', '.cue', '.m3u', '.srm', '.sav'].includes(ext)) {
										const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
										let hasImage = false;
										try {
											await consoleDir.getFileHandle(baseName + '.png');
											hasImage = true;
										} catch {}
										games.push({ name: file.name, baseName, hasImage });
									}
								}
							}
							if (games.length > 0) {
								consoles[consoleName] = {
									handle: consoleDir,
									games: games.sort((a, b) => a.baseName.localeCompare(b.baseName))
								};
							}
						} catch (e) { console.log('Could not access:', consoleName); }
					}
				}
				renderConsoleList();
				updateStats();
			}

			// Try to restore on page load
			window.addEventListener('DOMContentLoaded', async () => {
				const restored = await tryRestoreHandle();
				if (restored) {
					console.log('Directory restored from previous session');
				}
			});

			// Console icons mapping
			const consoleIcons = {
				'game boy': 'icons/GB.png',
				'gb': 'icons/GB.png',
				'game boy color': 'icons/GBC_1.png',
				'gbc': 'icons/GBC_1.png',
				'game boy advance': 'icons/GBA.png',
				'gba': 'icons/GBA.png',
				'nes': 'icons/NES.png',
				'snes': 'icons/SNES.png',
				'super nintendo': 'icons/SNES.png',
				'n64': 'icons/N64.png',
				'nintendo 64': 'icons/N64.png',
				'gamecube': 'icons/GC.png',
				'gc': 'icons/GC.png',
				'sega master system': 'icons/SMS.png',
				'master system': 'icons/SMS.png',
				'sms': 'icons/SMS.png',
				'sega genesis': 'icons/MD_GEN.png',
				'genesis': 'icons/MD_GEN.png',
				'mega drive': 'icons/MD_GEN.png',
				'md': 'icons/MD_GEN.png',
				'saturn': 'icons/SAT_1.png',
				'sega saturn': 'icons/SAT_1.png',
				'dreamcast': 'icons/DC.png',
				'dc': 'icons/DC.png',
				'playstation': 'icons/PS1.png',
				'ps1': 'icons/PS1.png',
				'psx': 'icons/PS1.png',
				'ps2': 'icons/PS2.png',
				'playstation 2': 'icons/PS2.png',
				'arcade': 'icons/MAME.png',
				'mame': 'icons/MAME.png',
				'fba': 'icons/MAME.png',
				'pce': 'icons/PCE.png',
				'pce-turbografx': 'icons/PCE.png',
				'turbografx': 'icons/PCE.png',
				'pc engine': 'icons/PCE.png',
				'nds': 'icons/NDS.png',
				'nintendo ds': 'icons/NDS.png',
				'ds': 'icons/NDS.png',
				'atari lynx': 'icons/LYNX.png',
				'lynx': 'icons/LYNX.png',
				'wonderswan': 'icons/WS.png',
				'ws': 'icons/WS.png',
				'neo geo pocket': 'icons/NGPC.png',
				'ngp': 'icons/NGPC.png',
				'ngpc': 'icons/NGPC.png',
				'psp': 'icons/PSP.png',
				'vita': 'icons/VITA.png',
				'game gear': 'icons/MD_GEN.png',
				'gg': 'icons/MD_GEN.png',
				'pico-8': 'icons/MAME.png',
				'pico8': 'icons/MAME.png',
				'pokemon mini': 'icons/GB.png',
				'default': 'icons/MAME.png'
			};

			// List of known gaming consoles (only these show in Consoles section)
			const knownConsoles = [
				'game boy', 'gb', 'game boy color', 'gbc', 'game boy advance', 'gba',
				'nes', 'snes', 'super nintendo', 'n64', 'nintendo 64', 'gamecube', 'gc',
				'sega master system', 'master system', 'sms', 'sega genesis', 'genesis', 'mega drive', 'md',
				'saturn', 'sega saturn', 'dreamcast', 'dc', 'game gear', 'gg',
				'playstation', 'ps1', 'psx', 'ps2', 'playstation 2',
				'arcade', 'mame', 'fba', 'neo geo', 'neogeo',
				'pce', 'pce-turbografx', 'turbografx', 'pc engine',
				'nds', 'nintendo ds', 'ds',
				'atari lynx', 'lynx', 'atari 2600', 'atari 7800',
				'wonderswan', 'ws',
				'neo geo pocket', 'ngp', 'ngpc',
				'psp', 'vita', 'ps vita',
				'pico-8', 'pico8',
				'pokemon mini', 'pokemini',
				'colecovision', 'intellivision', 'vectrex'
			];

			function isConsole(name) {
				const lower = name.toLowerCase();
				return knownConsoles.some(c => lower === c || lower.includes(c) || c.includes(lower));
			}

			function getConsoleIcon(consoleName) {
				const lowerName = consoleName.toLowerCase();
				if (consoleIcons[lowerName]) return consoleIcons[lowerName];
				for (const [key, iconPath] of Object.entries(consoleIcons)) {
					if (key !== 'default' && (lowerName.includes(key) || key.includes(lowerName))) {
						return iconPath;
					}
				}
				return consoleIcons['default'];
			}

			// Name cleanup patterns
			const cleanupPatterns = [
				/\s*\(USA\)/gi, /\s*\(Europe\)/gi, /\s*\(Japan\)/gi, /\s*\(World\)/gi,
				/\s*\(USA,\s*Europe\)/gi, /\s*\(En,?[A-Za-z,\s]*\)/gi,
				/\s*\(Rev\s*\d*\)/gi, /\s*\(SGB Enhanced\)/gi, /\s*\(GB Compatible\)/gi,
				/\s*\[!\]/gi, /\s*\[C\]/gi, /\s*\(V?\d+\.\d+\)/gi,
				/\s*\(Hack[^)]*\)/gi, /\s*\(Beta[^)]*\)/gi, /\s*\(Proto[^)]*\)/gi,
				/\s*\(Unl\)/gi, /\s*\(PD\)/gi, /\s*\(M\d+\)/gi, /\s+/g,
			];

			function cleanGameName(filename) {
				let name = filename;
				const lastDot = name.lastIndexOf('.');
				const ext = lastDot > 0 ? name.substring(lastDot) : '';
				name = lastDot > 0 ? name.substring(0, lastDot) : name;
				for (const pattern of cleanupPatterns) {
					name = name.replace(pattern, pattern.source === '\\s+' ? ' ' : '');
				}
				return name.trim() + ext;
			}

			async function scanDrive() {
				try {
					directoryHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
					// Save handle for future sessions
					await saveHandle(directoryHandle);
					await scanExistingDirectory();
				} catch (e) { console.error('Error:', e); }
			}

			function renderConsoleList() {
				const list = document.getElementById('consoleList');
				const allFolders = Object.keys(consoles).sort();
				const consoleFolders = allFolders.filter(n => isConsole(n));

				let html = '<li><a href="javascript:void(0)" onclick="showHome()"><span class="icon solid fa-home"></span> Home</a></li>';

				// Console entries only
				for (const name of consoleFolders) {
					const count = consoles[name].games.length;
					const missing = consoles[name].games.filter(g => !g.hasImage).length;
					const icon = getConsoleIcon(name);
					html += `<li><a href="javascript:void(0)" onclick="selectConsole('${name.replace(/'/g, "\\'")}')">
						<img src="${icon}" class="console-icon" alt="${name}">
						<span>${name}</span>
						<span class="game-count">${count}${missing > 0 ? ' <span class="warning">!' + missing + '</span>' : ''}</span>
					</a></li>`;
				}

				list.innerHTML = html;

				const uploadSelect = document.getElementById('uploadConsoleSelect');
				uploadSelect.innerHTML = '<option value="">Select a console...</option>' +
					allFolders.map(n => `<option value="${n}">${n}</option>`).join('');
			}

			function updateStats() {
				let games = 0, missing = 0, consoleCount = 0;
				for (const [name, c] of Object.entries(consoles)) {
					if (isConsole(name)) {
						consoleCount++;
						games += c.games.length;
						missing += c.games.filter(g => !g.hasImage).length;
					}
				}
				document.getElementById('statConsoles').textContent = consoleCount;
				document.getElementById('statGames').textContent = games;
				document.getElementById('statMissing').textContent = missing;
				document.getElementById('statsRow').style.display = 'flex';
			}

			async function selectConsole(name) {
				currentConsole = name;
				document.getElementById('currentConsoleName').textContent = name;
				document.getElementById('floatingUpload').classList.add('visible');
				// Hide intro, show games
				document.getElementById('intro').style.display = 'none';
				document.getElementById('games').style.display = 'block';
				// Update game count badge
				updateGameCountBadge();
				await renderGames();
				window.scrollTo(0, 0);
			}

			function updateGameCountBadge() {
				if (!currentConsole || !consoles[currentConsole]) {
					document.getElementById('gameCountBadge').style.display = 'none';
					return;
				}
				const games = consoles[currentConsole].games;
				const total = games.length;
				const missing = games.filter(g => !g.hasImage).length;

				document.getElementById('totalGameCount').textContent = total;
				document.getElementById('gameCountBadge').style.display = 'inline';

				if (missing > 0) {
					document.getElementById('missingCount').textContent = missing;
					document.getElementById('missingArtCount').style.display = 'inline';
				} else {
					document.getElementById('missingArtCount').style.display = 'none';
				}
			}

			function showHome() {
				currentConsole = null;
				document.getElementById('floatingUpload').classList.remove('visible');
				// Show intro, hide games
				document.getElementById('intro').style.display = '';
				document.getElementById('games').style.display = 'none';
				document.getElementById('currentConsoleName').textContent = 'Select a console to view games';
				document.getElementById('gamesGrid').innerHTML = '<p>Scan your drive to view games</p>';
				window.scrollTo(0, 0);
			}

			async function renderGames() {
				if (!currentConsole || !consoles[currentConsole]) return;
				const grid = document.getElementById('gamesGrid');
				let games = [...consoles[currentConsole].games];
				const search = document.getElementById('searchBox').value.toLowerCase();

				// Apply search filter
				let filtered = games.filter(g => g.baseName.toLowerCase().includes(search));

				// Apply missing art filter
				if (filterMissingOnly) {
					filtered = filtered.filter(g => !g.hasImage);
				}

				// Apply sorting
				currentSort = document.getElementById('sortSelect').value;
				switch (currentSort) {
					case 'az':
						filtered.sort((a, b) => a.baseName.localeCompare(b.baseName));
						break;
					case 'za':
						filtered.sort((a, b) => b.baseName.localeCompare(a.baseName));
						break;
					case 'missing':
						filtered.sort((a, b) => {
							if (a.hasImage === b.hasImage) return a.baseName.localeCompare(b.baseName);
							return a.hasImage ? 1 : -1;
						});
						break;
					case 'hasart':
						filtered.sort((a, b) => {
							if (a.hasImage === b.hasImage) return a.baseName.localeCompare(b.baseName);
							return a.hasImage ? -1 : 1;
						});
						break;
				}

				if (!filtered.length) {
					grid.innerHTML = filterMissingOnly
						? '<p>All games have box art! Nice work!</p>'
						: '<p>No games found</p>';
					return;
				}

				const handle = consoles[currentConsole].handle;
				const cards = await Promise.all(filtered.map(async game => {
					let imgSrc = '';
					if (game.hasImage) {
						try {
							const f = await handle.getFileHandle(game.baseName + '.png');
							imgSrc = URL.createObjectURL(await f.getFile());
						} catch {}
					}
					return `<div class="game-card" onclick="openGameModal('${game.name.replace(/'/g, "\\'")}')" oncontextmenu="showContextMenu(event, '${game.name.replace(/'/g, "\\'")}')">
						<div class="image-container">
							${imgSrc ? `<img src="${imgSrc}">` : '<span class="no-image">?</span>'}
							${!game.hasImage ? '<span class="missing-badge">No Image</span>' : ''}
						</div>
						<div class="game-name" title="${game.baseName}">${game.baseName}</div>
					</div>`;
				}));
				grid.innerHTML = cards.join('');
			}

			function filterGames() { renderGames(); }

			function toggleMissingFilter() {
				filterMissingOnly = !filterMissingOnly;
				const btn = document.getElementById('filterMissingBtn');
				if (filterMissingOnly) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
				renderGames();
			}

			function sortGames() {
				renderGames();
			}

			function openGameModal(gameName) {
				currentGame = gameName;
				const baseName = gameName.substring(0, gameName.lastIndexOf('.'));
				document.getElementById('modalGameName').textContent = baseName;
				document.getElementById('imageUrl').value = '';
				document.getElementById('imageStatus').className = 'status-msg';
				document.getElementById('imageStatus').style.display = 'none';
				loadGameImage(baseName);
				updateNextGameButton();
				document.getElementById('gameModal').classList.add('active');
			}

			async function loadGameImage(baseName) {
				const preview = document.getElementById('modalImagePreview');
				if (!currentConsole || !consoles[currentConsole]) {
					preview.innerHTML = '<span class="no-image">?</span>'; return;
				}
				try {
					const f = await consoles[currentConsole].handle.getFileHandle(baseName + '.png');
					preview.innerHTML = `<img src="${URL.createObjectURL(await f.getFile())}">`;
				} catch { preview.innerHTML = '<span class="no-image">?</span>'; }
			}

			let selectedPickerUrl = null;

			function openImagePicker() {
				const baseName = currentGame ? currentGame.substring(0, currentGame.lastIndexOf('.')) : '';
				document.getElementById('pickerSearchQuery').value = baseName;
				document.getElementById('pickerGrid').innerHTML = '<div class="no-results">Enter a game name and click Search</div>';
				document.getElementById('pickerSelectBtn').disabled = true;
				selectedPickerUrl = null;
				document.getElementById('imagePicker').classList.add('active');
				// Auto-search if we have a name
				if (baseName) searchImagesInPicker();
			}

			function closeImagePicker() {
				document.getElementById('imagePicker').classList.remove('active');
			}

			async function searchImagesInPicker() {
				const q = document.getElementById('pickerSearchQuery').value.trim();
				if (!q) return;

				const grid = document.getElementById('pickerGrid');
				grid.innerHTML = '<div class="loading">Searching TheGamesDB...</div>';
				document.getElementById('pickerSelectBtn').disabled = true;
				selectedPickerUrl = null;

				try {
					const images = [];

					// Search TheGamesDB
					const searchUrl = `https://thegamesdb.net/search.php?name=${encodeURIComponent(q)}`;
					const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(searchUrl)}`);

					if (response.ok) {
						const html = await response.text();
						const parser = new DOMParser();
						const doc = parser.parseFromString(html, 'text/html');

						// Find all game images in search results
						const gameImgs = doc.querySelectorAll('img[src*="cdn.thegamesdb.net"]');
						gameImgs.forEach(img => {
							const thumbUrl = img.getAttribute('src');
							if (thumbUrl && thumbUrl.includes('/boxart/')) {
								// Convert thumbnail to original size
								const fullUrl = thumbUrl.replace('/thumb/', '/original/');
								images.push({ thumb: thumbUrl, full: fullUrl });
							}
						});

						// Also check for game detail links to get more images
						const gameLinks = doc.querySelectorAll('a[href*="game.php?id="]');
						const uniqueIds = [...new Set(Array.from(gameLinks).map(a => {
							const match = a.getAttribute('href').match(/id=(\d+)/);
							return match ? match[1] : null;
						}).filter(Boolean))];

						// Fetch additional images from first few game pages
						for (const gameId of uniqueIds.slice(0, 5)) {
							try {
								const gameUrl = `https://thegamesdb.net/game.php?id=${gameId}`;
								const gameResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(gameUrl)}`);
								if (gameResponse.ok) {
									const gameHtml = await gameResponse.text();
									const gameDoc = parser.parseFromString(gameHtml, 'text/html');

									// Get all boxart images from the game page
									const boxartImgs = gameDoc.querySelectorAll('img[src*="cdn.thegamesdb.net"]');
									boxartImgs.forEach(img => {
										const src = img.getAttribute('src');
										if (src && (src.includes('/boxart/') || src.includes('/screenshot'))) {
											const fullUrl = src.replace('/thumb/', '/original/');
											if (!images.find(i => i.full === fullUrl)) {
												images.push({ thumb: src, full: fullUrl });
											}
										}
									});
								}
							} catch (e) { console.log('Error fetching game:', e); }

							if (images.length >= 24) break;
						}
					}

					if (images.length === 0) {
						grid.innerHTML = '<div class="no-results">No images found. Try Google Images instead.</div>';
						return;
					}

					// Remove duplicates
					const uniqueImages = images.filter((img, idx, arr) =>
						arr.findIndex(i => i.full === img.full) === idx
					);

					grid.innerHTML = uniqueImages.slice(0, 24).map(img =>
						`<img src="${img.thumb}" data-url="${img.full}" onclick="selectPickerImage(this)" title="Click to select" onerror="this.style.display='none'">`
					).join('');
				} catch (e) {
					console.error('Search error:', e);
					grid.innerHTML = '<div class="no-results">Search unavailable. Try Google Images instead.</div>';
				}
			}

			function selectPickerImage(img) {
				document.querySelectorAll('#pickerGrid img').forEach(i => i.classList.remove('selected'));
				img.classList.add('selected');
				selectedPickerUrl = img.dataset.url;
				document.getElementById('pickerSelectBtn').disabled = false;
			}

			async function confirmImageSelection() {
				if (!selectedPickerUrl) return;
				closeImagePicker();
				document.getElementById('imageUrl').value = selectedPickerUrl;
				// Auto-download the selected image
				await downloadAndResizeImage();
			}

			function openGoogleImages() {
				const q = document.getElementById('pickerSearchQuery').value || document.getElementById('modalGameName').textContent;
				window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(q + ' box art cover')}`, '_blank');
			}

			function confirmDeleteGame() {
				const gameName = document.getElementById('modalGameName').textContent;
				document.getElementById('deleteConfirmText').textContent = `Are you sure you want to delete "${gameName}"? This will remove the ROM file and its box art image.`;
				document.getElementById('deleteModal').classList.add('active');
			}

			async function executeDeleteGame() {
				try {
					const gameFileName = currentGame; // e.g. "Donkey Kong Country.sfc"
					const baseName = gameFileName.substring(0, gameFileName.lastIndexOf('.'));
					const consoleName = currentConsole;
					const consoleHandle = consoles[consoleName].handle;

					// Delete the ROM file
					await consoleHandle.removeEntry(gameFileName);

					// Delete the image file if it exists (try both png and jpg)
					try {
						await consoleHandle.removeEntry(baseName + '.png');
					} catch (e) {}
					try {
						await consoleHandle.removeEntry(baseName + '.jpg');
					} catch (e) {}

					// Reset file inputs to prevent them from triggering
					document.getElementById('fileInput').value = '';
					document.getElementById('localImageInput').value = '';

					// Close all modals first
					closeModal('deleteModal');
					closeModal('gameModal');
					currentGame = null;

					// Remove focus from any element
					document.activeElement.blur();

					// Rescan and refresh view after short delay
					setTimeout(async () => {
						await scanExistingDirectory();
						// Check if console still exists after rescan
						if (consoles[consoleName]) {
							currentConsole = consoleName;
							await renderGames();
						} else {
							// Console folder is empty/deleted, go home
							showHome();
						}
					}, 100);

				} catch (e) {
					alert('Error deleting game: ' + e.message);
				}
			}

			// Context menu functions
			function showContextMenu(event, gameName) {
				event.preventDefault();
				event.stopPropagation();
				contextMenuTarget = gameName;

				const menu = document.getElementById('contextMenu');
				menu.style.left = event.pageX + 'px';
				menu.style.top = event.pageY + 'px';
				menu.classList.add('active');
			}

			function hideContextMenu() {
				document.getElementById('contextMenu').classList.remove('active');
				contextMenuTarget = null;
			}

			function contextMenuAction(action) {
				if (!contextMenuTarget) return;
				const gameName = contextMenuTarget;
				hideContextMenu();

				switch (action) {
					case 'edit':
						openGameModal(gameName);
						break;
					case 'search':
						openGameModal(gameName);
						setTimeout(() => openImagePicker(), 100);
						break;
					case 'google':
						const baseName = gameName.substring(0, gameName.lastIndexOf('.'));
						window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(baseName + ' box art cover')}`, '_blank');
						break;
					case 'rename':
						openRenameModal(gameName);
						break;
					case 'delete':
						openGameModal(gameName);
						setTimeout(() => confirmDeleteGame(), 100);
						break;
				}
			}

			let renameTarget = null;

			function openRenameModal(gameName) {
				renameTarget = gameName;
				const baseName = gameName.substring(0, gameName.lastIndexOf('.'));
				document.getElementById('renameInput').value = baseName;
				document.getElementById('renameStatus').className = 'status-msg';
				document.getElementById('renameStatus').style.display = 'none';
				document.getElementById('renameModal').classList.add('active');
				// Focus and select the input
				setTimeout(() => {
					const input = document.getElementById('renameInput');
					input.focus();
					input.select();
				}, 100);
			}

			async function executeRename() {
				if (!renameTarget || !currentConsole) return;

				const newName = document.getElementById('renameInput').value.trim();
				const status = document.getElementById('renameStatus');

				if (!newName) {
					status.className = 'status-msg error';
					status.textContent = 'Please enter a name';
					status.style.display = 'block';
					return;
				}

				const oldFileName = renameTarget;
				const oldBaseName = oldFileName.substring(0, oldFileName.lastIndexOf('.'));
				const ext = oldFileName.substring(oldFileName.lastIndexOf('.'));
				const newFileName = newName + ext;

				// Check if name changed
				if (oldBaseName === newName) {
					closeModal('renameModal');
					return;
				}

				status.textContent = 'Renaming...';
				status.style.display = 'block';
				status.className = 'status-msg';

				try {
					const consoleHandle = consoles[currentConsole].handle;

					// Read the old ROM file
					const oldRomHandle = await consoleHandle.getFileHandle(oldFileName);
					const oldRomFile = await oldRomHandle.getFile();
					const romData = await oldRomFile.arrayBuffer();

					// Create new ROM file with new name
					const newRomHandle = await consoleHandle.getFileHandle(newFileName, { create: true });
					const romWriter = await newRomHandle.createWritable();
					await romWriter.write(romData);
					await romWriter.close();

					// Delete old ROM file
					await consoleHandle.removeEntry(oldFileName);

					// Try to rename art file if it exists
					try {
						const oldArtHandle = await consoleHandle.getFileHandle(oldBaseName + '.png');
						const oldArtFile = await oldArtHandle.getFile();
						const artData = await oldArtFile.arrayBuffer();

						// Create new art file
						const newArtHandle = await consoleHandle.getFileHandle(newName + '.png', { create: true });
						const artWriter = await newArtHandle.createWritable();
						await artWriter.write(artData);
						await artWriter.close();

						// Delete old art file
						await consoleHandle.removeEntry(oldBaseName + '.png');
					} catch (e) {
						// Art file doesn't exist, that's okay
					}

					status.className = 'status-msg success';
					status.textContent = 'Renamed successfully!';

					// Refresh after short delay
					setTimeout(async () => {
						closeModal('renameModal');
						renameTarget = null;
						await scanExistingDirectory();
						if (consoles[currentConsole]) {
							await renderGames();
							updateGameCountBadge();
						}
					}, 500);

				} catch (e) {
					status.className = 'status-msg error';
					status.textContent = 'Error: ' + e.message;
				}
			}

			// Close context menu when clicking elsewhere
			document.addEventListener('click', (e) => {
				if (!e.target.closest('.context-menu')) {
					hideContextMenu();
				}
			});

			// Next Missing Art function
			function goToNextMissingArt() {
				if (!currentConsole || !consoles[currentConsole]) return;

				const games = consoles[currentConsole].games;
				const currentIndex = games.findIndex(g => g.name === currentGame);

				// Find next game without art, starting after current game
				for (let i = 1; i <= games.length; i++) {
					const idx = (currentIndex + i) % games.length;
					if (!games[idx].hasImage) {
						closeModal('gameModal');
						setTimeout(() => openGameModal(games[idx].name), 100);
						return;
					}
				}

				// No more games without art
				alert('No more games without box art in this console!');
			}

			function updateNextGameButton() {
				if (!currentConsole || !consoles[currentConsole]) return;
				const games = consoles[currentConsole].games;
				const hasMoreMissing = games.some(g => g.name !== currentGame && !g.hasImage);
				document.getElementById('nextGameBtn').disabled = !hasMoreMissing;
			}

			function selectSearchResult(img) {
				// Remove selected class from others
				document.querySelectorAll('#imageResults img').forEach(i => i.classList.remove('selected'));
				img.classList.add('selected');
				// Set the URL in the input field
				document.getElementById('imageUrl').value = img.dataset.url;
			}

			async function downloadAndResizeImage() {
				const url = document.getElementById('imageUrl').value.trim();
				const status = document.getElementById('imageStatus');
				if (!url) { status.className = 'status-msg error'; status.textContent = 'Enter a URL'; return; }
				status.textContent = 'Downloading...'; status.style.display = 'block'; status.className = 'status-msg';
				try {
					let r;
					try { r = await fetch(url); } catch { r = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`); }
					if (!r.ok) throw new Error('Failed');
					await processAndSaveImage(await r.blob());
				} catch { status.className = 'status-msg error'; status.textContent = 'Error. Try Local instead.'; }
			}

			function selectLocalImage() { document.getElementById('localImageInput').click(); }
			async function handleLocalImage(e) { if (e.target.files[0]) await processAndSaveImage(e.target.files[0]); }

			async function processAndSaveImage(blob) {
				const status = document.getElementById('imageStatus');
				try {
					const img = await createImageBitmap(blob);
					const maxSize = 240;

					// Calculate scale factor to fit within maxSize while preserving aspect ratio
					const scale = Math.min(maxSize / img.width, maxSize / img.height);
					const newWidth = Math.round(img.width * scale);
					const newHeight = Math.round(img.height * scale);

					const canvas = document.createElement('canvas');
					canvas.width = newWidth;
					canvas.height = newHeight;

					// Use high quality image scaling
					const ctx = canvas.getContext('2d');
					ctx.imageSmoothingEnabled = true;
					ctx.imageSmoothingQuality = 'high';
					ctx.drawImage(img, 0, 0, newWidth, newHeight);

					const resized = await new Promise(r => canvas.toBlob(r, 'image/png'));

					const baseName = currentGame.substring(0, currentGame.lastIndexOf('.'));
					const fh = await consoles[currentConsole].handle.getFileHandle(baseName + '.png', { create: true });
					const w = await fh.createWritable();
					await w.write(resized);
					await w.close();

					document.getElementById('modalImagePreview').innerHTML = `<img src="${URL.createObjectURL(resized)}">`;
					const game = consoles[currentConsole].games.find(g => g.name === currentGame);
					if (game) game.hasImage = true;

					status.className = 'status-msg success';
					status.textContent = `Saved! (${newWidth}x${newHeight})`;
					renderConsoleList(); renderGames(); updateStats(); updateGameCountBadge();
					updateNextGameButton();

					// Auto-close modal after short delay
					setTimeout(() => closeModal('gameModal'), 800);
				} catch (e) { status.className = 'status-msg error'; status.textContent = 'Error: ' + e.message; }
			}

			function closeModal(id) { document.getElementById(id).classList.remove('active'); }

			function openUploadModal() {
				if (!directoryHandle) { alert('Scan a drive first'); return; }
				filesToUpload = [];
				document.getElementById('fileList').innerHTML = '';
				document.getElementById('uploadStatus').className = 'status-msg';
				// Pre-select current console if one is selected
				if (currentConsole) {
					document.getElementById('uploadConsoleSelect').value = currentConsole;
				}
				document.getElementById('uploadModal').classList.add('active');
			}

			document.addEventListener('DOMContentLoaded', () => {
				const dz = document.getElementById('dropZone');
				dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
				dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
				dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
				document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); }));
			});

			function handleFileSelect(e) { handleFiles(e.target.files); }
			function handleFiles(files) {
				const list = document.getElementById('fileList');
				for (const file of files) {
					const clean = cleanGameName(file.name);
					filesToUpload.push({ file, originalName: file.name, cleanName: clean });
					list.innerHTML += `<div class="file-item"><span class="original">${file.name}</span><span class="clean"> ${clean}</span></div>`;
				}
			}

			async function uploadFiles() {
				const consoleName = document.getElementById('uploadConsoleSelect').value;
				const status = document.getElementById('uploadStatus');
				if (!consoleName) { status.className = 'status-msg error'; status.textContent = 'Select a console'; return; }
				if (!filesToUpload.length) { status.className = 'status-msg error'; status.textContent = 'No files'; return; }

				status.textContent = 'Uploading...'; status.style.display = 'block';
				try {
					let ch;
					try { ch = await directoryHandle.getDirectoryHandle(consoleName); }
					catch { ch = await directoryHandle.getDirectoryHandle(consoleName, { create: true }); }

					for (const item of filesToUpload) {
						const fh = await ch.getFileHandle(item.cleanName, { create: true });
						const w = await fh.createWritable();
						await w.write(item.file);
						await w.close();
					}

					status.className = 'status-msg success';
					status.textContent = `Uploaded ${filesToUpload.length} file(s)!`;
					const uploadedToConsole = consoleName;
					filesToUpload = [];
					document.getElementById('fileList').innerHTML = '';

					// Reset file input to prevent it from triggering again
					document.getElementById('fileInput').value = '';

					// Close modal and refresh after brief delay to show success message
					setTimeout(async () => {
						closeModal('uploadModal');
						document.activeElement.blur();
						await scanExistingDirectory();
						// Refresh the view for the console we uploaded to
						if (consoles[uploadedToConsole]) {
							currentConsole = uploadedToConsole;
							document.getElementById('currentConsoleName').textContent = uploadedToConsole;
							document.getElementById('intro').style.display = 'none';
							document.getElementById('games').style.display = 'block';
							await renderGames();
						}
					}, 1000);
				} catch (e) { status.className = 'status-msg error'; status.textContent = 'Error: ' + e.message; }
			}
		</script>

	</body>
</html>
