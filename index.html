<!DOCTYPE HTML>
<!--
	NanoArcade
	Based on Hyperspace by HTML5 UP (html5up.net | @ajlkn)
-->
<html>
	<head>
		<title>NanoArcade</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta name="description" content="Box art manager for retro gaming handhelds - RG Nano, Miyoo Mini, Trimui Brick and more">
		<meta name="theme-color" content="#6c5ce7">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="apple-mobile-web-app-title" content="NanoArcade">
		<link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon.png">
		<link rel="apple-touch-icon" href="assets/images/icon-192.png">
		<link rel="manifest" href="manifest.json">
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Cookie&family=Press+Start+2P&display=swap" rel="stylesheet">
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
			/* Custom styles for NanoArcade */
			#sidebar nav ul li {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			#sidebar nav ul li a {
				color: #fff !important;
				font-family: 'Press Start 2P', cursive;
				font-size: 0.4em;
				line-height: 1.4;
				text-shadow: 0 0 8px rgba(96, 165, 250, 0.6), 0 0 15px rgba(59, 130, 246, 0.4);
				border: none !important;
				background: none !important;
				outline: none !important;
				box-shadow: none !important;
				display: flex;
				align-items: center;
				white-space: nowrap;
			}

			#sidebar nav ul li a::before,
			#sidebar nav ul li a::after {
				display: none !important;
			}

			#sidebar nav ul li img.console-icon {
				width: 36px;
				height: 36px;
				object-fit: contain;
				vertical-align: middle;
				margin-right: 12px;
				flex-shrink: 0;
			}

			#sidebar nav ul li .game-count {
				margin-left: 8px;
				background: rgba(255,255,255,0.1);
				padding: 2px 6px;
				border-radius: 10px;
				font-size: 1em;
				flex-shrink: 0;
			}

			#sidebar nav ul li .warning {
				color: #60a5fa;
				flex-shrink: 0;
			}

			#sidebar nav ul li a .icon.fa-home {
				margin-right: 10px;
				font-size: 1.5em;
			}

			.games-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
				gap: 1.5em;
				padding: 1em 0;
				align-items: start;
			}

			/* Loading spinner */
			.loading-container {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				padding: 4em 2em;
				grid-column: 1 / -1;
			}
			.spinner {
				width: 50px;
				height: 50px;
				border: 4px solid rgba(255, 255, 255, 0.1);
				border-top-color: #3b82f6;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}
			@keyframes spin {
				to { transform: rotate(360deg); }
			}
			.loading-text {
				margin-top: 1em;
				color: rgba(255, 255, 255, 0.6);
				font-size: 1.1em;
			}

			.game-card {
				background: rgba(255,255,255,0.05);
				border-radius: 10px;
				transition: transform 0.3s, box-shadow 0.3s;
				cursor: pointer;
				display: flex;
				flex-direction: column;
			}

			.game-card:hover {
				transform: translateY(-5px);
				box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
			}

			.game-card .image-container {
				width: 100%;
				background: rgba(0,0,0,0.3);
				position: relative;
				border-radius: 10px 10px 0 0;
				overflow: hidden;
			}

			.game-card .image-container img {
				width: 100%;
				height: auto;
				display: block;
			}

			.game-card .no-image {
				color: rgba(255,255,255,0.3);
				font-size: 3em;
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 180px;
			}

			.game-card .game-name {
				padding: 10px;
				font-size: 0.8em;
				text-align: center;
				white-space: normal;
				word-wrap: break-word;
				overflow-wrap: break-word;
				line-height: 1.3;
				color: #fff;
			}

			.game-card .game-console-label {
				font-size: 0.65em;
				color: rgba(255,255,255,0.5);
				text-align: center;
				padding: 0 10px 8px;
				margin-top: -5px;
			}

			.game-card .missing-badge {
				position: absolute;
				top: 5px;
				right: 5px;
				background: #3b82f6;
				color: #fff;
				padding: 3px 8px;
				border-radius: 3px;
				font-size: 0.7em;
			}

			/* Top 25 list styles */
			.top25-item {
				display: flex;
				align-items: center;
				padding: 0.6em 0.75em;
				margin-bottom: 0.4em;
				border-radius: 8px;
				background: rgba(255,255,255,0.03);
				transition: background 0.2s;
			}
			.top25-item:hover {
				background: rgba(255,255,255,0.08);
			}
			.top25-item.owned {
				border-left: 3px solid #22c55e;
			}
			.top25-item.missing {
				border-left: 3px solid #ef4444;
				opacity: 0.8;
			}
			.top25-rank {
				min-width: 36px;
				font-weight: bold;
				color: #f59e0b;
				font-size: 0.85em;
				flex-shrink: 0;
			}
			.top25-icon {
				min-width: 24px;
				text-align: center;
				margin-right: 0.5em;
				flex-shrink: 0;
			}
			.top25-icon.owned { color: #22c55e; }
			.top25-icon.missing { color: #ef4444; }
			.top25-name {
				flex: 1;
				font-size: 0.85em;
			}
			.top25-upload-zone.dragover {
				border-color: #f59e0b;
				background: rgba(245, 158, 11, 0.1);
			}

			/* Top 25 scrollbar */
			#top25List::-webkit-scrollbar {
				width: 8px;
			}
			#top25List::-webkit-scrollbar-track {
				background: rgba(0,0,0,0.2);
				border-radius: 4px;
			}
			#top25List::-webkit-scrollbar-thumb {
				background: rgba(245, 158, 11, 0.5);
				border-radius: 4px;
			}
			#top25List::-webkit-scrollbar-thumb:hover {
				background: rgba(245, 158, 11, 0.7);
			}

			.stats-row {
				display: flex;
				gap: 2em;
				margin-bottom: 2em;
				flex-wrap: wrap;
			}

			.stat-box {
				background: rgba(255,255,255,0.05);
				padding: 1em 2em;
				border-radius: 10px;
				text-align: center;
			}

			.stat-box .value {
				font-size: 2em;
				color: #60a5fa;
				font-weight: bold;
			}

			.stat-box .label {
				font-size: 0.9em;
				color: rgba(255,255,255,0.55);
			}

			.controls-bar {
				display: flex;
				gap: 1em;
				align-items: center;
				flex-wrap: wrap;
				margin-bottom: 2em;
			}

			/* ========== UIverse 3D Skew Button (btongheng) ========== */
			.btn-3d,
			.btn-3d:focus,
			.btn-3d:hover,
			.btn-3d:active {
				--btn-color: #3b82f6;
				--btn-shadow: #1d4ed8;
				--btn-glow: #3b82f663;
				cursor: pointer;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				gap: 0.5rem;
				padding: 12px 24px;
				font-size: 0.85em;
				font-weight: 700;
				letter-spacing: 1.5px;
				text-transform: uppercase;
				color: #fff;
				background: var(--btn-color);
				border: 2px solid var(--btn-shadow) !important;
				border-radius: 0.75rem;
				box-shadow: 0 6px 0 var(--btn-shadow);
				transform: skew(-10deg);
				transition: all 0.1s ease;
				filter: drop-shadow(0 12px 16px var(--btn-glow));
				outline: none !important;
			}
			.btn-3d:hover {
				transform: skew(-10deg) translateY(-2px);
				box-shadow: 0 8px 0 var(--btn-shadow);
			}
			.btn-3d:active {
				letter-spacing: 0.5px;
				transform: skew(-10deg) translateY(6px);
				box-shadow: 0 0 0 var(--btn-glow);
			}
			.btn-3d .icon {
				transform: skew(10deg);
			}
			.btn-3d::after {
				display: none !important;
			}
			/* Color variants */
			.btn-3d.green {
				--btn-color: #22c55e;
				--btn-shadow: #15803d;
				--btn-glow: #22c55e63;
			}
			.btn-3d.red {
				--btn-color: #ef4444;
				--btn-shadow: #b91c1c;
				--btn-glow: #ef444463;
			}
			.btn-3d.purple {
				--btn-color: #8b5cf6;
				--btn-shadow: #6d28d9;
				--btn-glow: #8b5cf663;
			}
			.btn-3d.cyan {
				--btn-color: #06b6d4;
				--btn-shadow: #0891b2;
				--btn-glow: #06b6d463;
			}
			.btn-3d.gray {
				--btn-color: #64748b;
				--btn-shadow: #475569;
				--btn-glow: #64748b63;
			}
			.btn-3d.small {
				padding: 8px 16px;
				font-size: 0.7em;
				box-shadow: 0 4px 0 var(--btn-shadow);
			}
			.btn-3d.small:hover {
				transform: skew(-10deg) translateY(-2px);
				box-shadow: 0 6px 0 var(--btn-shadow);
			}
			.btn-3d.small:active {
				transform: skew(-10deg) translateY(4px);
			}
			.btn-3d:disabled {
				--btn-color: #475569;
				--btn-shadow: #334155;
				--btn-glow: #47556963;
				cursor: not-allowed;
				opacity: 0.7;
			}
			.btn-3d.active {
				--btn-color: #3b82f6;
				--btn-shadow: #1d4ed8;
				--btn-glow: #3b82f663;
			}
			.btn-3d.gold {
				--btn-color: #f59e0b;
				--btn-shadow: #d97706;
				--btn-glow: #f59e0b63;
			}

			/* URL input styling */
			.url-input {
				flex: 1;
				padding: 0.5em 0.75em;
				font-size: 0.85em;
				background: rgba(0,0,0,0.3);
				border: 1px solid rgba(255,255,255,0.2);
				border-radius: 8px;
				color: white;
				outline: none;
			}
			.url-input:focus {
				border-color: #3b82f6;
			}
			.url-input::placeholder {
				color: rgba(255,255,255,0.4);
			}

			.search-input {
				flex: 1;
				min-width: 200px;
			}

			/* GameFAQs tooltip styles */
			.gf-tooltip {
				display: none;
				position: absolute;
				bottom: 100%;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(0,0,0,0.95);
				border: 1px solid rgba(59, 130, 246, 0.4);
				border-radius: 8px;
				padding: 0.6em 0.8em;
				font-size: 0.85em;
				white-space: nowrap;
				z-index: 100;
				margin-bottom: 0.5em;
				box-shadow: 0 4px 12px rgba(0,0,0,0.5);
			}
			.gf-tooltip::after {
				content: '';
				position: absolute;
				top: 100%;
				left: 50%;
				transform: translateX(-50%);
				border: 6px solid transparent;
				border-top-color: rgba(59, 130, 246, 0.4);
			}
			#gfRatingWrap:hover .gf-tooltip,
			#gfDifficultyWrap:hover .gf-tooltip,
			#gfLengthWrap:hover .gf-tooltip,
			#gameTitleWrap:hover .gf-tooltip {
				display: block;
			}
			#gameTitleTooltip::after {
				top: -12px;
				border-top-color: transparent;
				border-bottom-color: rgba(59, 130, 246, 0.4);
			}
			.gf-tooltip-row {
				display: flex;
				justify-content: space-between;
				gap: 1em;
				padding: 0.15em 0;
				color: rgba(255,255,255,0.8);
			}
			.gf-tooltip-row span:first-child {
				color: rgba(255,255,255,0.5);
			}

			/* Modal styles */
			.modal-overlay {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.85);
				z-index: 10000;
				align-items: center;
				justify-content: center;
			}

			.modal-overlay.active {
				display: flex;
			}

			.modal-box {
				background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
				padding: 1.5em;
				border-radius: 20px;
				max-width: 600px;
				width: 90%;
				border: 2px solid #3b82f6;
				box-shadow: 0 0 30px rgba(59, 130, 246, 0.3), 0 0 60px rgba(59, 130, 246, 0.1), inset 0 1px 0 rgba(255,255,255,0.1);
				position: relative;
			}

			/* Responsive modal - scale content to fit screen without scrolling */
			@media (max-height: 950px) {
				#gameModal .modal-box {
					padding: 1.25em;
				}
				#modalImagePreview {
					height: 240px !important;
					margin-bottom: 0.75em !important;
				}
				#gameFaqsInfo {
					padding: 0.5em !important;
					margin-bottom: 0.5em !important;
				}
				#savesButtonRow, #noSavesButtonRow {
					margin-bottom: 0.5em !important;
				}
				#gameModal .modal-box > div:last-of-type {
					padding-top: 0.5em !important;
				}
			}

			@media (max-height: 850px) {
				#gameModal .modal-box {
					padding: 1em;
				}
				#modalImagePreview {
					height: 200px !important;
					margin-bottom: 0.5em !important;
				}
				#gameFaqsInfo {
					padding: 0.4em !important;
					margin-bottom: 0.4em !important;
					font-size: 0.75em !important;
				}
				#savesButtonRow, #noSavesButtonRow {
					margin-bottom: 0.4em !important;
				}
				#savesButtonRow > button:first-child {
					margin-bottom: 0.4em !important;
				}
			}

			@media (max-height: 750px) {
				#gameModal .modal-box {
					padding: 0.75em;
				}
				#modalImagePreview {
					height: 160px !important;
					margin-bottom: 0.4em !important;
				}
				#gameFaqsInfo {
					padding: 0.3em !important;
					margin-bottom: 0.3em !important;
				}
			}

			@media (max-height: 650px) {
				#modalImagePreview {
					height: 120px !important;
				}
			}

			/* Smooth focus outlines */
			select:focus,
			input:focus,
			textarea:focus {
				outline: none;
				border-color: #3b82f6;
				box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
			}

			button,
			button:focus,
			button:active,
			button:hover {
				outline: none !important;
				-webkit-tap-highlight-color: transparent;
			}

			.modal-box .modal-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1em;
			}

			.modal-box h3 {
				color: #60a5fa;
				margin: 0;
				font-size: 1.1em;
			}

			.modal-box .close-btn {
				background: none !important;
				border: none !important;
				color: #fff;
				cursor: pointer;
				font-size: 1.25em;
				padding: 0 !important;
				opacity: 0.7;
				transition: opacity 0.2s;
				box-shadow: none !important;
				width: auto !important;
				height: auto !important;
				line-height: 1 !important;
			}

			.modal-box .close-btn:before,
			.modal-box .close-btn:after {
				display: none !important;
			}

			.modal-box .close-btn:hover {
				opacity: 1;
				background: none !important;
			}
			/* Game modal specific */
			.game-modal-content {
				display: flex;
				gap: 1em;
			}

			.game-modal-left {
				flex-shrink: 0;
			}

			.game-modal-right {
				flex: 1;
				display: flex;
				flex-direction: column;
				gap: 0.5em;
				min-width: 0;
			}

			.image-preview {
				min-width: 160px;
				min-height: 160px;
				max-width: 200px;
				background: rgba(0,0,0,0.3);
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 8px;
				overflow: hidden;
				padding: 8px;
			}

			.image-preview img {
				max-width: 100%;
				max-height: 100%;
				width: auto;
				height: auto;
				object-fit: contain;
				display: block;
				margin: auto;
			}

			#modalImagePreview {
				max-width: 100%;
			}

			#modalImagePreview img {
				max-width: calc(100% - 16px);
				max-height: calc(100% - 16px);
			}

			.compact-field {
				margin-bottom: 0.25em;
			}

			.compact-field label {
				font-size: 0.8em;
				margin-bottom: 0.2em;
				display: block;
				color: rgba(255,255,255,0.7);
			}

			.compact-field input {
				padding: 0.4em 0.6em;
				font-size: 0.85em;
				width: 100%;
				box-sizing: border-box;
			}

			.compact-actions {
				display: flex;
				gap: 0.4em;
				margin-top: 0.25em;
				flex-wrap: wrap;
			}

			.modal-box .google-link {
				color: #60a5fa;
				text-decoration: none;
				font-size: 0.85em;
				margin-left: 0.5em;
			}

			.modal-box .google-link:hover {
				text-decoration: underline;
			}

			/* Image picker modal - fullscreen */
			.image-picker-overlay {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0,0,0,0.9);
				z-index: 10001;
				display: none;
				flex-direction: column;
				padding: 1em;
			}

			.image-picker-overlay.active {
				display: flex;
			}

			.image-picker-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin: -1.5em -1.5em 1em -1.5em;
				padding: 1em 1.5em;
				flex-shrink: 0;
				background: rgba(0, 0, 0, 0.3);
				border-bottom: 1px solid rgba(59, 130, 246, 0.2);
			}

			.image-picker-header h3 {
				color: #60a5fa;
				margin: 0;
			}

			.image-picker-search {
				display: flex;
				gap: 0.5em;
				flex: 1;
				max-width: 500px;
				margin: 0 2em;
				align-items: center;
			}

			.image-picker-search input {
				flex: 1;
				padding: 0.4em 0.8em;
				border-radius: 4px;
				border: 1px solid #475569;
				background: #1e293b;
				color: #fff;
				font-size: 0.85em;
				height: 32px;
				box-sizing: border-box;
			}

			.image-picker-search .styled-btn {
				padding: 0 12px;
				height: 32px;
				font-size: 0.65em;
			}

			.image-picker-close {
				background: none !important;
				border: none !important;
				color: #fff;
				font-size: 2em;
				cursor: pointer;
				opacity: 0.7;
				padding: 0 !important;
				line-height: 1;
				box-shadow: none !important;
				width: auto !important;
				height: auto !important;
			}

			.image-picker-close:hover {
				opacity: 1;
				background: none !important;
			}

			.image-picker-close::before,
			.image-picker-close::after {
				display: none !important;
			}

			.image-picker-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
				gap: 1em;
				overflow-y: auto;
				flex: 1;
				padding: 0.5em;
				align-items: start;
			}

			.image-picker-grid img {
				max-width: 100%;
				width: auto;
				height: auto;
				object-fit: contain;
				border-radius: 8px;
				cursor: pointer;
				border: 3px solid transparent;
				transition: border-color 0.2s, transform 0.2s;
				background: rgba(0,0,0,0.3);
			}

			.image-picker-grid img:hover {
				border-color: #3b82f6;
				transform: scale(1.03);
			}

			.image-picker-grid img.selected {
				border-color: #22c55e;
			}

			.image-picker-grid .loading,
			.image-picker-grid .no-results {
				grid-column: 1 / -1;
				text-align: center;
				color: rgba(255,255,255,0.5);
				padding: 3em;
				font-size: 1.2em;
			}

			.image-picker-footer {
				display: flex;
				justify-content: flex-end;
				align-items: center;
				margin-top: 1em;
				flex-shrink: 0;
				padding-top: 1em;
				border-top: 1px solid #334155;
			}


			.drop-zone {
				border: 3px dashed rgba(37, 99, 235, 0.5);
				border-radius: 10px;
				padding: 2em;
				text-align: center;
				margin-bottom: 1em;
				transition: all 0.3s;
			}

			.drop-zone.dragover {
				border-color: #3b82f6;
				background: rgba(59, 130, 246, 0.1);
			}


			.file-list {
				max-height: 200px;
				overflow-y: auto;
			}

			.file-item {
				display: flex;
				flex-direction: column;
				padding: 0.5em;
				background: rgba(255,255,255,0.05);
				margin-bottom: 5px;
				border-radius: 5px;
			}

			.file-item .original {
				color: rgba(255,255,255,0.4);
				font-size: 0.8em;
			}

			.file-item .clean {
				color: #4ade80;
			}

			.status-msg {
				padding: 0.75em 1em;
				border-radius: 5px;
				margin-top: 1em;
				display: none;
			}

			.status-msg.success {
				background: rgba(74, 222, 128, 0.2);
				color: #4ade80;
				display: block;
			}

			.status-msg.error {
				background: rgba(239, 68, 68, 0.2);
				color: #f87171;
				display: block;
			}

			#sidebar {
				width: 20em;
			}

			/* Hide scrollbar but allow scrolling */
			#sidebar::-webkit-scrollbar {
				display: none;
			}

			#sidebar {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}

			#sidebar nav ul {
				max-height: calc(100vh - 100px);
				overflow-y: auto;
				-ms-overflow-style: none;
				scrollbar-width: none;
			}

			#sidebar nav ul::-webkit-scrollbar {
				display: none;
			}

			/* Ultrawide monitor support - expand games section */
			#games > .inner {
				width: 100%;
				max-width: none;
			}

			@media screen and (max-width: 1280px) {
				#sidebar {
					width: 18em;
				}
			}

			@media screen and (max-width: 736px) {
				.games-grid {
					grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
				}
			}

			/* Floating upload button */
			.floating-upload {
				position: fixed;
				top: 20px;
				right: 20px;
				z-index: 1000;
				display: none;
			}
			.floating-upload.visible {
				display: inline-flex;
			}

			/* Floating install PWA button - small, bottom right, only on intro */
			.floating-install {
				position: fixed;
				bottom: 10px;
				right: 10px;
				z-index: 1000;
				font-size: 0.5em;
				padding: 0.4em 0.6em;
			}

			/* Modern Hero Section */
			.hero-section {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				text-align: center;
				min-height: 100vh;
				padding: 2em;
			}

			.hero-logo {
				width: 700px;
				max-width: 90vw;
				height: auto;
				margin-bottom: 1.5em;
				filter: drop-shadow(0 15px 40px rgba(59, 130, 246, 0.4));
				animation: float 3s ease-in-out infinite;
			}

			@keyframes float {
				0%, 100% { transform: translateY(0); }
				50% { transform: translateY(-12px); }
			}

			.hero-tagline {
				font-size: 0.95em;
				color: rgba(255, 255, 255, 0.6);
				max-width: 400px;
				margin: 0 auto 1.5em auto;
				line-height: 1.5;
			}

			.hero-stats {
				display: flex;
				gap: 3em;
				margin-top: 3em;
				justify-content: center;
				flex-wrap: wrap;
			}

			.hero-stat {
				text-align: center;
			}

			.hero-stat.clickable {
				cursor: pointer;
				padding: 1em 1.5em;
				border-radius: 12px;
				transition: all 0.2s ease;
			}

			.hero-stat.clickable:hover {
				background: rgba(255, 255, 255, 0.1);
				transform: translateY(-2px);
			}

			.hero-stat.clickable:hover .value {
				color: #93c5fd;
				text-shadow: 0 0 20px rgba(96, 165, 250, 0.5);
			}

			.hero-stat .value {
				font-size: 2.5em;
				font-weight: 700;
				color: #60a5fa;
				line-height: 1;
				transition: all 0.2s ease;
			}

			.hero-stat .label {
				font-size: 0.85em;
				color: rgba(255, 255, 255, 0.5);
				text-transform: uppercase;
				letter-spacing: 1px;
				margin-top: 0.5em;
			}

			.footer-content {
				display: flex;
				align-items: center;
				gap: 12px;
				justify-content: center;
			}

			.footer-logo {
				width: 50px;
				height: auto;
				opacity: 0.7;
				transition: opacity 0.3s;
			}

			.footer-logo:hover {
				opacity: 1;
			}

			.footer-text {
				font-size: 0.9em;
				opacity: 0.6;
			}

			#footer .version-number {
				position: fixed;
				bottom: 10px;
				left: 10px;
				font-size: 0.8em;
				color: rgba(255, 255, 255, 0.6);
				z-index: 100;
			}

			@media screen and (max-width: 736px) {
				.hero-logo {
					width: 320px;
				}
				.hero-stats {
					gap: 2em;
				}
			}

			/* Apply intro background stripes to games section */
			#games {
				background-attachment: fixed;
				background-image: url("assets/css/images/intro.svg");
				background-position: top right;
				background-repeat: no-repeat;
				background-size: 100% 100%;
			}

			@media screen and (max-width: 1280px) {
				#games {
					background-attachment: scroll;
				}
			}

			/* Filter and Sort Controls */
			.search-input {
				height: 2.75em;
				box-sizing: border-box;
			}

			
			/* Game count badge in header */
			.console-header {
				display: flex;
				align-items: center;
				gap: 0.75em;
				flex-wrap: wrap;
			}

			.console-header-icon {
				width: 48px;
				height: 48px;
				object-fit: contain;
			}

			.console-header h2 {
				font-family: 'Press Start 2P', cursive;
				font-size: 0.9em;
				text-shadow: 0 0 8px rgba(96, 165, 250, 0.6), 0 0 15px rgba(59, 130, 246, 0.4);
			}

			.game-count-badge {
				background: rgba(59, 130, 246, 0.2);
				color: #60a5fa;
				padding: 4px 12px;
				border-radius: 20px;
				font-size: 0.5em;
				font-weight: 500;
			}

			.game-count-badge .missing {
				color: #fbbf24;
				margin-left: 8px;
			}


			/* Right-click context menu */
			.context-menu {
				position: fixed;
				background: #1e293b;
				border: 1px solid #3b82f6;
				border-radius: 8px;
				box-shadow: 0 10px 40px rgba(0,0,0,0.5);
				z-index: 10002;
				min-width: 180px;
				padding: 6px 0;
				display: none;
			}

			.context-menu.active {
				display: block;
			}

			.context-menu-item {
				display: flex;
				align-items: center;
				gap: 10px;
				padding: 10px 16px;
				color: #fff;
				cursor: pointer;
				font-size: 0.85em;
				transition: background 0.2s;
			}

			.context-menu-item:hover {
				background: rgba(59, 130, 246, 0.2);
			}

			.context-menu-item .icon {
				color: #60a5fa;
				width: 16px;
				text-align: center;
			}

			.context-menu-item.danger {
				color: #f87171;
			}

			.context-menu-item.danger .icon {
				color: #f87171;
			}

			.context-menu-divider {
				height: 1px;
				background: rgba(255,255,255,0.1);
				margin: 6px 0;
			}

			/* Device selector grid */
			.device-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
				gap: 1em;
			}

			.device-card {
				background: rgba(255,255,255,0.05);
				border: 2px solid rgba(255,255,255,0.1);
				border-radius: 12px;
				padding: 1.5em 1em;
				text-align: center;
				cursor: pointer;
				transition: all 0.2s ease;
			}

			.device-card:hover {
				background: rgba(59, 130, 246, 0.15);
				border-color: #3b82f6;
				transform: translateY(-3px);
			}

			.device-card .device-icon {
				font-size: 2.5em;
				margin-bottom: 0.5em;
			}

			.device-card .device-image {
				width: 80px;
				height: 80px;
				object-fit: contain;
				margin-bottom: 0.5em;
				border-radius: 8px;
			}

			.device-card .device-name {
				font-weight: 600;
				color: #fff;
				margin-bottom: 0.25em;
			}

			.device-card .device-desc {
				font-size: 0.75em;
				color: rgba(255,255,255,0.5);
			}

			/* Current device indicator in sidebar */
			.current-device {
				display: flex;
				align-items: center;
				gap: 8px;
				padding: 8px 12px;
				background: rgba(59, 130, 246, 0.2);
				border-radius: 8px;
				margin-bottom: 1em;
				font-size: 0.85em;
				color: #60a5fa;
				cursor: pointer;
				transition: background 0.2s;
			}

			.current-device:hover {
				background: rgba(59, 130, 246, 0.3);
			}

			.current-device .device-emoji {
				font-size: 1.2em;
			}

			@media screen and (max-width: 600px) {
				.device-grid {
					grid-template-columns: 1fr;
				}
			}

		</style>
	</head>
	<body class="is-preload">

		<!-- Floating Upload Button -->
		<button class="btn-3d green floating-upload" id="floatingUpload" onclick="openUploadModal()">
			<span class="icon solid fa-upload"></span> Upload
		</button>

		<!-- Floating Install PWA Button -->
		<button class="btn-3d green floating-install" id="installPwaBtn" style="display: none;" onclick="installPwa()">
			<span class="icon solid fa-download"></span> Install App
		</button>

		<!-- Sidebar -->
		<section id="sidebar">
			<div class="inner">
				<div id="deviceIndicator" class="current-device" style="display: none;" onclick="showDeviceSelector()">
					<span class="device-emoji">üéÆ</span> Anbernic RG Nano
				</div>
				<nav>
					<ul id="consoleList">
						<li><a href="#intro">Home</a></li>
					</ul>
				</nav>
				<div style="position: absolute; bottom: 15px; left: 15px; font-size: 12px; color: #fff; font-style: italic; text-shadow: 0 0 8px rgba(96, 165, 250, 0.6), 0 0 15px rgba(59, 130, 246, 0.4);">Version 1.4</div>
			</div>
		</section>

		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Intro -->
			<section id="intro" class="wrapper style1 fullscreen fade-up">
				<div class="hero-section">
					<img src="assets/images/logo.png" alt="NanoArcade" class="hero-logo">
					<p class="hero-tagline">Your retro game collection, beautifully organized. Browse by console, manage box art, and keep your library sharp.</p>
					<div style="display: flex; gap: 1em; justify-content: center; flex-wrap: wrap;">
						<button class="btn-3d purple" onclick="showDeviceSelector()">
							<span class="icon solid fa-gamepad"></span> Select Device
						</button>
					</div>
					<div style="margin-top: 1.5em; padding: 1em 1.5em; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; max-width: 600px; margin-left: auto; margin-right: auto;">
						<p style="font-size: 0.85em; color: rgba(255,255,255,0.8); margin: 0; line-height: 1.5;">
							<span class="icon solid fa-info-circle" style="color: #3b82f6; margin-right: 0.5em;"></span>
							<strong>Browser Requirements:</strong> This app requires Chrome, Edge, or Opera. You'll need to grant file access permission when prompted.
						</p>
					</div>
					<div class="hero-stats" id="statsRow" style="display:none;">
						<div class="hero-stat clickable" style="cursor: default; pointer-events: none;">
							<div class="value" id="statConsoles">0</div>
							<div class="label">Consoles</div>
						</div>
						<div class="hero-stat clickable" onclick="goToAllGames(false)" title="View all games">
							<div class="value" id="statGames">0</div>
							<div class="label">Games</div>
						</div>
						<div class="hero-stat clickable" onclick="goToAllGames(true)" title="View games missing art">
							<div class="value" id="statMissing">0</div>
							<div class="label">Missing Art</div>
						</div>
					</div>
					<!-- Buy Me a Coffee -->
					<div style="margin-top: 2em;">
						<a href="https://www.buymeacoffee.com/audioslayer" target="_blank" rel="noopener"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=&slug=audioslayer&button_colour=5F7FFF&font_colour=ffffff&font_family=Cookie&outline_colour=000000&coffee_colour=FFDD00" alt="Buy me a coffee" /></a>
					</div>
				</div>
			</section>

			<!-- Games Section -->
			<section id="games" class="wrapper style1 fade-up" style="display:none;">
				<div class="inner">
					<div class="console-header">
						<img id="currentConsoleIcon" class="console-header-icon" src="" alt="" style="display:none;">
						<h2 id="currentConsoleName">Select a console to view games</h2>
						<span class="game-count-badge" id="gameCountBadge" style="display:none;">
							<span id="totalGameCount">0</span> games
							<span class="missing" id="missingArtCount" style="display:none;">(<span id="missingCount">0</span> missing art)</span>
						</span>
					</div>
					<div class="controls-bar">
						<input type="text" id="searchBox" class="search-input" placeholder="Search games..." oninput="filterGames()">
						<button class="btn-3d small cyan" id="filterMissingBtn" onclick="toggleMissingFilter()">
							<span class="icon solid fa-filter"></span> Missing Art
						</button>
						<button class="btn-3d small gold" id="top25Btn" onclick="openTop25Modal()" style="display:none;">
							<span class="icon solid fa-trophy"></span> Top 25
						</button>
						<button class="btn-3d small gray" id="sortBtn" onclick="toggleSort()">
							<span class="icon solid fa-sort-alpha-down" id="sortIcon"></span> <span id="sortLabel">A-Z</span>
						</button>
					</div>
					<div class="games-grid" id="gamesGrid">
						<p>Scan your drive to view games</p>
					</div>
				</div>
			</section>

		</div>

		<!-- Game Modal -->
		<div class="modal-overlay" id="gameModal">
			<div class="modal-box" style="max-width: 480px;">
				<!-- Header -->
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; gap: 0.5em;">
					<div style="display: flex; align-items: center; gap: 0.5em; min-width: 0; flex: 1;">
						<div id="gameTitleWrap" style="position: relative; min-width: 0; flex: 1; cursor: default;">
							<h3 id="modalGameName" style="color: #ffffff; margin: 0; font-family: 'Press Start 2P', cursive; font-size: 0.55em; text-shadow: 0 0 8px #3b82f6, 0 0 15px #3b82f6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Game Name</h3>
							<div id="gameTitleTooltip" class="gf-tooltip" style="bottom: auto; top: 100%; margin-top: 0.5em; margin-bottom: 0;"></div>
						</div>
						<span class="icon solid fa-pencil-alt" onclick="openRenameFromGameModal()" style="color: rgba(255,255,255,0.4); cursor: pointer; font-size: 0.8em; flex-shrink: 0;" title="Rename game"></span>
					</div>
					<button class="close-btn" style="flex-shrink: 0;" onclick="closeModal('gameModal')">&times;</button>
				</div>
				<!-- Image preview -->
				<div class="image-preview" id="modalImagePreview" style="
					width: 100%;
					height: 340px;
					margin-bottom: 1.25em;
					border-radius: 12px;
					border: 1px solid rgba(59, 130, 246, 0.3);
					box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
					display: flex;
					align-items: center;
					justify-content: center;
				">
					<span class="no-image">?</span>
				</div>
				<!-- GameFAQs Info -->
				<div id="gameFaqsInfo" style="display: none; margin-bottom: 1em; padding: 0.75em; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
					<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5em; text-align: center; font-size: 0.8em;">
						<div id="gfRatingWrap" style="cursor: help; position: relative;">
							<div style="color: rgba(255,255,255,0.5); margin-bottom: 0.25em;">Rating</div>
							<div id="gfRating" style="color: #fbbf24;">
								<span class="icon solid fa-star"></span> --
							</div>
							<div id="gfRatingTooltip" class="gf-tooltip"></div>
						</div>
						<div id="gfDifficultyWrap" style="cursor: help; position: relative;">
							<div style="color: rgba(255,255,255,0.5); margin-bottom: 0.25em;">Difficulty</div>
							<div id="gfDifficulty" style="color: #f87171;">
								<span class="icon solid fa-heartbeat"></span> --
							</div>
							<div id="gfDifficultyTooltip" class="gf-tooltip"></div>
						</div>
						<div id="gfLengthWrap" style="cursor: help; position: relative;">
							<div style="color: rgba(255,255,255,0.5); margin-bottom: 0.25em;">Length</div>
							<div id="gfLength" style="color: #34d399;">
								<span class="icon solid fa-clock"></span> --
							</div>
							<div id="gfLengthTooltip" class="gf-tooltip"></div>
						</div>
					</div>
				</div>
				<!-- RG Nano layout: Find Art full width, then Saves + Local Image -->
				<div id="savesButtonRow" style="display: none; margin-bottom: 0.75em;">
					<button class="btn-3d small" onclick="openImagePicker()" style="width: 100%; margin-bottom: 0.75em;"><span class="icon solid fa-search"></span> Find Art</button>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em;">
						<button class="btn-3d small cyan" onclick="openSaveManager()"><span class="icon solid fa-save"></span> Manage Saves</button>
						<button class="btn-3d small gray" onclick="selectLocalImage()"><span class="icon solid fa-folder-open"></span> Local Image</button>
					</div>
				</div>
				<!-- Non-RG Nano layout: Find Art + Local Image side by side -->
				<div id="noSavesButtonRow" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin-bottom: 0.75em;">
					<button class="btn-3d small" onclick="openImagePicker()"><span class="icon solid fa-search"></span> Find Art</button>
					<button class="btn-3d small gray" onclick="selectLocalImage()"><span class="icon solid fa-folder-open"></span> Local Image</button>
				</div>
				<!-- URL input section -->
				<div style="margin-bottom: 0.75em;">
					<div style="display: flex; gap: 0.5em;">
						<div style="flex: 1; position: relative; display: flex; align-items: center;">
							<span class="icon solid fa-link" style="position: absolute; left: 0.75em; color: rgba(255,255,255,0.4); font-size: 0.85em;"></span>
							<input type="url" id="imageUrl" class="url-input" placeholder="Paste link here..." style="border-color: rgba(59, 130, 246, 0.3); padding-left: 2.25em; padding-right: 2.5em; width: 100%; box-sizing: border-box;">
							<span class="icon brands fa-google" onclick="openGoogleImages()" style="position: absolute; right: 0.75em; color: rgba(255,255,255,0.5); font-size: 0.95em; cursor: pointer; transition: color 0.2s;" onmouseover="this.style.color='#60a5fa'" onmouseout="this.style.color='rgba(255,255,255,0.5)'" title="Search Google Images"></span>
						</div>
						<button class="btn-3d small green" onclick="downloadAndResizeImage()"><span class="icon solid fa-check"></span></button>
					</div>
					<div class="status-msg" id="imageStatus" style="font-size: 0.8em; margin-top: 0.35em;"></div>
				</div>
				<!-- Navigation & Delete -->
				<div style="display: flex; gap: 0.5em; padding-top: 0.75em; border-top: 1px solid rgba(59, 130, 246, 0.2);">
					<button class="btn-3d small purple" id="nextGameBtn" style="flex: 1;" onclick="goToNextMissingArt()"><span class="icon solid fa-forward"></span> Next Missing</button>
					<button class="btn-3d small red" onclick="confirmDeleteGame()"><span class="icon solid fa-trash"></span></button>
				</div>
				<input type="file" id="localImageInput" accept="image/*" style="display:none;" onchange="handleLocalImage(event)">
			</div>
		</div>

		<!-- Top 25 Games Modal -->
		<div class="modal-overlay" id="top25Modal">
			<div class="modal-box" style="max-width: 550px;">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
					<h3 style="color: #f59e0b; font-size: 1.1em; margin: 0; text-shadow: 0 0 20px rgba(245, 158, 11, 0.5);">
						<span class="icon solid fa-trophy" style="margin-right: 0.5em;"></span>Top 25 <span id="top25ConsoleName">Games</span>
					</h3>
					<button class="close-btn" onclick="closeModal('top25Modal')">&times;</button>
				</div>
				<div style="margin-bottom: 1em; display: flex; gap: 1em; align-items: center;">
					<div class="top25-stats">
						<span style="color: #22c55e;"><span class="icon solid fa-check"></span> <span id="top25Owned">0</span> owned</span>
						<span style="color: #ef4444; margin-left: 1em;"><span class="icon solid fa-times"></span> <span id="top25Missing">0</span> missing</span>
					</div>
				</div>
				<div id="top25List" style="max-height: 400px; overflow-y: auto; margin: 0 -1em; padding: 0 1em;"></div>
				<div class="top25-upload-zone" id="top25DropZone" style="margin-top: 1em; border: 2px dashed rgba(245, 158, 11, 0.4); border-radius: 8px; padding: 1em; text-align: center; transition: all 0.2s;">
					<span class="icon solid fa-cloud-upload-alt" style="font-size: 1.5em; color: #f59e0b; margin-bottom: 0.5em; display: block;"></span>
					<p style="margin: 0; font-size: 0.85em; color: rgba(255,255,255,0.6);">Drag & drop missing ROMs here or <a href="#" onclick="document.getElementById('top25FileInput').click(); return false;" style="color: #f59e0b;">browse</a></p>
				</div>
				<input type="file" id="top25FileInput" multiple style="display:none;" onchange="handleTop25Upload(event)">
			</div>
		</div>

		<!-- Upload Modal -->
		<div class="modal-overlay" id="uploadModal">
			<div class="modal-box" style="max-width: 480px;">
				<!-- Header with neon accent -->
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25em;">
					<h3 style="color: #60a5fa; font-size: 1.1em; margin: 0; text-shadow: 0 0 20px rgba(96, 165, 250, 0.5);">
						<span class="icon solid fa-upload" style="margin-right: 0.5em;"></span>Upload Games
					</h3>
					<button class="close-btn" onclick="closeModal('uploadModal')">&times;</button>
				</div>
				<!-- Console selector -->
				<div style="margin-bottom: 1em;">
					<label style="font-size: 0.8em; color: rgba(255,255,255,0.5); margin-bottom: 0.35em; display: block;">Target Console</label>
					<select id="uploadConsoleSelect" style="width: 100%; background-color: rgba(0,0,0,0.3); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; color: white;">
						<option value="">Select a console...</option>
					</select>
				</div>
				<!-- Drop zone -->
				<div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()" style="
					border: 2px dashed rgba(59, 130, 246, 0.4);
					border-radius: 12px;
					padding: 1.75em;
					text-align: center;
					background: rgba(0,0,0,0.3);
					margin-bottom: 1em;
					transition: all 0.2s;
					cursor: pointer;
				">
					<span class="icon solid fa-file-import" style="font-size: 2em; color: #3b82f6; margin-bottom: 0.5em; display: block; text-shadow: 0 0 15px rgba(59, 130, 246, 0.5);"></span>
					<p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 0.25em;">Drag & drop ROM files</p>
					<p style="color: rgba(255,255,255,0.4); font-size: 0.75em;">or click to browse</p>
					<input type="file" id="fileInput" multiple style="display:none;" onchange="handleFileSelect(event)">
				</div>
				<!-- File list -->
				<div class="file-list" id="fileList" style="max-height: 120px; overflow-y: auto; margin-bottom: 1em; display: flex; flex-direction: column; gap: 0.4em;"></div>
				<!-- Action buttons -->
				<div style="display: flex; gap: 0.5em; padding-top: 0.75em; border-top: 1px solid rgba(59, 130, 246, 0.2);">
					<button class="btn-3d small gray" style="flex: 0.4;" onclick="closeModal('uploadModal')"><span class="icon solid fa-times"></span> Cancel</button>
					<button class="btn-3d small green" style="flex: 0.6;" onclick="uploadFiles()"><span class="icon solid fa-upload"></span> Upload</button>
				</div>
				<div class="status-msg" id="uploadStatus" style="margin-top: 0.5em;"></div>
			</div>
		</div>

		<!-- Delete Confirmation Modal -->
		<div class="modal-overlay" id="deleteModal">
			<div class="modal-box" style="max-width: 400px;">
				<div class="modal-header">
					<h3 style="color: #ef4444;"><span class="icon solid fa-exclamation-triangle"></span> Delete Game</h3>
					<button class="close-btn" onclick="closeModal('deleteModal')">&times;</button>
				</div>
				<p id="deleteConfirmText" style="margin-bottom: 1.5em; text-align: center;">Are you sure you want to delete this game?</p>
				<div style="display: flex; gap: 1em; justify-content: center;">
					<button class="btn-3d small gray" onclick="closeModal('deleteModal')"><span class="icon solid fa-times"></span> Cancel</button>
					<button class="btn-3d small red" onclick="executeDeleteGame()"><span class="icon solid fa-trash"></span> Delete</button>
				</div>
			</div>
		</div>

		<!-- Delete Save Confirmation Modal -->
		<div class="modal-overlay" id="deleteSaveModal" style="z-index: 10001;">
			<div class="modal-box" style="max-width: 400px;">
				<div class="modal-header">
					<h3 style="color: #ef4444;"><span class="icon solid fa-exclamation-triangle"></span> Delete Save</h3>
					<button class="close-btn" onclick="closeModal('deleteSaveModal')">&times;</button>
				</div>
				<p id="deleteSaveConfirmText" style="margin-bottom: 1.5em; text-align: center;">Are you sure you want to delete this save?</p>
				<div style="display: flex; gap: 1em; justify-content: center;">
					<button class="btn-3d small gray" onclick="closeModal('deleteSaveModal')"><span class="icon solid fa-times"></span> Cancel</button>
					<button class="btn-3d small red" onclick="executeDeleteSave()"><span class="icon solid fa-trash"></span> Delete</button>
				</div>
			</div>
		</div>

		<!-- Image Picker Modal (fullscreen) -->
		<div class="image-picker-overlay" id="imagePicker">
			<div class="image-picker-header">
				<h3>Select Box Art</h3>
				<div class="image-picker-search">
					<input type="text" id="pickerSearchQuery" placeholder="Search for game..." onkeypress="if(event.key==='Enter')searchImagesInPicker()">
					<button class="btn-3d small" onclick="searchImagesInPicker()"><span class="icon solid fa-search"></span> Search</button>
				</div>
				<button class="image-picker-close" onclick="closeImagePicker()">&times;</button>
			</div>
			<div class="image-picker-grid" id="pickerGrid">
				<div class="no-results">Enter a game name and click Search</div>
			</div>
			<div class="image-picker-footer">
				<button class="btn-3d green" id="pickerSelectBtn" onclick="confirmImageSelection()" disabled><span class="icon solid fa-check"></span> Select</button>
			</div>
		</div>

		<!-- Context Menu -->
		<div class="context-menu" id="contextMenu">
			<div class="context-menu-item" onclick="contextMenuAction('edit')">
				<span class="icon solid fa-edit"></span> Edit Box Art
			</div>
			<div class="context-menu-item" onclick="contextMenuAction('search')">
				<span class="icon solid fa-search"></span> Search Art
			</div>
			<div class="context-menu-item" onclick="contextMenuAction('google')">
				<span class="icon solid fa-external-link-alt"></span> Google Images
			</div>
			<div class="context-menu-divider"></div>
			<div class="context-menu-item" onclick="contextMenuAction('rename')">
				<span class="icon solid fa-i-cursor"></span> Rename
			</div>
			<div class="context-menu-item danger" onclick="contextMenuAction('delete')">
				<span class="icon solid fa-trash"></span> Delete Game
			</div>
		</div>

		<!-- Rename Modal -->
		<div class="modal-overlay" id="renameModal">
			<div class="modal-box" style="max-width: 450px;">
				<div class="modal-header">
					<h3><span class="icon solid fa-i-cursor"></span> Rename Game</h3>
					<button class="close-btn" onclick="closeModal('renameModal')">&times;</button>
				</div>
				<div class="compact-field" style="margin-bottom: 0.75em;">
					<label>New name (without extension):</label>
					<input type="text" id="renameInput" placeholder="Enter new name...">
				</div>
				<div style="margin-bottom: 1em;">
					<button class="btn-3d small cyan" onclick="autoCleanName()" style="width: 100%;"><span class="icon solid fa-magic"></span> Auto-Clean Name</button>
				</div>
				<p style="font-size: 0.8em; color: rgba(255,255,255,0.5); margin-bottom: 1em;">This will rename both the ROM file and its box art image.</p>
				<div style="display: flex; gap: 1em; justify-content: flex-end;">
					<button class="btn-3d small gray" onclick="closeModal('renameModal')"><span class="icon solid fa-times"></span> Cancel</button>
					<button class="btn-3d small green" onclick="executeRename()"><span class="icon solid fa-check"></span> Rename</button>
				</div>
				<div class="status-msg" id="renameStatus"></div>
			</div>
		</div>

		<!-- Device Selector Modal -->
		<div class="modal-overlay" id="deviceModal">
			<div class="modal-box" style="max-width: 650px;">
				<div class="modal-header">
					<h3><span class="icon solid fa-gamepad"></span> Select Your Device</h3>
					<button class="close-btn" onclick="closeModal('deviceModal')">&times;</button>
				</div>
				<p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5em; text-align: center;">Choose your handheld device to ensure correct folder structure and box art sizing.</p>
				<div class="device-grid">
					<div class="device-card" onclick="selectDevice('rgnano')">
						<img src="assets/images/devices/rgnano.png" alt="RG Nano" class="device-image">
						<div class="device-name">Anbernic RG Nano</div>
						<div class="device-desc">Stock OS / Drum78 CFW</div>
					</div>
					<div class="device-card" onclick="selectDevice('onion')">
						<img src="assets/images/devices/miyoo-mini.png" alt="Miyoo Mini" class="device-image">
						<div class="device-name">Miyoo Mini / Plus</div>
						<div class="device-desc">Onion OS (250px)</div>
					</div>
					<div class="device-card" onclick="selectDevice('miyooflip')">
						<img src="assets/images/devices/miyoo-flip.png" alt="Miyoo Flip" class="device-image">
						<div class="device-name">Miyoo Flip / Mini Flip</div>
						<div class="device-desc">Onion OS (280px)</div>
					</div>
					<div class="device-card" onclick="selectDevice('stock')">
						<div class="device-icon">üìÅ</div>
						<div class="device-name">Generic</div>
						<div class="device-desc">Standard folder names</div>
					</div>
					<div class="device-card" onclick="selectDevice('trimuibrick')">
						<img src="assets/images/devices/trimuibrick.png" alt="Trimui Brick" class="device-image">
						<div class="device-name">Trimui Brick</div>
						<div class="device-desc">Mustard OS (354px)</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Folder Selection Instructions Modal -->
		<div class="modal-overlay" id="folderInstructionsModal">
			<div class="modal-box" style="max-width: 550px;">
				<div class="modal-header">
					<h3><span class="icon solid fa-folder-open"></span> Select Folder</h3>
				</div>
				<div style="padding: 2em; text-align: center;">
					<p id="folderInstructionText" style="font-size: 1.1em; line-height: 1.6; color: rgba(255,255,255,0.9); margin-bottom: 2em;"></p>
					<button class="btn-3d green" onclick="closeInstructionsAndScan()" style="width: 100%; padding: 16px 32px;">
						<span class="icon solid fa-check"></span> OK, Let's Go!
					</button>
				</div>
			</div>
		</div>

		<!-- Error Modal -->
		<div class="modal-overlay" id="errorModal">
			<div class="modal-box" style="max-width: 500px;">
				<div class="modal-header">
					<h3><span class="icon solid fa-exclamation-triangle" style="color: #ef4444;"></span> Error</h3>
					<button class="close-btn" onclick="closeModal('errorModal')">&times;</button>
				</div>
				<div style="padding: 2em; text-align: center;">
					<p id="errorMessage" style="font-size: 1em; line-height: 1.6; color: rgba(255,255,255,0.9); margin-bottom: 2em;"></p>
					<button class="btn-3d red" onclick="closeModal('errorModal')" style="padding: 12px 24px;">
						<span class="icon solid fa-times"></span> Close
					</button>
				</div>
			</div>
		</div>

		<!-- Save Manager Modal -->
		<div class="modal-overlay" id="saveModal">
			<div class="modal-box" style="max-width: 600px;">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;">
					<h3 style="color: #22d3ee; font-size: 1.1em; margin: 0; text-shadow: 0 0 20px rgba(34, 211, 238, 0.5);">
						<span class="icon solid fa-save" style="margin-right: 0.5em;"></span>Save Manager - <span id="saveGameName">Game</span>
					</h3>
					<button class="close-btn" onclick="closeModal('saveModal')">&times;</button>
				</div>

				<!-- Local Saves -->
				<div id="localSavesList" style="max-height: 300px; overflow-y: auto;">
					<div class="loading-container" style="padding: 2em;">
						<div class="spinner"></div>
						<div class="loading-text">Checking for saves...</div>
					</div>
				</div>
				<div style="margin-top: 1em; padding-top: 1em; border-top: 1px solid rgba(34, 211, 238, 0.2);">
					<button class="btn-3d small green" onclick="uploadLocalSave()" style="width: 100%;">
						<span class="icon solid fa-upload"></span> Restore Save File
					</button>
					<input type="file" id="saveFileInput" accept=".sav,.srm" style="display:none;" onchange="handleSaveUpload(event)">
				</div>
			</div>
		</div>

		<!-- Footer -->
		<footer id="footer" class="wrapper style1-alt">
			<div class="inner">
				<span class="version-number">v1.4</span>
			</div>
		</footer>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>

		<script>
			// Global state
			let directoryHandle = null;
			let consoles = {};
			let currentConsole = null;
			let currentGame = null;
			let filesToUpload = [];
			let filterMissingOnly = false;
			let currentSort = 'az';
			let contextMenuTarget = null;
			let contextMenuConsole = null;
			let currentDevice = 'rgnano';
			let objectURLs = []; // Track object URLs for cleanup

			// Helper to create data URL from blob (works on file:// protocol)
			function blobToDataURL(blob) {
				return new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onload = () => resolve(reader.result);
					reader.onerror = reject;
					reader.readAsDataURL(blob);
				});
			}

			// Helper to create URL from blob - uses data URL for file:// protocol compatibility
			async function createObjectURL(blob) {
				// Use data URLs to avoid blob:null issues on file:// protocol
				return await blobToDataURL(blob);
			}

			// Revoke all tracked object URLs (no-op for data URLs, kept for compatibility)
			function revokeObjectURLs() {
				objectURLs = [];
			}
			let pendingDirectoryHandle = null;

			// Onion OS folder structure (shared by all Miyoo devices)
			const onionFolderMap = {
				'GB': ['GB'],
				'GBC': ['GBC'],
				'GBA': ['GBA'],
				'NES': ['FC'],  // Famicom
				'FDS': ['FDS'], // Famicom Disk System
				'SNES': ['SFC'], // Super Famicom
				'Genesis': ['MD'], // Mega Drive
				'Game Gear': ['GG'],
				'PS1': ['PS'],
				'PCE': ['PCE'], // PC Engine
				'PCE CD': ['PCECD'],
				'Arcade': ['ARCADE', 'FBN', 'MAME'],
				'CPS3': ['CPS3'],
				'Master System': ['MS'],
				'Neo Geo': ['NEOGEO'],
				'Atari 2600': ['ATARI'],
				'Atari Lynx': ['LYNX'],
				'Atari 5200': ['FIFTYTWOHUNDRED'],
				'Atari 7800': ['SEVENTYEIGHTHUNDRED'],
				'Virtual Boy': ['VB'],
				'WonderSwan': ['WS'],
				'Neo Geo Pocket': ['NGP'],
				'N64': ['N64'],
				'NDS': ['NDS'],
				'PSP': ['PSP'],
				'DOS': ['DOS'],
				'ColecoVision': ['COLECO'],
				'Commodore': ['COMMODORE'],
				'Game & Watch': ['GW'],
				'Sega CD': ['SEGACD'],
				'PICO-8': ['PICO'],
				'ScummVM': ['SCUMMVM'],
				'Vectrex': ['VECTREX'],
				'ZX Spectrum': ['ZXS'],
				'Satellaview': ['SATELLAVIEW']
			};

			// Device profiles with folder mappings and settings
			const deviceProfiles = {
				rgnano: {
					name: 'Anbernic RG Nano',
					emoji: 'üéÆ',
					imageSize: 240,
					// Maps display name to folder name(s)
					folderMap: {
						'GB': ['Game Boy', 'GB'],
						'GBC': ['Game Boy Color', 'GBC'],
						'GBA': ['Game Boy Advance', 'GBA'],
						'NES': ['NES', 'FC'],
						'SNES': ['SNES', 'SFC'],
						'Genesis': ['Sega Genesis', 'Genesis', 'MD'],
						'Game Gear': ['Game Gear', 'GG'],
						'Master System': ['Sega Master System', 'Master System', 'MS'],
						'PS1': ['PS1', 'PS', 'PSX'],
						'PCE': ['PCE-TurboGrafx', 'PCE'],
						'Arcade': ['Final Burn Alpha 2012', 'MAME 2000', 'ARCADE', 'FBA', 'MAME'],
						'Atari Lynx': ['Atari lynx', 'Atari Lynx'],
						'Neo Geo Pocket': ['Neo Geo Pocket', 'NGP'],
						'WonderSwan': ['WonderSwan', 'WS'],
						'Pokemon Mini': ['Pokemon Mini']
					}
				},
				onion: {
					name: 'Miyoo Mini / Plus',
					emoji: 'üßÖ',
					imageSize: 250,
					romsFolder: 'Roms',
					folderMap: onionFolderMap
				},
				miyooflip: {
					name: 'Miyoo Flip / Mini Flip',
					emoji: 'üßÖ',
					imageSize: 280,
					romsFolder: 'Roms',
					folderMap: onionFolderMap
				},
				stock: {
					name: 'Generic',
					emoji: 'üìÅ',
					imageSize: 240,
					folderMap: {
						// Supports RetroPie, EmulationStation, Batocera, and common naming conventions
						'GB': ['gb', 'GB', 'gameboy', 'Gameboy', 'GameBoy'],
						'GBC': ['gbc', 'GBC', 'gameboycolor', 'GameBoyColor'],
						'GBA': ['gba', 'GBA', 'gameboyadvance', 'GameBoyAdvance'],
						'NES': ['nes', 'NES', 'famicom', 'Famicom', 'FC', 'fc'],
						'SNES': ['snes', 'SNES', 'sfc', 'SFC', 'supernes', 'SuperNES', 'superfamicom', 'SuperFamicom'],
						'Genesis': ['megadrive', 'Megadrive', 'MegaDrive', 'genesis', 'Genesis', 'MD', 'md'],
						'Game Gear': ['gamegear', 'GameGear', 'GG', 'gg'],
						'Master System': ['mastersystem', 'MasterSystem', 'sms', 'SMS', 'MS', 'ms'],
						'PS1': ['psx', 'PSX', 'ps1', 'PS1', 'playstation', 'PlayStation', 'PS', 'ps'],
						'N64': ['n64', 'N64', 'nintendo64', 'Nintendo64'],
						'PCE': ['pcengine', 'PCEngine', 'pce', 'PCE', 'turbografx', 'TurboGrafx', 'tg16', 'TG16'],
						'Arcade': ['arcade', 'Arcade', 'ARCADE', 'mame', 'MAME', 'fba', 'FBA', 'fbneo', 'FBNeo', 'neogeo', 'NeoGeo', 'NEOGEO'],
						'Neo Geo': ['neogeo', 'NeoGeo', 'NEOGEO', 'ng'],
						'Atari 2600': ['atari2600', 'Atari2600', 'atari', 'Atari', 'ATARI'],
						'Atari 7800': ['atari7800', 'Atari7800'],
						'Atari 5200': ['atari5200', 'Atari5200'],
						'Atari Lynx': ['atarilynx', 'AtariLynx', 'lynx', 'Lynx'],
						'Virtual Boy': ['virtualboy', 'VirtualBoy', 'vb', 'VB'],
						'WonderSwan': ['wonderswan', 'WonderSwan', 'ws', 'WS'],
						'Neo Geo Pocket': ['ngp', 'NGP', 'ngpc', 'NGPC', 'neogeopocket', 'NeoGeoPocket'],
						'NDS': ['nds', 'NDS', 'ds', 'DS', 'nintendods', 'NintendoDS'],
						'PSP': ['psp', 'PSP'],
						'Sega CD': ['segacd', 'SegaCD', 'megacd', 'MegaCD'],
						'Sega 32X': ['sega32x', 'Sega32X', '32x', '32X'],
						'Dreamcast': ['dreamcast', 'Dreamcast', 'dc', 'DC'],
						'Saturn': ['saturn', 'Saturn', 'segasaturn', 'SegaSaturn'],
						'Coleco': ['coleco', 'Coleco', 'colecovision', 'ColecoVision'],
						'Intellivision': ['intellivision', 'Intellivision'],
						'Vectrex': ['vectrex', 'Vectrex'],
						'MSX': ['msx', 'MSX', 'msx2', 'MSX2'],
						'Commodore 64': ['c64', 'C64', 'commodore64', 'Commodore64'],
						'Amiga': ['amiga', 'Amiga'],
						'DOS': ['dos', 'DOS', 'dosbox', 'DOSBox'],
						'ScummVM': ['scummvm', 'ScummVM', 'SCUMMVM']
					}
				},
				trimuibrick: {
					name: 'Trimui Brick',
					emoji: 'üß±',
					imageSize: 354,
					catalogueStructure: true,  // Flag for 3-tier folder handling (MUOS/info/catalogue/<System>/box/)
					folderMap: {
						// Handheld
						'GB': ['gameboy', 'gb'],
						'GBC': ['gbc'],
						'GBA': ['gba'],
						'Game Gear': ['gamegear'],
						'Atari Lynx': ['lynx'],
						'WonderSwan': ['wonderswan'],
						'Neo Geo Pocket': ['neogeopocket'],
						'NDS': ['nds'],
						'PSP': ['psp'],
						'Pokemon Mini': ['pokemini'],
						'Mega Duck': ['megaduck'],
						'Watara Supervision': ['supervision'],
						'Arduboy': ['arduboy'],
						'Game and Watch': ['gameandwatch'],
						'VeMUlator': ['vemulator'],
						'TI-83': ['ti83'],
						'Java J2ME': ['java'],
						// Home Console
						'NES': ['nes'],
						'FDS': ['fds'],
						'SNES': ['snes'],
						'N64': ['n64'],
						'Virtual Boy': ['virtualboy'],
						'Genesis': ['segamd'],
						'Master System': ['mastersystem'],
						'Sega CD': ['segamdcd'],
						'Sega 32X': ['sega32x'],
						'Saturn': ['saturn'],
						'Dreamcast': ['dreamcast'],
						'SG-1000': ['sg1000'],
						'Sega Pico': ['segapico'],
						'PS1': ['ps1'],
						'PCE': ['pcengine'],
						'PCE CD': ['pcenginecd'],
						'SuperGrafx': ['supergrafx'],
						'PC-FX': ['pcfx'],
						'Neo Geo': ['neogeo'],
						'Neo Geo CD': ['neogeocd'],
						'Atari 2600': ['atari2600'],
						'Atari 5200': ['atari5200'],
						'Atari 7800': ['atari7800'],
						'Atari Jaguar': ['jaguar'],
						'Coleco': ['colecovision'],
						'Intellivision': ['intellivision'],
						'Vectrex': ['vectrex'],
						'3DO': ['3do'],
						'CDi': ['cdi'],
						'Channel F': ['channelf'],
						'Odyssey': ['odyssey'],
						// Computer
						'MSX': ['msx'],
						'Commodore 64': ['c64'],
						'Commodore VIC-20': ['vic20'],
						'Commodore C128': ['c128'],
						'Commodore PET': ['pet'],
						'Commodore CBM-II': ['cbm'],
						'Amiga': ['amiga'],
						'DOS': ['dos'],
						'Amstrad': ['amstrad'],
						'Atari ST': ['atarist'],
						'ZX Spectrum': ['zxspectrum'],
						'ZX 81': ['zx81'],
						'PC-8000/8800': ['pc8000'],
						'PC98': ['pc98'],
						'Sharp X1': ['x1'],
						'Sharp X68000': ['x68000'],
						'Galaksija': ['galaksija'],
						'Spectravision SVI': ['svi'],
						// Arcade
						'Arcade': ['arcade'],
						'Atomiswave/Naomi': ['naomi'],
						// Fantasy Console
						'PICO-8': ['pico8'],
						'TIC-80': ['tic80'],
						'LowRes NX': ['lowresnx'],
						'Vircon32': ['vircon32'],
						'WASM-4': ['wasm4'],
						// Misc
						'ScummVM': ['scummvm'],
						'OpenBOR': ['openbor'],
						'EasyRPG': ['easyrpg'],
						'Cave Story': ['cavestory'],
						'Doom': ['doom'],
						'Quake': ['quake'],
						'Wolfenstein 3D': ['wolfenstein'],
						'CHIP-8': ['chip8'],
						'Uzebox': ['uzebox']
					}
				}
			};

			// Top 25 rated games per console (for "must have" list feature)
			const topGamesData = {
				'GBA': [
					'Legend of Zelda, The - The Minish Cap',
					'Metroid - Zero Mission',
					'Metroid Fusion',
					'Pokemon Emerald',
					'Pokemon FireRed',
					'Pokemon LeafGreen',
					'Castlevania - Aria of Sorrow',
					'Castlevania - Harmony of Dissonance',
					'Advance Wars',
					'Advance Wars 2 - Black Hole Rising',
					'Golden Sun',
					'Golden Sun - The Lost Age',
					'Fire Emblem',
					'Fire Emblem - The Sacred Stones',
					'Mario & Luigi - Superstar Saga',
					'Final Fantasy VI Advance',
					'Final Fantasy Tactics Advance',
					'Legend of Zelda, The - A Link to the Past',
					'Super Mario Advance 4 - Super Mario Bros. 3',
					'Wario Land 4',
					'WarioWare, Inc. - Mega Microgames!',
					'Kirby & The Amazing Mirror',
					'Mega Man Zero',
					'Sonic Advance',
					'Mario Kart - Super Circuit'
				],
				'GB': [
					'Legend of Zelda, The - Link\'s Awakening',
					'Tetris',
					'Pokemon Red',
					'Pokemon Blue',
					'Pokemon Yellow',
					'Super Mario Land 2 - 6 Golden Coins',
					'Super Mario Land',
					'Donkey Kong',
					'Metroid II - Return of Samus',
					'Kirby\'s Dream Land',
					'Kirby\'s Dream Land 2',
					'Wario Land - Super Mario Land 3',
					'Final Fantasy Adventure',
					'Mega Man - Dr. Wily\'s Revenge',
					'Mega Man II',
					'Mega Man III',
					'Mega Man IV',
					'Mega Man V',
					'Gargoyle\'s Quest',
					'Kid Icarus - Of Myths and Monsters',
					'Castlevania - The Adventure',
					'Castlevania II - Belmont\'s Revenge',
					'Batman',
					'Contra - The Alien Wars',
					'Dr. Mario'
				],
				'GBC': [
					'Legend of Zelda, The - Oracle of Ages',
					'Legend of Zelda, The - Oracle of Seasons',
					'Legend of Zelda, The - Link\'s Awakening DX',
					'Pokemon Gold',
					'Pokemon Silver',
					'Pokemon Crystal',
					'Metal Gear Solid',
					'Wario Land 3',
					'Wario Land II',
					'Dragon Warrior III',
					'Super Mario Bros. Deluxe',
					'Mario Tennis',
					'Mario Golf',
					'Pokemon Trading Card Game',
					'Pokemon Pinball',
					'Donkey Kong Country',
					'Shantae',
					'Mega Man Xtreme',
					'Mega Man Xtreme 2',
					'R-Type DX',
					'Bionic Commando - Elite Forces',
					'Dragon Warrior Monsters',
					'Dragon Warrior Monsters 2',
					'Harvest Moon GBC',
					'Kirby Tilt \'n\' Tumble'
				],
				'NES': [
					'Super Mario Bros. 3',
					'Legend of Zelda, The',
					'Super Mario Bros.',
					'Super Mario Bros. 2',
					'Zelda II - The Adventure of Link',
					'Mega Man 2',
					'Mega Man 3',
					'Metroid',
					'Contra',
					'Castlevania',
					'Castlevania III - Dracula\'s Curse',
					'Punch-Out!!',
					'Final Fantasy',
					'Dragon Warrior',
					'Dragon Warrior III',
					'Dragon Warrior IV',
					'Kirby\'s Adventure',
					'Ninja Gaiden',
					'Ninja Gaiden II',
					'Ninja Gaiden III',
					'Tecmo Super Bowl',
					'DuckTales',
					'Mega Man',
					'Bionic Commando',
					'Battletoads'
				],
				'SNES': [
					'Chrono Trigger',
					'Legend of Zelda, The - A Link to the Past',
					'Super Mario World',
					'Super Metroid',
					'Final Fantasy VI',
					'Final Fantasy IV',
					'EarthBound',
					'Super Mario World 2 - Yoshi\'s Island',
					'Secret of Mana',
					'Super Mario RPG',
					'Donkey Kong Country',
					'Donkey Kong Country 2 - Diddy\'s Kong Quest',
					'Donkey Kong Country 3',
					'Mega Man X',
					'Mega Man X2',
					'Mega Man X3',
					'Street Fighter II Turbo',
					'Super Mario Kart',
					'F-Zero',
					'Star Fox',
					'Contra III - The Alien Wars',
					'Castlevania IV',
					'Teenage Mutant Ninja Turtles IV - Turtles in Time',
					'ActRaiser',
					'Kirby Super Star'
				],
				'Genesis': [
					'Sonic the Hedgehog 2',
					'Sonic the Hedgehog',
					'Sonic the Hedgehog 3',
					'Sonic & Knuckles',
					'Streets of Rage 2',
					'Streets of Rage',
					'Gunstar Heroes',
					'Phantasy Star IV',
					'Shining Force',
					'Shining Force II',
					'Castlevania - Bloodlines',
					'Contra - Hard Corps',
					'Earthworm Jim',
					'Earthworm Jim 2',
					'Shinobi III',
					'Revenge of Shinobi',
					'Golden Axe',
					'Comix Zone',
					'Vectorman',
					'Vectorman 2',
					'Thunder Force III',
					'Thunder Force IV',
					'Rocket Knight Adventures',
					'Altered Beast',
					'Toejam & Earl'
				],
				'Game Gear': [
					'Sonic Triple Trouble',
					'Sonic the Hedgehog',
					'Sonic the Hedgehog 2',
					'Shinobi',
					'Shinobi II - The Silent Fury',
					'Shining Force - Sword of Hajya',
					'Defenders of Oasis',
					'Gunstar Heroes',
					'Streets of Rage 2',
					'Castle of Illusion',
					'Land of Illusion',
					'Tails Adventure',
					'Columns',
					'Sonic Chaos',
					'GG Aleste',
					'Ax Battler',
					'Dragon Crystal',
					'Phantasy Star Adventure',
					'Wonder Boy - The Dragon\'s Trap',
					'Power Strike II',
					'Vampire - Master of Darkness',
					'Ninja Gaiden',
					'Ristar',
					'Mortal Kombat',
					'NBA Jam'
				],
				'Master System': [
					'Sonic the Hedgehog',
					'Phantasy Star',
					'Wonder Boy III - The Dragon\'s Trap',
					'Wonder Boy in Monster Land',
					'Alex Kidd in Miracle World',
					'Alex Kidd in Shinobi World',
					'Shinobi',
					'Golden Axe Warrior',
					'Ninja Gaiden',
					'Castle of Illusion',
					'Land of Illusion',
					'R-Type',
					'Power Strike',
					'Power Strike II',
					'Golvellius',
					'Zillion',
					'Spellcaster',
					'Master of Darkness',
					'Psycho Fox',
					'Asterix',
					'Lucky Dime Caper',
					'Sonic the Hedgehog 2',
					'Streets of Rage',
					'Sonic Chaos',
					'Columns'
				],
				'PS1': [
					'Final Fantasy VII',
					'Metal Gear Solid',
					'Castlevania - Symphony of the Night',
					'Resident Evil 2',
					'Final Fantasy IX',
					'Chrono Cross',
					'Final Fantasy Tactics',
					'Silent Hill',
					'Tekken 3',
					'Resident Evil',
					'Gran Turismo 2',
					'Crash Bandicoot - Warped',
					'Crash Bandicoot 2 - Cortex Strikes Back',
					'Spyro the Dragon',
					'Spyro 2 - Ripto\'s Rage',
					'Tony Hawk\'s Pro Skater 2',
					'Twisted Metal 2',
					'Vagrant Story',
					'Parasite Eve',
					'Legend of Dragoon',
					'Suikoden II',
					'Xenogears',
					'Ape Escape',
					'MediEvil',
					'PaRappa the Rapper'
				],
				'N64': [
					'Legend of Zelda, The - Ocarina of Time',
					'Super Mario 64',
					'GoldenEye 007',
					'Legend of Zelda, The - Majora\'s Mask',
					'Banjo-Kazooie',
					'Perfect Dark',
					'Super Smash Bros.',
					'Mario Kart 64',
					'Banjo-Tooie',
					'Paper Mario',
					'Star Fox 64',
					'F-Zero X',
					'Conker\'s Bad Fur Day',
					'Diddy Kong Racing',
					'Pokemon Stadium',
					'Pokemon Stadium 2',
					'Wave Race 64',
					'1080 Snowboarding',
					'Mario Party 2',
					'Mario Party 3',
					'Kirby 64 - The Crystal Shards',
					'Ogre Battle 64',
					'Sin and Punishment',
					'Star Wars - Rogue Squadron',
					'Blast Corps'
				],
				'PCE': [
					'Castlevania - Rondo of Blood',
					'Ys Book I & II',
					'Bonk\'s Adventure',
					'Bonk\'s Revenge',
					'Blazing Lazers',
					'R-Type',
					'Gate of Thunder',
					'Lords of Thunder',
					'Soldier Blade',
					'Super Star Soldier',
					'Ninja Spirit',
					'Splatterhouse',
					'Military Madness',
					'Dungeon Explorer',
					'Devil\'s Crush',
					'Alien Crush',
					'Air Zonk',
					'Bomberman \'94',
					'Bomberman \'93',
					'Neutopia',
					'Neutopia II',
					'Legendary Axe',
					'Legendary Axe II',
					'Cadash',
					'Snatcher'
				],
				'Neo Geo': [
					'Garou - Mark of the Wolves',
					'Metal Slug 3',
					'Metal Slug X',
					'Metal Slug',
					'King of Fighters \'98',
					'King of Fighters \'97',
					'Samurai Shodown II',
					'Last Blade 2',
					'Last Blade',
					'Real Bout Fatal Fury 2',
					'Fatal Fury Special',
					'Art of Fighting 3',
					'Shock Troopers',
					'Shock Troopers - 2nd Squad',
					'Blazing Star',
					'Pulstar',
					'Neo Turf Masters',
					'Windjammers',
					'Twinkle Star Sprites',
					'Baseball Stars 2',
					'Top Hunter',
					'Magician Lord',
					'Sengoku 3',
					'Matrimelee',
					'Kizuna Encounter'
				],
				'Atari Lynx': [
					'California Games',
					'Chip\'s Challenge',
					'Todd\'s Adventures in Slime World',
					'Blue Lightning',
					'Robotron 2084',
					'Xenophobe',
					'RoadBlasters',
					'Rampage',
					'Klax',
					'Lemmings',
					'Checkered Flag',
					'BattleWheels',
					'Double Dragon',
					'Ninja Gaiden',
					'Shadow of the Beast',
					'Rygar',
					'Toki',
					'Viking Child',
					'Gates of Zendocon',
					'Warbirds',
					'Xybots',
					'Gauntlet - The Third Encounter',
					'Basketbrawl',
					'Electrocop',
					'Zarlor Mercenary'
				],
				'Atari 2600': [
					'Pitfall!',
					'Pitfall II - Lost Caverns',
					'Adventure',
					'Yars\' Revenge',
					'River Raid',
					'Missile Command',
					'Space Invaders',
					'Asteroids',
					'Pac-Man',
					'Ms. Pac-Man',
					'Demon Attack',
					'Frogger',
					'Centipede',
					'Defender',
					'Berzerk',
					'Combat',
					'Kaboom!',
					'Q*bert',
					'Donkey Kong',
					'Joust',
					'Jungle Hunt',
					'Dig Dug',
					'Pole Position',
					'Enduro',
					'H.E.R.O.'
				],
				'WonderSwan': [
					'Final Fantasy',
					'Final Fantasy II',
					'Judgement Silversword',
					'Gunpey',
					'Makaimura',
					'Klonoa - Moonlight Museum',
					'Mr. Driller',
					'Tetris',
					'Guilty Gear Petit 2',
					'One Piece Grand Battle',
					'Front Mission',
					'Rhyme Rider Kerorican',
					'Rainbow Islands',
					'Golden Axe',
					'Rockman & Forte',
					'Dicing Knight Period',
					'Digimon Adventure',
					'Chocobo no Fushigi na Dungeon',
					'Beatmania',
					'Densha de Go! 2',
					'Buffers Evolution',
					'Crazy Climber',
					'Makai Toushi SaGa',
					'Romancing SaGa',
					'SD Gundam G Generation'
				],
				'Neo Geo Pocket': [
					'SNK vs. Capcom - Match of the Millennium',
					'SNK vs. Capcom - Card Fighters Clash',
					'Sonic the Hedgehog Pocket Adventure',
					'Metal Slug - 2nd Mission',
					'Metal Slug - 1st Mission',
					'King of Fighters R-2',
					'Last Blade',
					'Gals\' Fighters',
					'Samurai Shodown! 2',
					'Fatal Fury - First Contact',
					'Neo Turf Masters',
					'Baseball Stars Color',
					'Dark Arms - Beast Buster',
					'Faselei!',
					'Biomotor Unitron',
					'Rockman Battle & Fighters',
					'Bust-A-Move Pocket',
					'Puyo Pop',
					'Puzzle Link 2',
					'Pac-Man',
					'Cotton',
					'Cool Cool Jam',
					'Dive Alert',
					'Evolution - Eternal Dungeons',
					'Ogre Battle Gaiden'
				],
				'NDS': [
					'Pokemon HeartGold',
					'Pokemon SoulSilver',
					'Legend of Zelda, The - Phantom Hourglass',
					'Legend of Zelda, The - Spirit Tracks',
					'Chrono Trigger',
					'Mario Kart DS',
					'New Super Mario Bros.',
					'Super Mario 64 DS',
					'Mario & Luigi - Bowser\'s Inside Story',
					'Pokemon Black',
					'Pokemon White',
					'Pokemon Platinum',
					'Advance Wars - Dual Strike',
					'Final Fantasy Tactics A2 - Grimoire of the Rift',
					'Dragon Quest IX - Sentinels of the Starry Skies',
					'Castlevania - Dawn of Sorrow',
					'Castlevania - Portrait of Ruin',
					'Castlevania - Order of Ecclesia',
					'Professor Layton and the Curious Village',
					'Professor Layton and the Unwound Future',
					'Phoenix Wright - Ace Attorney',
					'Ghost Trick - Phantom Detective',
					'Kirby Super Star Ultra',
					'Metroid Prime Hunters',
					'Advance Wars - Days of Ruin'
				],
				'PSP': [
					'God of War - Chains of Olympus',
					'God of War - Ghost of Sparta',
					'Metal Gear Solid - Peace Walker',
					'Grand Theft Auto - Liberty City Stories',
					'Grand Theft Auto - Vice City Stories',
					'Final Fantasy Tactics - The War of the Lions',
					'Crisis Core - Final Fantasy VII',
					'Persona 3 Portable',
					'Tactics Ogre - Let Us Cling Together',
					'Daxter',
					'Ratchet & Clank - Size Matters',
					'Lumines',
					'Patapon',
					'Patapon 2',
					'LocoRoco',
					'LocoRoco 2',
					'Monster Hunter Freedom Unite',
					'Tekken - Dark Resurrection',
					'Soulcalibur - Broken Destiny',
					'Disgaea - Afternoon of Darkness',
					'Valkyria Chronicles II',
					'Jeanne d\'Arc',
					'Ys Seven',
					'Killzone - Liberation',
					'Resistance - Retribution'
				],
				'Saturn': [
					'Panzer Dragoon Saga',
					'Panzer Dragoon Zwei',
					'Panzer Dragoon',
					'NiGHTS Into Dreams',
					'Guardian Heroes',
					'Radiant Silvergun',
					'Shining Force III',
					'Burning Rangers',
					'Saturn Bomberman',
					'Virtua Fighter 2',
					'Virtua Cop',
					'Virtua Cop 2',
					'Sega Rally Championship',
					'Daytona USA',
					'Sonic Jam',
					'Sonic R',
					'Fighters Megamix',
					'Fighting Vipers',
					'Die Hard Arcade',
					'The House of the Dead',
					'Grandia',
					'Lunar - Silver Star Story Complete',
					'Resident Evil',
					'Street Fighter Alpha 2',
					'Marvel vs. Capcom'
				],
				'Dreamcast': [
					'Sonic Adventure',
					'Sonic Adventure 2',
					'Shenmue',
					'Shenmue II',
					'Jet Grind Radio',
					'Crazy Taxi',
					'Crazy Taxi 2',
					'SoulCalibur',
					'Marvel vs. Capcom 2',
					'Power Stone',
					'Power Stone 2',
					'Resident Evil - Code Veronica',
					'Skies of Arcadia',
					'Grandia II',
					'Phantasy Star Online',
					'Ikaruga',
					'Bangai-O',
					'Rez',
					'Space Channel 5',
					'Seaman',
					'Samba de Amigo',
					'Virtua Tennis',
					'NFL 2K1',
					'Tony Hawk\'s Pro Skater 2',
					'Dead or Alive 2'
				],
				'Sega CD': [
					'Sonic CD',
					'Snatcher',
					'Lunar - The Silver Star',
					'Lunar - Eternal Blue',
					'Silpheed',
					'Popful Mail',
					'Shining Force CD',
					'Vay',
					'Final Fight CD',
					'Robo Aleste',
					'Lords of Thunder',
					'Keio Flying Squadron',
					'The Ninja Warriors',
					'Batman Returns',
					'Ecco the Dolphin',
					'Ecco - The Tides of Time',
					'Heart of the Alien',
					'Earthworm Jim - Special Edition',
					'Mansion of Hidden Souls',
					'Night Trap',
					'Sewer Shark',
					'Ground Zero Texas',
					'Fahrenheit',
					'Dark Wizard',
					'Mickey Mania'
				],
				'Sega 32X': [
					'Knuckles\' Chaotix',
					'Kolibri',
					'Star Wars Arcade',
					'Virtua Fighter',
					'Virtua Racing Deluxe',
					'Doom',
					'After Burner Complete',
					'Shadow Squadron',
					'Metal Head',
					'Tempo',
					'Zaxxon\'s Motherbase 2000',
					'Blackthorne',
					'NBA Jam Tournament Edition',
					'Mortal Kombat II',
					'WWF WrestleMania - The Arcade Game',
					'Space Harrier',
					'Star Trek - Starfleet Academy',
					'Golf Magazine - 36 Great Holes',
					'Motocross Championship',
					'Pitfall - The Mayan Adventure',
					'Primal Rage',
					'RBI Baseball \'95',
					'Spider-Man - Web of Fire',
					'Surgical Strike',
					'Cosmic Carnage'
				],
				'Atari 5200': [
					'Pitfall II - Lost Caverns',
					'Pengo',
					'Moon Patrol',
					'Jungle Hunt',
					'Joust',
					'Robotron - 2084',
					'Ms. Pac-Man',
					'Pac-Man',
					'Dig Dug',
					'Centipede',
					'Defender',
					'Missile Command',
					'Galaxian',
					'Frogger',
					'Gyruss',
					'Pole Position',
					'Space Invaders',
					'Berzerk',
					'Qix',
					'Kangaroo',
					'Wizard of Wor',
					'Star Raiders',
					'Choplifter',
					'Bounty Bob Strikes Back',
					'Jr. Pac-Man'
				],
				'Atari 7800': [
					'Alien Brigade',
					'Asteroids',
					'Basketbrawl',
					'Centipede',
					'Choplifter',
					'Commando',
					'Dark Chambers',
					'Dig Dug',
					'Donkey Kong',
					'Donkey Kong Junior',
					'Food Fight',
					'Galaga',
					'Ikari Warriors',
					'Joust',
					'Mario Bros.',
					'Mat Mania Challenge',
					'Ms. Pac-Man',
					'Ninja Golf',
					'Pole Position II',
					'Rampage',
					'Robotron - 2084',
					'Scrapyard Dog',
					'Xevious',
					'Double Dragon',
					'Tower Toppler'
				],
				'Virtual Boy': [
					'Wario Land',
					'Mario\'s Tennis',
					'Teleroboxer',
					'Red Alarm',
					'Galactic Pinball',
					'Mario Clash',
					'Panic Bomber',
					'Vertical Force',
					'Jack Bros.',
					'3D Tetris',
					'Golf',
					'V-Tetris',
					'Nester\'s Funky Bowling',
					'Waterworld',
					'Space Invaders Virtual Collection'
				],
				'Coleco': [
					'Donkey Kong',
					'Ladybug',
					'Mouse Trap',
					'Zaxxon',
					'Venture',
					'Smurfs, The',
					'Cosmic Avenger',
					'Frogger',
					'Q*bert',
					'Burgertime',
					'Carnival',
					'Centipede',
					'Dig Dug',
					'Donkey Kong Jr.',
					'Frontline',
					'Gorf',
					'Jumpman Junior',
					'Looping',
					'Montezuma\'s Revenge',
					'Mr. Do!',
					'Pitfall!',
					'Popeye',
					'River Raid',
					'Smurf - Rescue in Gargamel\'s Castle',
					'Space Panic'
				],
				'Intellivision': [
					'Advanced Dungeons & Dragons',
					'TRON - Deadly Discs',
					'BurgerTime',
					'Astrosmash',
					'Sea Battle',
					'Space Armada',
					'Night Stalker',
					'Thunder Castle',
					'Advanced Dungeons & Dragons - Treasure of Tarmin',
					'B-17 Bomber',
					'Beauty & The Beast',
					'Bump \'N\' Jump',
					'Demon Attack',
					'Frog Bog',
					'Microsurgeon',
					'Mission X',
					'Mouse Trap',
					'Q*bert',
					'Snafu',
					'Space Battle',
					'Space Hawk',
					'Sub Hunt',
					'Tower of Doom',
					'Utopia',
					'Vectron'
				],
				'Vectrex': [
					'Armor Attack',
					'Berzerk',
					'Cosmic Chasm',
					'Fortress of Narzod',
					'Hyperchase',
					'Mine Storm',
					'Pole Position',
					'Rip Off',
					'Solar Quest',
					'Space Wars',
					'Spike',
					'Star Castle',
					'Star Trek',
					'Web Wars',
					'Bedlam',
					'Blitz!',
					'Clean Sweep',
					'Engine Analyzer',
					'Heads Up',
					'Scramble',
					'Star Hawk',
					'Spinball',
					'Starhawk',
					'Tour De France',
					'Vectrex Baseball'
				],
				'3DO': [
					'Star Control II',
					'Road Rash',
					'Super Street Fighter II Turbo',
					'Gex',
					'Need for Speed',
					'The Horde',
					'Twisted - The Game Show',
					'Crash \'N Burn',
					'Way of the Warrior',
					'Alone in the Dark',
					'D',
					'Samurai Shodown',
					'Shock Wave',
					'Return Fire',
					'Guardian War',
					'Out of This World',
					'Night Trap',
					'Dragon\'s Lair',
					'Theme Park',
					'FIFA International Soccer',
					'Blade Force',
					'Total Eclipse',
					'Quarantine',
					'Slayer',
					'Star Fighter'
				],
				'Amiga': [
					'Sensible World of Soccer',
					'Cannon Fodder',
					'Lemmings',
					'Speedball 2 - Brutal Deluxe',
					'The Secret of Monkey Island',
					'Monkey Island 2 - LeChuck\'s Revenge',
					'Another World',
					'Flashback',
					'Beneath a Steel Sky',
					'Civilization',
					'Syndicate',
					'UFO - Enemy Unknown',
					'Kick Off 2',
					'Dune II',
					'Populous',
					'Shadow of the Beast',
					'Turrican II',
					'Stunt Car Racer',
					'Rainbow Islands',
					'The Chaos Engine',
					'Worms',
					'Pinball Dreams',
					'Gods',
					'Xenon 2 - Megablast',
					'It Came from the Desert'
				],
				'Commodore 64': [
					'The Last Ninja',
					'Boulder Dash',
					'Impossible Mission',
					'Maniac Mansion',
					'Pirates!',
					'Wizball',
					'Turrican',
					'R-Type',
					'International Karate +',
					'Bubble Bobble',
					'Paradroid',
					'The Great Giana Sisters',
					'Jet Set Willy',
					'Elite',
					'Mayhem in Monsterland',
					'Summer Games',
					'California Games',
					'Wasteland',
					'M.U.L.E.',
					'Ghostbusters',
					'Bruce Lee',
					'Prince of Persia',
					'Laser Squad',
					'Raid on Bungeling Bay',
					'Archon'
				]
			};

			// IndexedDB for persisting directory handle and device
			const DB_NAME = 'NanoArcade';
			const DB_VERSION = 2;
			const STORE_NAME = 'handles';

			function openDB() {
				return new Promise((resolve, reject) => {
					const request = indexedDB.open(DB_NAME, DB_VERSION);
					request.onerror = () => reject(request.error);
					request.onsuccess = () => resolve(request.result);
					request.onupgradeneeded = (e) => {
						const db = e.target.result;
						if (!db.objectStoreNames.contains(STORE_NAME)) {
							db.createObjectStore(STORE_NAME);
						}
					};
				});
			}

			async function saveHandle(handle) {
				const db = await openDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction(STORE_NAME, 'readwrite');
					tx.objectStore(STORE_NAME).put(handle, 'directoryHandle');
					tx.oncomplete = () => resolve();
					tx.onerror = () => reject(tx.error);
				});
			}

			async function saveDevice(device) {
				const db = await openDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction(STORE_NAME, 'readwrite');
					tx.objectStore(STORE_NAME).put(device, 'deviceType');
					tx.oncomplete = () => resolve();
					tx.onerror = () => reject(tx.error);
				});
			}

			async function getSavedHandle() {
				const db = await openDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction(STORE_NAME, 'readonly');
					const request = tx.objectStore(STORE_NAME).get('directoryHandle');
					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(request.error);
				});
			}

			async function getSavedDevice() {
				const db = await openDB();
				return new Promise((resolve, reject) => {
					const tx = db.transaction(STORE_NAME, 'readonly');
					const request = tx.objectStore(STORE_NAME).get('deviceType');
					request.onsuccess = () => resolve(request.result || 'rgnano');
					request.onerror = () => reject(request.error);
				});
			}

			async function tryRestoreHandle() {
				try {
					const savedDevice = await getSavedDevice();
					if (savedDevice) {
						currentDevice = savedDevice;
					}
					const savedHandle = await getSavedHandle();
					if (savedHandle) {
						// Request permission on the saved handle
						const permission = await savedHandle.requestPermission({ mode: 'readwrite' });
						if (permission === 'granted') {
							directoryHandle = savedHandle;
							updateDeviceIndicator();
							await scanExistingDirectory();
							return true;
						}
					}
				} catch (e) {
					// Handle could not be restored (permission denied or directory moved)
				}
				return false;
			}

			function updateDeviceIndicator() {
				const profile = deviceProfiles[currentDevice];
				const indicator = document.getElementById('deviceIndicator');
				if (indicator) {
					indicator.innerHTML = `<span class="device-emoji">${profile.emoji}</span> ${profile.name}`;
					indicator.style.display = 'flex';
				}
			}

			// Show device selection modal
			function showDeviceSelector() {
				document.getElementById('deviceModal').classList.add('active');
			}

			// Select device and continue with folder scan
			async function selectDevice(deviceType) {
				currentDevice = deviceType;
				await saveDevice(deviceType);
				closeModal('deviceModal');
				updateDeviceIndicator();

				// Clear existing handle and always open folder picker
				directoryHandle = null;
				consoles = {};
				renderConsoleList();

				// Show device-specific folder selection instructions in modal
				const profile = deviceProfiles[deviceType];
				let message = '';
				if (profile.catalogueStructure) {
					// Trimui Brick / Mustard OS
					message = 'Please select the <strong>ROOT of your SD card</strong> (the folder containing the MUOS folder)';
				} else if (profile.emoji === 'üßÖ') {
					// Miyoo devices with Onion OS - select root so we can access Saves folder too
					message = 'Please select the <strong>ROOT of your SD card</strong><br><small style="color: rgba(255,255,255,0.6);">The folder containing Roms, Saves, RetroArch, etc.</small>';
				} else if (deviceType === 'rgnano') {
					// RG Nano with Drum78 CFW
					message = 'Please select the <strong>ROOT of your SD card</strong><br><small style="color: rgba(255,255,255,0.6);">Your system folders (GB, GBA, NES, etc.) should be at the root level</small>';
				} else {
					// Generic device
					message = 'Please select your <strong>ROMs folder</strong> (the folder containing your console subfolders like GB, GBA, SNES, etc.)';
				}
				document.getElementById('folderInstructionText').innerHTML = message;
				document.getElementById('folderInstructionsModal').classList.add('active');
			}

			async function closeInstructionsAndScan() {
				closeModal('folderInstructionsModal');
				await scanDrive();
			}

			async function scanExistingDirectory() {
				if (!directoryHandle) return;
				consoles = {};
				const profile = deviceProfiles[currentDevice];
				const usesImgsFolder = profile.emoji === 'üßÖ'; // Onion OS devices use Imgs subfolder
				const usesCatalogueStructure = profile.catalogueStructure === true; // Trimui Brick / Mustard OS

				if (usesCatalogueStructure) {
					// MustardOS: ROMs in ROMS/<folder>/, box art in MUOS/info/catalogue/<system>/box/
					// Mapping from common ROM folder names to MustardOS catalogue system names
					const muosCatalogueMap = {
						'gba': 'Nintendo Game Boy Advance',
						'gb': 'Nintendo Game Boy',
						'gbc': 'Nintendo Game Boy',
						'nds': 'Nintendo DS',
						'ds': 'Nintendo DS',
						'nes': 'Nintendo NES - Famicom',
						'fc': 'Nintendo NES - Famicom',
						'famicom': 'Nintendo NES - Famicom',
						'snes': 'Nintendo SNES - SFC',
						'sfc': 'Nintendo SNES - SFC',
						'md': 'Sega Mega Drive - Genesis',
						'genesis': 'Sega Mega Drive - Genesis',
						'megadrive': 'Sega Mega Drive - Genesis',
						'ps': 'Sony PlayStation',
						'ps1': 'Sony PlayStation',
						'psx': 'Sony PlayStation',
						'playstation': 'Sony PlayStation',
						'pico': 'Sega Pico',
						'n64': 'Nintendo N64',
						'arcade': 'Arcade',
						'cps1': 'Arcade',
						'cps2': 'Arcade',
						'cps3': 'Arcade',
						'neogeo': 'SNK Neo Geo',
						'pce': 'NEC PC Engine - TurboGrafx 16',
						'pcengine': 'NEC PC Engine - TurboGrafx 16',
						'gg': 'Sega Game Gear',
						'gamegear': 'Sega Game Gear',
						'sms': 'Sega Master System',
						'mastersystem': 'Sega Master System',
						'scummvm': 'ScummVM',
						'fds': 'Nintendo Famicom Disk System',
						'vb': 'Nintendo Virtual Boy',
						'virtualboy': 'Nintendo Virtual Boy',
						'pokemini': 'Nintendo Pokemon Mini',
						'wswan': 'Bandai WonderSwan',
						'wswanc': 'Bandai WonderSwan Color',
						'ngp': 'SNK Neo Geo Pocket',
						'ngpc': 'SNK Neo Geo Pocket Color',
						'atari2600': 'Atari 2600',
						'atari7800': 'Atari 7800',
						'lynx': 'Atari Lynx',
						'coleco': 'ColecoVision',
						'msx': 'Microsoft MSX',
						'vectrex': 'GCE Vectrex'
					};

					try {
						// Get ROMS folder
						let romsDir;
						try {
							romsDir = await directoryHandle.getDirectoryHandle('ROMS');
						} catch {
							// Try lowercase
							romsDir = await directoryHandle.getDirectoryHandle('roms');
						}

						// Get catalogue directory for box art
						let catalogueDir = null;
						try {
							const muosDir = await directoryHandle.getDirectoryHandle('MUOS');
							const infoDir = await muosDir.getDirectoryHandle('info');
							catalogueDir = await infoDir.getDirectoryHandle('catalogue');
						} catch {
							// Catalogue not found, will work without box art
						}

						// Scan ROMS folder for system subfolders
						for await (const romFolderEntry of romsDir.values()) {
							if (romFolderEntry.kind === 'directory') {
								const folderName = romFolderEntry.name;
								const games = [];

								try {
									const romFolder = await romsDir.getDirectoryHandle(folderName);

									// Find matching catalogue system for box art
									const catalogueName = muosCatalogueMap[folderName.toLowerCase()] || folderName;
									let boxDir = null;
									if (catalogueDir) {
										try {
											const catalogueSystemDir = await catalogueDir.getDirectoryHandle(catalogueName);
											boxDir = await catalogueSystemDir.getDirectoryHandle('box');
										} catch {
											// Try exact folder name as fallback
											try {
												const catalogueSystemDir = await catalogueDir.getDirectoryHandle(folderName);
												boxDir = await catalogueSystemDir.getDirectoryHandle('box');
											} catch {}
										}
									}

									// Scan for ROM files
									for await (const file of romFolder.values()) {
										if (file.kind === 'file') {
											if (!file.name.includes('.')) continue;
											const ext = '.' + file.name.split('.').pop().toLowerCase();
											const skipExts = ['.png', '.jpg', '.jpeg', '.txt', '.cue', '.m3u', '.srm', '.sav', '.xml', '.json', '.db', '.cfg'];
											const skipNames = ['gamelist', 'miyoogamelist'];
											const lowerName = file.name.toLowerCase();
											const isSkipName = skipNames.some(s => lowerName.startsWith(s));

											if (!skipExts.includes(ext) && !isSkipName) {
												const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
												let hasImage = false;
												let imageExt = null;

												// Check for existing images in box folder
												if (boxDir) {
													try {
														await boxDir.getFileHandle(baseName + '.png');
														hasImage = true;
														imageExt = '.png';
													} catch {
														try {
															await boxDir.getFileHandle(baseName + '.jpg');
															hasImage = true;
															imageExt = '.jpg';
														} catch {}
													}
												}
												games.push({ name: file.name, baseName, hasImage, imageExt });
											}
										}
									}

									if (games.length > 0) {
										// Use a display name based on catalogue or folder name
										const displayName = catalogueName !== folderName ? catalogueName : folderName;
										consoles[displayName] = {
											handle: romFolder,
											boxHandle: boxDir,
											catalogueName: catalogueName,
											romFolderName: folderName,
											games: games.sort((a, b) => a.baseName.localeCompare(b.baseName))
										};
									}
								} catch (e) { /* Could not access ROM folder */ }
							}
						}
					} catch (e) {
						showError('ROMS folder not found. Please select the root of your SD card (the folder containing both ROMS and MUOS folders).');
						return;
					}
				} else {
					// Standard scanning for other devices
					// Skip folders that are apps/system folders, not console ROM folders
					const skipFolders = [
						'funkey', '.picoarch', 'wolfenstein 3d', 'doom', 'quake',
						'system', 'bios', 'save', 'saves', 'config', 'retroarch',
						'app', 'miyoo', 'retroarch', 'themes', 'media', 'emu', 'screenshots', 'icons', '.tmp_update'
					];

					// For Onion OS devices, scan the Roms subfolder instead of root
					let scanDir = directoryHandle;
					if (usesImgsFolder) {
						try {
							scanDir = await directoryHandle.getDirectoryHandle('Roms');
						} catch {
							try {
								scanDir = await directoryHandle.getDirectoryHandle('ROMS');
							} catch {
								try {
									scanDir = await directoryHandle.getDirectoryHandle('roms');
								} catch {
									showError('Roms folder not found. Please select the root of your SD card (the folder containing Roms, Saves, RetroArch, etc.).');
									return;
								}
							}
						}
					}

					for await (const entry of scanDir.values()) {
						if (entry.kind === 'directory') {
							const consoleName = entry.name;
							// Skip known non-console folders
							if (skipFolders.includes(consoleName.toLowerCase())) continue;

							const games = [];
							try {
								const consoleDir = await scanDir.getDirectoryHandle(consoleName);
								// Check for Imgs subfolder (Onion OS style)
								let imgsDir = null;
								if (usesImgsFolder) {
									try {
										imgsDir = await consoleDir.getDirectoryHandle('Imgs');
									} catch {}
								}
								const imageDir = imgsDir || consoleDir;

								for await (const file of consoleDir.values()) {
									if (file.kind === 'file') {
										// Skip files without extensions (cache files, etc)
										if (!file.name.includes('.')) continue;
										const ext = '.' + file.name.split('.').pop().toLowerCase();
										// Skip non-ROM files: images, metadata, saves, cache files
										const skipExts = ['.png', '.jpg', '.jpeg', '.txt', '.cue', '.m3u', '.srm', '.sav', '.xml', '.json', '.db'];
										const skipNames = ['gamelist', 'miyoogamelist'];
										const lowerName = file.name.toLowerCase();
										const isSkipName = skipNames.some(s => lowerName.startsWith(s));
										if (!skipExts.includes(ext) && !isSkipName) {
											const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
											let hasImage = false;
											let imageExt = null;
											try {
												await imageDir.getFileHandle(baseName + '.png');
												hasImage = true;
												imageExt = '.png';
											} catch {
												try {
													await imageDir.getFileHandle(baseName + '.jpg');
													hasImage = true;
													imageExt = '.jpg';
												} catch {}
											}
											games.push({ name: file.name, baseName, hasImage, imageExt });
										}
									}
								}
								if (games.length > 0) {
									consoles[consoleName] = {
										handle: consoleDir,
										imgsHandle: imgsDir,
										games: games.sort((a, b) => a.baseName.localeCompare(b.baseName))
									};
								}
							} catch (e) { /* Could not access directory */ }
						}
					}
				}
				renderConsoleList();
				updateStats();
			}

			// Try to restore on page load
			window.addEventListener('DOMContentLoaded', async () => {
				await tryRestoreHandle();
			});

			// Console icons mapping
			const consoleIcons = {
				// Nintendo handhelds
				'game boy': 'icons/gb.png',
				'gb': 'icons/gb.png',
				'game boy color': 'icons/gbc.png',
				'gbc': 'icons/gbc.png',
				'game boy advance': 'icons/gba.png',
				'gba': 'icons/gba.png',
				'super game boy': 'icons/sgb.png',
				'sgb': 'icons/sgb.png',
				'nds': 'icons/nds.png',
				'nintendo ds': 'icons/nds.png',
				'ds': 'icons/nds.png',
				'virtual boy': 'icons/vb.png',
				'vb': 'icons/vb.png',
				// Nintendo consoles
				'nes': 'icons/fc.png',
				'famicom': 'icons/fc.png',
				'fc': 'icons/fc.png',
				'fds': 'icons/fds.png',
				'famicom disk system': 'icons/fds.png',
				'snes': 'icons/sfc.png',
				'super nintendo': 'icons/sfc.png',
				'super famicom': 'icons/sfc.png',
				'sfc': 'icons/sfc.png',
				'n64': 'icons/n64.png',
				'nintendo 64': 'icons/n64.png',
				// Sega
				'sega master system': 'icons/ms.png',
				'master system': 'icons/ms.png',
				'sms': 'icons/ms.png',
				'ms': 'icons/ms.png',
				'sega genesis': 'icons/md.png',
				'genesis': 'icons/md.png',
				'mega drive': 'icons/md.png',
				'md': 'icons/md.png',
				'sega cd': 'icons/segacd.png',
				'segacd': 'icons/segacd.png',
				'32x': 'icons/32x.png',
				'sega 32x': 'icons/32x.png',
				'dreamcast': 'icons/dc.png',
				'dc': 'icons/dc.png',
				'game gear': 'icons/gg.png',
				'gg': 'icons/gg.png',
				'gamegear': 'icons/gg.png',
				// Sony
				'playstation': 'icons/ps.png',
				'ps1': 'icons/ps.png',
				'psx': 'icons/ps.png',
				'ps': 'icons/ps.png',
				'psp': 'icons/psp.png',
				// NEC
				'pce': 'icons/pce.png',
				'pce-turbografx': 'icons/pce.png',
				'turbografx': 'icons/pce.png',
				'pc engine': 'icons/pce.png',
				'pcengine': 'icons/pce.png',
				'pce cd': 'icons/pcecd.png',
				'pcecd': 'icons/pcecd.png',
				'supergrafx': 'icons/sgfx.png',
				'sgfx': 'icons/sgfx.png',
				// SNK
				'neo geo': 'icons/neogeo.png',
				'neogeo': 'icons/neogeo.png',
				'neo geo cd': 'icons/neocd.png',
				'neocd': 'icons/neocd.png',
				'neo geo pocket': 'icons/ngp.png',
				'ngp': 'icons/ngp.png',
				'neo geo pocket color': 'icons/ngpc.png',
				'ngpc': 'icons/ngpc.png',
				// Atari
				'atari 2600': 'icons/atari.png',
				'atari2600': 'icons/atari.png',
				'atari 5200': 'icons/5200.png',
				'atari5200': 'icons/5200.png',
				'a5200': 'icons/5200.png',
				'atari 7800': 'icons/7800.png',
				'atari7800': 'icons/7800.png',
				'a7800': 'icons/7800.png',
				'atari lynx': 'icons/lynx.png',
				'lynx': 'icons/lynx.png',
				'atarilynx': 'icons/lynx.png',
				'atari 800': 'icons/atari800.png',
				'atari800': 'icons/atari800.png',
				'atari st': 'icons/atarist.png',
				'atarist': 'icons/atarist.png',
				// Bandai
				'wonderswan': 'icons/ws.png',
				'ws': 'icons/ws.png',
				'wonderswan color': 'icons/wsc.png',
				'wsc': 'icons/wsc.png',
				// Arcade
				'arcade': 'icons/arcade.png',
				'mame': 'icons/mame.png',
				'fba': 'icons/arcade.png',
				'fbneo': 'icons/arcade.png',
				'cps1': 'icons/cps1.png',
				'cps2': 'icons/cps2.png',
				'cps3': 'icons/cps3.png',
				// Computers
				'amiga': 'icons/amiga.png',
				'c64': 'icons/c64.png',
				'commodore 64': 'icons/c64.png',
				'dos': 'icons/dos.png',
				'dosbox': 'icons/dos.png',
				'msx': 'icons/msx.png',
				'x68000': 'icons/x68000.png',
				'zx spectrum': 'icons/zxs.png',
				'zxs': 'icons/zxs.png',
				'amstrad cpc': 'icons/cpc.png',
				'cpc': 'icons/cpc.png',
				// Other consoles
				'colecovision': 'icons/col.png',
				'col': 'icons/col.png',
				'intellivision': 'icons/itv.png',
				'intv': 'icons/itv.png',
				'itv': 'icons/itv.png',
				'vectrex': 'icons/vectrex.png',
				'odyssey': 'icons/ody.png',
				'ody': 'icons/ody.png',
				'fairchild': 'icons/fairchild.png',
				'channel f': 'icons/fairchild.png',
				// Misc
				'pico-8': 'icons/pico.png',
				'pico8': 'icons/pico.png',
				'pico': 'icons/pico.png',
				'pokemon mini': 'icons/poke.png',
				'pokemini': 'icons/poke.png',
				'poke': 'icons/poke.png',
				'game & watch': 'icons/gw.png',
				'gw': 'icons/gw.png',
				'arduboy': 'icons/arduboy.png',
				'scummvm': 'icons/scummvm.png',
				'openbor': 'icons/openbor.png',
				'tic-80': 'icons/tic.png',
				'tic80': 'icons/tic.png',
				'doom': 'icons/doom.png',
				'quake': 'icons/quake.png',
				'wolfenstein': 'icons/wolf.png',
				'supervision': 'icons/supervision.png',
				'megaduck': 'icons/megaduck.png',
				'ports': 'icons/ports.png',
				'default': 'icons/arcade.png'
			};

			// List of known gaming consoles (only these show in Consoles section)
			const knownConsoles = [
				// Nintendo
				'game boy', 'gb', 'game boy color', 'gbc', 'game boy advance', 'gba',
				'super game boy', 'sgb', 'virtual boy', 'vb',
				'nes', 'famicom', 'fc', 'fds', 'snes', 'super nintendo', 'super famicom', 'sfc',
				'n64', 'nintendo 64', 'nds', 'nintendo ds', 'ds',
				// Sega
				'sega master system', 'master system', 'sms', 'ms',
				'sega genesis', 'genesis', 'mega drive', 'md', 'sega cd', 'segacd', '32x',
				'dreamcast', 'dc', 'game gear', 'gg', 'gamegear',
				// Sony
				'playstation', 'ps1', 'psx', 'ps', 'psp',
				// NEC
				'pce', 'pce-turbografx', 'turbografx', 'pc engine', 'pcengine', 'pcecd', 'supergrafx', 'sgfx',
				// SNK
				'arcade', 'mame', 'fba', 'fbneo', 'cps1', 'cps2', 'cps3',
				'neo geo', 'neogeo', 'neocd', 'neo geo pocket', 'ngp', 'ngpc',
				// Atari
				'atari lynx', 'lynx', 'atarilynx', 'atari 2600', 'atari2600', 'atari 5200', 'a5200',
				'atari 7800', 'atari7800', 'a7800', 'atari 800', 'atari800', 'atari st', 'atarist',
				// Bandai
				'wonderswan', 'ws', 'wonderswan color', 'wsc',
				// Computers
				'amiga', 'c64', 'commodore 64', 'dos', 'dosbox', 'msx', 'x68000', 'zx spectrum', 'zxs', 'amstrad cpc', 'cpc',
				// Other
				'colecovision', 'col', 'intellivision', 'intv', 'itv', 'vectrex', 'odyssey', 'ody', 'fairchild', 'channel f',
				'pico-8', 'pico8', 'pico', 'pokemon mini', 'pokemini', 'poke',
				'game & watch', 'gw', 'arduboy', 'scummvm', 'openbor', 'tic-80', 'tic80',
				'doom', 'quake', 'wolfenstein', 'supervision', 'megaduck', 'ports'
			];

			function isConsole(name) {
				const lower = name.toLowerCase();
				return knownConsoles.some(c => lower === c || lower.includes(c) || c.includes(lower));
			}

			function getConsoleIcon(consoleName) {
				const lowerName = consoleName.toLowerCase();
				if (consoleIcons[lowerName]) return consoleIcons[lowerName];
				for (const [key, iconPath] of Object.entries(consoleIcons)) {
					if (key !== 'default' && (lowerName.includes(key) || key.includes(lowerName))) {
						return iconPath;
					}
				}
				return consoleIcons['default'];
			}

			// Display names for console folders (abbreviation -> full name)
			const consoleDisplayNames = {
				'gb': 'Game Boy',
				'gbc': 'Game Boy Color',
				'gba': 'Game Boy Advance',
				'sgb': 'Super Game Boy',
				'nes': 'NES',
				'fc': 'Famicom',
				'fds': 'Famicom Disk System',
				'snes': 'SNES',
				'sfc': 'Super Famicom',
				'n64': 'Nintendo 64',
				'nds': 'Nintendo DS',
				'ds': 'Nintendo DS',
				'vb': 'Virtual Boy',
				'ms': 'Master System',
				'sms': 'Master System',
				'md': 'Mega Drive',
				'genesis': 'Genesis',
				'gg': 'Game Gear',
				'gamegear': 'Game Gear',
				'dc': 'Dreamcast',
				'segacd': 'Sega CD',
				'32x': 'Sega 32X',
				'ps': 'PlayStation',
				'psx': 'PlayStation',
				'ps1': 'PlayStation',
				'psp': 'PSP',
				'pce': 'PC Engine',
				'pcengine': 'PC Engine',
				'pcecd': 'PC Engine CD',
				'sgfx': 'SuperGrafx',
				'neogeo': 'Neo Geo',
				'neocd': 'Neo Geo CD',
				'ngp': 'Neo Geo Pocket',
				'ngpc': 'Neo Geo Pocket Color',
				'arcade': 'Arcade',
				'mame': 'Arcade (MAME)',
				'fbneo': 'Arcade (FBNeo)',
				'cps1': 'CPS1',
				'cps2': 'CPS2',
				'cps3': 'CPS3',
				'lynx': 'Atari Lynx',
				'atarilynx': 'Atari Lynx',
				'atari2600': 'Atari 2600',
				'a5200': 'Atari 5200',
				'atari5200': 'Atari 5200',
				'a7800': 'Atari 7800',
				'atari7800': 'Atari 7800',
				'atari800': 'Atari 800',
				'atarist': 'Atari ST',
				'ws': 'WonderSwan',
				'wsc': 'WonderSwan Color',
				'col': 'ColecoVision',
				'colecovision': 'ColecoVision',
				'intv': 'Intellivision',
				'itv': 'Intellivision',
				'vectrex': 'Vectrex',
				'ody': 'Odyssey',
				'fairchild': 'Fairchild Channel F',
				'amiga': 'Amiga',
				'c64': 'Commodore 64',
				'dos': 'DOS',
				'msx': 'MSX',
				'x68000': 'X68000',
				'zxs': 'ZX Spectrum',
				'cpc': 'Amstrad CPC',
				'pico': 'PICO-8',
				'pico8': 'PICO-8',
				'poke': 'Pokemon Mini',
				'pokemini': 'Pokemon Mini',
				'gw': 'Game & Watch',
				'arduboy': 'Arduboy',
				'scummvm': 'ScummVM',
				'openbor': 'OpenBOR',
				'tic': 'TIC-80',
				'doom': 'Doom',
				'quake': 'Quake',
				'supervision': 'Supervision',
				'megaduck': 'Mega Duck',
				'ports': 'Ports'
			};

			function getConsoleDisplayName(folderName) {
				const lower = folderName.toLowerCase();
				return consoleDisplayNames[lower] || folderName;
			}

			// Name cleanup patterns
			const cleanupPatterns = [
				/\s*\(USA\)/gi, /\s*\(Europe\)/gi, /\s*\(Japan\)/gi, /\s*\(World\)/gi,
				/\s*\(USA,\s*Europe\)/gi, /\s*\(En,?[A-Za-z,\s]*\)/gi,
				/\s*\(Rev\s*\d*\)/gi, /\s*\(SGB Enhanced\)/gi, /\s*\(GB Compatible\)/gi,
				/\s*\[!\]/gi, /\s*\[C\]/gi, /\s*\(V?\d+\.\d+\)/gi,
				/\s*\(Hack[^)]*\)/gi, /\s*\(Beta[^)]*\)/gi, /\s*\(Proto[^)]*\)/gi,
				/\s*\(Unl\)/gi, /\s*\(PD\)/gi, /\s*\(M\d+\)/gi, /\s+/g,
			];

			function cleanGameName(filename) {
				let name = filename;
				const lastDot = name.lastIndexOf('.');
				const ext = lastDot > 0 ? name.substring(lastDot) : '';
				name = lastDot > 0 ? name.substring(0, lastDot) : name;
				for (const pattern of cleanupPatterns) {
					name = name.replace(pattern, pattern.source === '\\s+' ? ' ' : '');
				}
				return name.trim() + ext;
			}

			async function scanDrive() {
				try {
					const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
					directoryHandle = handle;
					await saveHandle(directoryHandle);
					await scanExistingDirectory();
				} catch (e) {
					// User cancelled the folder picker - don't show error
					if (e.name === 'AbortError') {
						return;
					}
					// Show error modal for other errors
					showError('Error scanning directory: ' + e.message);
				}
			}

			function showError(message) {
				document.getElementById('errorMessage').textContent = message;
				document.getElementById('errorModal').classList.add('active');
			}

			function renderConsoleList() {
				const list = document.getElementById('consoleList');
				const allFolders = Object.keys(consoles).sort();
				const consoleFolders = allFolders.filter(n => isConsole(n));

				// Calculate total games and missing across all consoles
				let totalGames = 0, totalMissing = 0;
				for (const name of consoleFolders) {
					totalGames += consoles[name].games.length;
					totalMissing += consoles[name].games.filter(g => !g.hasImage).length;
				}

				let html = '<li><a href="javascript:void(0)" onclick="showHome()"><span class="icon solid fa-home"></span> Home</a></li>';

				// Add "All Games" option if there are any games
				if (totalGames > 0) {
					html += `<li><a href="javascript:void(0)" onclick="selectAllGames()">
						<span class="icon solid fa-gamepad" style="margin-right: 8px;"></span>
						<span>All Games</span>
						<span class="game-count">${totalGames}${totalMissing > 0 ? ' <span class="warning">!' + totalMissing + '</span>' : ''}</span>
					</a></li>`;
				}

				// Console entries only
				for (const name of consoleFolders) {
					const count = consoles[name].games.length;
					const missing = consoles[name].games.filter(g => !g.hasImage).length;
					const icon = getConsoleIcon(name);
					const displayName = getConsoleDisplayName(name);
					html += `<li><a href="javascript:void(0)" onclick="selectConsole('${name.replace(/'/g, "\\'")}')">
						<img src="${icon}" class="console-icon" alt="${displayName}">
						<span>${displayName}</span>
						<span class="game-count">${count}${missing > 0 ? ' <span class="warning">!' + missing + '</span>' : ''}</span>
					</a></li>`;
				}

				list.innerHTML = html;

				const uploadSelect = document.getElementById('uploadConsoleSelect');
				uploadSelect.innerHTML = '<option value="">Select a console...</option>' +
					allFolders.map(n => `<option value="${n}">${getConsoleDisplayName(n)}</option>`).join('');
			}

			function updateStats() {
				let games = 0, missing = 0, consoleCount = 0;
				for (const [name, c] of Object.entries(consoles)) {
					if (isConsole(name)) {
						consoleCount++;
						games += c.games.length;
						missing += c.games.filter(g => !g.hasImage).length;
					}
				}
				document.getElementById('statConsoles').textContent = consoleCount;
				document.getElementById('statGames').textContent = games;
				document.getElementById('statMissing').textContent = missing;
				document.getElementById('statsRow').style.display = 'flex';
			}

			async function selectConsole(name) {
				currentConsole = name;
				const displayName = getConsoleDisplayName(name);
				document.getElementById('currentConsoleName').textContent = displayName;
				// Set console icon in header
				const iconEl = document.getElementById('currentConsoleIcon');
				iconEl.src = getConsoleIcon(name);
				iconEl.alt = displayName;
				iconEl.style.display = 'block';
				document.getElementById('floatingUpload').classList.add('visible');
				// Hide intro, show games
				document.getElementById('intro').style.display = 'none';
				document.getElementById('games').style.display = 'block';
				// Hide install button when leaving intro
				document.getElementById('installPwaBtn').style.display = 'none';
				// Show loading spinner
				const grid = document.getElementById('gamesGrid');
				grid.innerHTML = '<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading games...</div></div>';
				window.scrollTo(0, 0);
				// Small delay to let the spinner render before heavy work
				await new Promise(r => setTimeout(r, 50));
				// Update game count badge and Top 25 button visibility
				updateGameCountBadge();
				updateTop25Button();
				await renderGames();
			}

			async function selectAllGames() {
				currentConsole = '__all__';
				document.getElementById('currentConsoleName').textContent = 'All Games';
				// Hide console icon for All Games view
				document.getElementById('currentConsoleIcon').style.display = 'none';
				document.getElementById('floatingUpload').classList.add('visible');
				// Hide intro, show games, hide install button
				document.getElementById('intro').style.display = 'none';
				document.getElementById('installPwaBtn').style.display = 'none';
				document.getElementById('games').style.display = 'block';
				// Show loading spinner
				const grid = document.getElementById('gamesGrid');
				grid.innerHTML = '<div class="loading-container"><div class="spinner"></div><div class="loading-text">Loading all games...</div></div>';
				window.scrollTo(0, 0);
				// Small delay to let the spinner render before heavy work
				await new Promise(r => setTimeout(r, 50));
				// Update game count badge and hide Top 25 button for All Games view
				updateGameCountBadge();
				updateTop25Button();
				await renderGames();
			}

			async function goToAllGames(showMissingOnly) {
				// Set filter state
				filterMissingOnly = showMissingOnly;
				const btn = document.getElementById('filterMissingBtn');
				if (filterMissingOnly) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
				// Go to all games view
				await selectAllGames();
			}

			function updateGameCountBadge() {
				let games = [];
				if (currentConsole === '__all__') {
					// Collect all games from all consoles
					const consoleFolders = Object.keys(consoles).filter(n => isConsole(n));
					for (const name of consoleFolders) {
						games = games.concat(consoles[name].games.map(g => ({...g, consoleName: name})));
					}
				} else if (currentConsole && consoles[currentConsole]) {
					games = consoles[currentConsole].games;
				} else {
					document.getElementById('gameCountBadge').style.display = 'none';
					return;
				}
				const total = games.length;
				const missing = games.filter(g => !g.hasImage).length;

				document.getElementById('totalGameCount').textContent = total;
				document.getElementById('gameCountBadge').style.display = 'inline';

				if (missing > 0) {
					document.getElementById('missingCount').textContent = missing;
					document.getElementById('missingArtCount').style.display = 'inline';
				} else {
					document.getElementById('missingArtCount').style.display = 'none';
				}
			}

			function showHome() {
				currentConsole = null;
				document.getElementById('floatingUpload').classList.remove('visible');
				// Show intro, hide games
				document.getElementById('intro').style.display = '';
				document.getElementById('games').style.display = 'none';
				document.getElementById('currentConsoleName').textContent = 'Select a console to view games';
				document.getElementById('currentConsoleIcon').style.display = 'none';
				document.getElementById('gamesGrid').innerHTML = '<p>Scan your drive to view games</p>';
				window.scrollTo(0, 0);
				// Show install button again if PWA install is available
				if (deferredPrompt) {
					document.getElementById('installPwaBtn').style.display = 'inline-flex';
				}
			}

			async function renderGames() {
				if (!currentConsole) return;
				revokeObjectURLs(); // Clean up old image URLs before re-rendering
				const grid = document.getElementById('gamesGrid');
				let games = [];

				// Handle "All Games" view
				if (currentConsole === '__all__') {
					const consoleFolders = Object.keys(consoles).filter(n => isConsole(n));
					for (const name of consoleFolders) {
						games = games.concat(consoles[name].games.map(g => ({...g, consoleName: name})));
					}
				} else if (consoles[currentConsole]) {
					games = [...consoles[currentConsole].games];
				} else {
					return;
				}

				const search = document.getElementById('searchBox').value.toLowerCase();

				// Apply search filter
				let filtered = games.filter(g => g.baseName.toLowerCase().includes(search));

				// Apply missing art filter
				if (filterMissingOnly) {
					filtered = filtered.filter(g => !g.hasImage);
				}

				// Apply sorting (A-Z or Z-A)
				if (currentSort === 'za') {
					filtered.sort((a, b) => b.baseName.localeCompare(a.baseName));
				} else {
					filtered.sort((a, b) => a.baseName.localeCompare(b.baseName));
				}

				if (!filtered.length) {
					grid.innerHTML = filterMissingOnly
						? '<p>All games have box art! Nice work!</p>'
						: '<p>No games found</p>';
					return;
				}

				const cards = await Promise.all(filtered.map(async game => {
					let imgSrc = '';
					// Get the correct handle for this game (important for "All Games" view)
					const gameConsoleName = game.consoleName || currentConsole;
					const consoleData = consoles[gameConsoleName];
					const profile = deviceProfiles[currentDevice];

					// Determine correct image handle based on device type
					let imageHandle;
					if (profile.catalogueStructure) {
						// Trimui Brick / Mustard OS: Look in box folder
						if (consoleData?.boxHandle) {
							imageHandle = consoleData.boxHandle;
						} else if (consoleData?.handle) {
							// Try to get box folder if it exists now
							try {
								const boxDir = await consoleData.handle.getDirectoryHandle('box');
								consoleData.boxHandle = boxDir;
								imageHandle = boxDir;
							} catch {
								imageHandle = consoleData.handle;
							}
						}
					} else {
						// Other devices: Imgs folder or console folder
						imageHandle = consoleData?.imgsHandle || consoleData?.handle;
					}

					if (game.hasImage && game.imageExt && imageHandle) {
						try {
							const f = await imageHandle.getFileHandle(game.baseName + game.imageExt);
							imgSrc = await createObjectURL(await f.getFile());
						} catch {}
					}
					// For "All Games" view, include console name in the card
					const consoleLabel = currentConsole === '__all__' ? `<div class="game-console-label">${gameConsoleName}</div>` : '';
					return `<div class="game-card" onclick="openGameModal('${game.name.replace(/'/g, "\\'")}', '${gameConsoleName.replace(/'/g, "\\'")}')" oncontextmenu="showContextMenu(event, '${game.name.replace(/'/g, "\\'")}', '${gameConsoleName.replace(/'/g, "\\'")}')">
						<div class="image-container">
							${imgSrc ? `<img src="${imgSrc}">` : '<span class="no-image">?</span>'}
							${!game.hasImage ? '<span class="missing-badge">No Image</span>' : ''}
						</div>
						<div class="game-name" title="${game.baseName}">${game.baseName}</div>
						${consoleLabel}
					</div>`;
				}));
				grid.innerHTML = cards.join('');
			}

			function filterGames() { renderGames(); }

			function toggleMissingFilter() {
				filterMissingOnly = !filterMissingOnly;
				const btn = document.getElementById('filterMissingBtn');
				if (filterMissingOnly) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
				renderGames();
			}

			function toggleSort() {
				currentSort = currentSort === 'az' ? 'za' : 'az';
				document.getElementById('sortIcon').className = currentSort === 'az'
					? 'icon solid fa-sort-alpha-down'
					: 'icon solid fa-sort-alpha-up';
				document.getElementById('sortLabel').textContent = currentSort === 'az' ? 'A-Z' : 'Z-A';
				renderGames();
			}

			// Top 25 Games Feature
			function normalizeGameName(name) {
				// Normalize a game name for comparison: lowercase, remove punctuation, region codes, etc.
				return name
					.toLowerCase()
					.replace(/\([^)]*\)/g, '') // Remove (USA), (Europe), etc.
					.replace(/\[[^\]]*\]/g, '') // Remove [!], [T+Eng], etc.
					.replace(/[^a-z0-9]/g, '') // Remove non-alphanumeric
					.trim();
			}

			function checkGameOwned(topGameName, ownedGames) {
				const normalizedTop = normalizeGameName(topGameName);
				return ownedGames.some(game => {
					const normalizedOwned = normalizeGameName(game.baseName);
					// Check if either contains the other (fuzzy match)
					return normalizedOwned.includes(normalizedTop) ||
					       normalizedTop.includes(normalizedOwned) ||
					       // Also check for significant overlap
					       (normalizedTop.length > 5 && normalizedOwned.length > 5 &&
					        (normalizedTop.slice(0, 10) === normalizedOwned.slice(0, 10)));
				});
			}

			function getConsoleKey(consoleName) {
				// Map folder names to topGamesData keys
				// Includes MustardOS folder names (lowercase) for Trimui Brick support
				const mapping = {
					// Nintendo Handhelds
					'Game Boy': 'GB', 'GB': 'GB', 'gameboy': 'GB', 'Gameboy': 'GB', 'gb': 'GB',
					'Game Boy Color': 'GBC', 'GBC': 'GBC', 'gameboycolor': 'GBC', 'gbc': 'GBC',
					'Game Boy Advance': 'GBA', 'GBA': 'GBA', 'gameboyadvance': 'GBA', 'gba': 'GBA',
					'NDS': 'NDS', 'Nintendo DS': 'NDS', 'nds': 'NDS', 'DS': 'NDS', 'ds': 'NDS',
					// Nintendo Home
					'NES': 'NES', 'FC': 'NES', 'Famicom': 'NES', 'famicom': 'NES', 'nes': 'NES', 'fds': 'NES', 'fc': 'NES',
					'SNES': 'SNES', 'SFC': 'SNES', 'Super Famicom': 'SNES', 'superfamicom': 'SNES', 'snes': 'SNES', 'sfc': 'SNES',
					'N64': 'N64', 'Nintendo 64': 'N64', 'nintendo64': 'N64', 'n64': 'N64',
					'Virtual Boy': 'Virtual Boy', 'VB': 'Virtual Boy', 'virtualboy': 'Virtual Boy', 'vb': 'Virtual Boy',
					// Sega
					'Genesis': 'Genesis', 'MD': 'Genesis', 'Sega Genesis': 'Genesis', 'Mega Drive': 'Genesis', 'megadrive': 'Genesis', 'segamd': 'Genesis', 'genesis': 'Genesis', 'md': 'Genesis',
					'Game Gear': 'Game Gear', 'GG': 'Game Gear', 'gamegear': 'Game Gear', 'gg': 'Game Gear',
					'Master System': 'Master System', 'MS': 'Master System', 'Sega Master System': 'Master System', 'SMS': 'Master System', 'mastersystem': 'Master System', 'sms': 'Master System',
					'Sega CD': 'Sega CD', 'segacd': 'Sega CD', 'mdcd': 'Sega CD', 'Mega CD': 'Sega CD', 'segamdcd': 'Sega CD',
					'Sega 32X': 'Sega 32X', 'sega32x': 'Sega 32X', '32X': 'Sega 32X',
					'Saturn': 'Saturn', 'saturn': 'Saturn', 'Sega Saturn': 'Saturn',
					'Dreamcast': 'Dreamcast', 'dreamcast': 'Dreamcast', 'DC': 'Dreamcast', 'dc': 'Dreamcast',
					// Sony
					'PS1': 'PS1', 'PSX': 'PS1', 'PlayStation': 'PS1', 'PS': 'PS1', 'playstation': 'PS1', 'ps1': 'PS1', 'psx': 'PS1', 'ps': 'PS1',
					'PSP': 'PSP', 'psp': 'PSP',
					// NEC
					'PCE': 'PCE', 'PC Engine': 'PCE', 'TurboGrafx-16': 'PCE', 'TurboGrafx': 'PCE', 'pcengine': 'PCE', 'turbografx': 'PCE', 'pce': 'PCE',
					// SNK
					'Neo Geo': 'Neo Geo', 'NEOGEO': 'Neo Geo', 'neogeo': 'Neo Geo', 'NeoGeo': 'Neo Geo',
					'Neo Geo Pocket': 'Neo Geo Pocket', 'NGP': 'Neo Geo Pocket', 'NGPC': 'Neo Geo Pocket', 'neogeopocket': 'Neo Geo Pocket', 'ngp': 'Neo Geo Pocket', 'ngpc': 'Neo Geo Pocket',
					// Atari
					'Atari 2600': 'Atari 2600', 'atari2600': 'Atari 2600', 'ATARI': 'Atari 2600', 'Atari': 'Atari 2600',
					'Atari 5200': 'Atari 5200', 'atari5200': 'Atari 5200', 'a5200': 'Atari 5200',
					'Atari 7800': 'Atari 7800', 'atari7800': 'Atari 7800', 'a7800': 'Atari 7800',
					'Atari Lynx': 'Atari Lynx', 'LYNX': 'Atari Lynx', 'Lynx': 'Atari Lynx', 'atarilynx': 'Atari Lynx', 'lynx': 'Atari Lynx',
					// Bandai
					'WonderSwan': 'WonderSwan', 'WS': 'WonderSwan', 'wonderswan': 'WonderSwan', 'ws': 'WonderSwan', 'wsc': 'WonderSwan',
					// Other Consoles
					'Coleco': 'Coleco', 'coleco': 'Coleco', 'ColecoVision': 'Coleco', 'colecovision': 'Coleco',
					'Intellivision': 'Intellivision', 'intellivision': 'Intellivision', 'INTV': 'Intellivision', 'intv': 'Intellivision',
					'Vectrex': 'Vectrex', 'vectrex': 'Vectrex',
					'3DO': '3DO', '3do': '3DO',
					// Computers
					'Amiga': 'Amiga', 'amiga': 'Amiga',
					'Commodore 64': 'Commodore 64', 'C64': 'Commodore 64', 'c64': 'Commodore 64'
				};
				return mapping[consoleName] || consoleName;
			}

			function openTop25Modal() {
				if (!currentConsole || currentConsole === '__all__') return;

				const consoleKey = getConsoleKey(currentConsole);
				const topGames = topGamesData[consoleKey];

				if (!topGames) {
					alert('Top 25 list not available for this console yet.');
					return;
				}

				const ownedGames = consoles[currentConsole]?.games || [];
				const list = document.getElementById('top25List');
				let owned = 0, missing = 0;

				document.getElementById('top25ConsoleName').textContent = currentConsole + ' Games';

				const html = topGames.map((game, idx) => {
					const isOwned = checkGameOwned(game, ownedGames);
					if (isOwned) owned++; else missing++;
					return `<div class="top25-item ${isOwned ? 'owned' : 'missing'}">
						<span class="top25-rank">#${idx + 1}</span>
						<span class="top25-icon ${isOwned ? 'owned' : 'missing'}">
							<span class="icon solid fa-${isOwned ? 'check' : 'times'}"></span>
						</span>
						<span class="top25-name">${game}</span>
					</div>`;
				}).join('');

				list.innerHTML = html;
				document.getElementById('top25Owned').textContent = owned;
				document.getElementById('top25Missing').textContent = missing;
				document.getElementById('top25Modal').classList.add('active');

				// Setup drag and drop
				setupTop25DragDrop();
			}

			function setupTop25DragDrop() {
				const dropZone = document.getElementById('top25DropZone');

				dropZone.ondragover = (e) => {
					e.preventDefault();
					dropZone.classList.add('dragover');
				};
				dropZone.ondragleave = () => {
					dropZone.classList.remove('dragover');
				};
				dropZone.ondrop = async (e) => {
					e.preventDefault();
					dropZone.classList.remove('dragover');
					const files = Array.from(e.dataTransfer.files);
					await uploadTop25Files(files);
				};
			}

			async function handleTop25Upload(event) {
				const files = Array.from(event.target.files);
				await uploadTop25Files(files);
				event.target.value = '';
			}

			async function uploadTop25Files(files) {
				if (!files.length || !currentConsole || !consoles[currentConsole]) return;

				const consoleData = consoles[currentConsole];
				const romExts = ['.gb', '.gbc', '.gba', '.nes', '.sfc', '.smc', '.md', '.gen', '.gg', '.sms', '.bin', '.zip', '.7z'];

				let uploaded = 0;
				for (const file of files) {
					const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
					if (!romExts.includes(ext)) continue;

					try {
						// Clean filename
						let cleanName = file.name
							.replace(/\([^)]*\)/g, '')
							.replace(/\[[^\]]*\]/g, '')
							.replace(/\s+/g, ' ')
							.trim();
						// Ensure extension
						if (!cleanName.toLowerCase().endsWith(ext)) {
							cleanName = cleanName.substring(0, cleanName.lastIndexOf('.')) + ext;
						}

						const fh = await consoleData.handle.getFileHandle(cleanName, { create: true });
						const w = await fh.createWritable();
						await w.write(file);
						await w.close();
						uploaded++;
					} catch (e) {
						console.error('Upload error:', e);
					}
				}

				if (uploaded > 0) {
					// Refresh the entire directory to pick up new files
					await scanExistingDirectory();
					// Refresh the modal
					openTop25Modal();
					// Refresh main grid
					await renderGames();
				}
			}

			function updateTop25Button() {
				const btn = document.getElementById('top25Btn');
				if (!currentConsole || currentConsole === '__all__') {
					btn.style.display = 'none';
					return;
				}
				const consoleKey = getConsoleKey(currentConsole);
				btn.style.display = topGamesData[consoleKey] ? '' : 'none';
			}

			let gameConsole = null; // Track which console the current game belongs to

			function openGameModal(gameName, consoleName) {
				currentGame = gameName;
				gameConsole = consoleName || currentConsole;
				const baseName = gameName.substring(0, gameName.lastIndexOf('.'));
				const modalTitle = document.getElementById('modalGameName');
				modalTitle.textContent = baseName;
				document.getElementById('gameTitleTooltip').textContent = baseName;
				document.getElementById('imageUrl').value = '';
				document.getElementById('imageStatus').className = 'status-msg';
				document.getElementById('imageStatus').style.display = 'none';
				loadGameImage(baseName);
				updateNextGameButton();
				// Fetch GameFAQs info (async, non-blocking)
				fetchGameFAQsInfo(baseName, gameConsole);
				// Show/hide saves button and local image rows based on device
				// Saves supported for RG Nano and Onion OS devices (Miyoo Mini, Miyoo Flip)
				const savesBtn = document.getElementById('savesButtonRow');
				const noSavesRow = document.getElementById('noSavesButtonRow');
				const supportsSaves = currentDevice === 'rgnano' || isOnionOS(currentDevice);
				if (supportsSaves) {
					savesBtn.style.display = 'block';
					noSavesRow.style.display = 'none';
				} else {
					savesBtn.style.display = 'none';
					noSavesRow.style.display = 'grid';
				}
				document.getElementById('gameModal').classList.add('active');
			}

			async function loadGameImage(baseName) {
				const preview = document.getElementById('modalImagePreview');
				const targetConsole = gameConsole || currentConsole;
				if (!targetConsole || !consoles[targetConsole]) {
					preview.innerHTML = '<span class="no-image">?</span>'; return;
				}

				const profile = deviceProfiles[currentDevice];
				let imageHandle;

				if (profile.catalogueStructure) {
					// Trimui Brick / Mustard OS: Look in box folder
					if (consoles[targetConsole].boxHandle) {
						imageHandle = consoles[targetConsole].boxHandle;
					} else {
						// Try to get box folder if it exists now (may have been created after initial scan)
						try {
							const boxDir = await consoles[targetConsole].handle.getDirectoryHandle('box');
							consoles[targetConsole].boxHandle = boxDir;
							imageHandle = boxDir;
						} catch {
							// Box folder doesn't exist, fallback to system folder
							imageHandle = consoles[targetConsole].handle;
						}
					}
				} else {
					// Other devices: Imgs folder or console folder
					imageHandle = consoles[targetConsole].imgsHandle || consoles[targetConsole].handle;
				}

				// Try PNG first, then JPG
				try {
					const f = await imageHandle.getFileHandle(baseName + '.png');
					preview.innerHTML = `<img src="${await createObjectURL(await f.getFile())}">`;
				} catch {
					try {
						const f = await imageHandle.getFileHandle(baseName + '.jpg');
						preview.innerHTML = `<img src="${await createObjectURL(await f.getFile())}">`;
					} catch {
						preview.innerHTML = '<span class="no-image">?</span>';
					}
				}
			}

			let selectedPickerUrl = null;

			function openImagePicker() {
				const baseName = currentGame ? currentGame.substring(0, currentGame.lastIndexOf('.')) : '';
				document.getElementById('pickerSearchQuery').value = baseName;
				document.getElementById('pickerGrid').innerHTML = '<div class="no-results">Enter a game name and click Search</div>';
				document.getElementById('pickerSelectBtn').disabled = true;
				selectedPickerUrl = null;
				document.getElementById('imagePicker').classList.add('active');
				// Auto-search if we have a name
				if (baseName) searchImagesInPicker();
			}

			function closeImagePicker() {
				document.getElementById('imagePicker').classList.remove('active');
			}

			async function searchImagesInPicker() {
				const q = document.getElementById('pickerSearchQuery').value.trim();
				if (!q) return;

				const grid = document.getElementById('pickerGrid');
				grid.innerHTML = '<div class="loading">Searching for covers...</div>';
				document.getElementById('pickerSelectBtn').disabled = true;
				selectedPickerUrl = null;

				try {
					const images = [];
					const parser = new DOMParser();
					const consoleName = gameConsole || currentConsole;

					// Search all sources in parallel
					const [gamesDbResults, gameFaqsResults, coverProjectResults] = await Promise.allSettled([
						searchTheGamesDB(q, parser),
						searchGameFAQs(q, parser, consoleName),
						searchTheCoverProject(q, parser)
					]);

					// Combine results from all sources
					if (gamesDbResults.status === 'fulfilled') {
						images.push(...gamesDbResults.value);
					}
					if (gameFaqsResults.status === 'fulfilled') {
						images.push(...gameFaqsResults.value);
					}
					if (coverProjectResults.status === 'fulfilled') {
						images.push(...coverProjectResults.value);
					}

					if (images.length === 0) {
						grid.innerHTML = '<div class="no-results">No images found. Try Google Images instead.</div>';
						return;
					}

					// Remove duplicates
					const uniqueImages = images.filter((img, idx, arr) =>
						arr.findIndex(i => i.full === img.full) === idx
					);

					grid.innerHTML = uniqueImages.slice(0, 30).map(img =>
						`<img src="${img.thumb}" data-url="${img.full}" onclick="selectPickerImage(this)" ondblclick="selectPickerImage(this); confirmImageSelection();" title="Click to select, double-click to use" onerror="this.style.display='none'">`
					).join('');
				} catch (e) {
					grid.innerHTML = '<div class="no-results">Search unavailable. Try Google Images instead.</div>';
				}
			}

			async function searchTheGamesDB(q, parser) {
				const images = [];
				const searchUrl = `https://thegamesdb.net/search.php?name=${encodeURIComponent(q)}`;
				const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(searchUrl)}`);

				if (!response.ok) return images;

				const html = await response.text();
				const doc = parser.parseFromString(html, 'text/html');

				// Find all game images in search results
				const gameImgs = doc.querySelectorAll('img[src*="cdn.thegamesdb.net"]');
				gameImgs.forEach(img => {
					const thumbUrl = img.getAttribute('src');
					if (thumbUrl && thumbUrl.includes('/boxart/')) {
						const fullUrl = thumbUrl.replace('/thumb/', '/original/');
						images.push({ thumb: thumbUrl, full: fullUrl });
					}
				});

				// Also check for game detail links to get more images
				const gameLinks = doc.querySelectorAll('a[href*="game.php?id="]');
				const uniqueIds = [...new Set(Array.from(gameLinks).map(a => {
					const match = a.getAttribute('href').match(/id=(\d+)/);
					return match ? match[1] : null;
				}).filter(Boolean))];

				// Fetch additional images from first few game pages
				for (const gameId of uniqueIds.slice(0, 3)) {
					try {
						const gameUrl = `https://thegamesdb.net/game.php?id=${gameId}`;
						const gameResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(gameUrl)}`);
						if (gameResponse.ok) {
							const gameHtml = await gameResponse.text();
							const gameDoc = parser.parseFromString(gameHtml, 'text/html');

							const boxartImgs = gameDoc.querySelectorAll('img[src*="cdn.thegamesdb.net"]');
							boxartImgs.forEach(img => {
								const src = img.getAttribute('src');
								if (src && (src.includes('/boxart/') || src.includes('/screenshot'))) {
									const fullUrl = src.replace('/thumb/', '/original/');
									if (!images.find(i => i.full === fullUrl)) {
										images.push({ thumb: src, full: fullUrl });
									}
								}
							});
						}
					} catch (e) { /* Ignore errors */ }
					if (images.length >= 15) break;
				}
				return images;
			}

			async function searchTheCoverProject(q, parser) {
				// The Cover Project's CDN blocks CORS proxies, so we can't reliably fetch their images
				// Return empty array - TheGamesDB will be the primary source
				return [];
			}

			// GameFAQs platform code mapping
			const gameFaqsPlatformMap = {
				// Nintendo Handhelds
				'GB': 'gameboy', 'GBC': 'gbc', 'GBA': 'gba', 'NDS': 'ds', 'DS': 'ds',
				// Nintendo Home
				'NES': 'nes', 'FC': 'nes', 'SNES': 'snes', 'SFC': 'snes', 'N64': 'n64', 'Virtual Boy': 'virtualboy',
				// Sega
				'Genesis': 'genesis', 'MD': 'genesis', 'Game Gear': 'gamegear', 'GG': 'gamegear',
				'Master System': 'sms', 'SMS': 'sms', 'MS': 'sms',
				'Sega CD': 'segacd', 'Sega 32X': 'sega32x', '32X': 'sega32x',
				'Saturn': 'saturn', 'Dreamcast': 'dreamcast', 'DC': 'dreamcast',
				// Sony
				'PS1': 'ps', 'PSX': 'ps', 'PlayStation': 'ps', 'PSP': 'psp',
				// NEC
				'PCE': 'tg16', 'PC Engine': 'tg16', 'TurboGrafx-16': 'tg16', 'TurboGrafx': 'tg16',
				// SNK
				'Neo Geo': 'neo', 'NEOGEO': 'neo', 'Neo Geo Pocket': 'ngpc', 'NGP': 'ngpc', 'NGPC': 'ngpc',
				// Atari
				'Atari 2600': 'atari2600', 'Atari 5200': 'atari5200', 'Atari 7800': 'atari7800', 'Atari Lynx': 'lynx',
				// Bandai
				'WonderSwan': 'wonderswan', 'WS': 'wonderswan',
				// Other
				'Coleco': 'colecovision', 'ColecoVision': 'colecovision',
				'Intellivision': 'intellivision', '3DO': '3do',
				// Arcade
				'Arcade': 'arcade', 'MAME': 'arcade', 'CPS1': 'arcade', 'CPS2': 'arcade', 'CPS3': 'arcade'
			};

			async function searchGameFAQs(q, parser, consoleName) {
				const images = [];

				// Get platform code for GameFAQs
				const consoleKey = getConsoleKey(consoleName);
				const platformCode = gameFaqsPlatformMap[consoleKey];

				// Related platforms (GB and GBC games are often interchangeable)
				const relatedPlatforms = {
					'gameboy': ['gameboy', 'gbc'],
					'gbc': ['gbc', 'gameboy'],
					'nes': ['nes'],
					'snes': ['snes'],
					'gba': ['gba'],
					'genesis': ['genesis'],
					'n64': ['n64'],
					'ps': ['ps'],
					'ds': ['ds']
				};
				const allowedPlatforms = platformCode ? (relatedPlatforms[platformCode] || [platformCode]) : null;

				try {
					// Use GameFAQs JSON search API
					const searchUrl = `https://gamefaqs.gamespot.com/ajax/home_game_search?term=${encodeURIComponent(q)}`;
					const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(searchUrl)}`);
					if (!response.ok) return images;

					const data = await response.json();
					if (!Array.isArray(data)) return images;

					// Filter results by platform and collect game URLs
					// Prioritize games whose name closely matches the search query
					const gameMatches = [];
					const searchLower = q.toLowerCase().replace(/[^a-z0-9]/g, '');

					for (const game of data) {
						if (!game.url || !game.platform_url) continue;

						// Check if platform matches
						const platformMatch = allowedPlatforms ? allowedPlatforms.includes(game.platform_url) : true;
						if (!platformMatch) continue;

						// Score by name similarity - exact match gets highest priority
						const gameName = (game.game_name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
						let score = 0;
						if (gameName === searchLower) score = 100; // Exact match
						else if (gameName.includes(searchLower)) score = 50; // Contains search
						else if (searchLower.includes(gameName)) score = 25; // Search contains game name

						// Boost exact platform match
						if (game.platform_url === platformCode) score += 10;

						gameMatches.push({ url: game.url, name: game.game_name, score });
					}

					// Sort by score descending
					gameMatches.sort((a, b) => b.score - a.score);
					const gameUrls = gameMatches.map(g => g.url);

					// Helper to convert relative URLs to absolute
					const toAbsoluteUrl = (src) => {
						if (src.startsWith('//')) return 'https:' + src;
						if (src.startsWith('/')) return 'https://gamefaqs.gamespot.com' + src;
						if (!src.startsWith('http')) return 'https://gamefaqs.gamespot.com/' + src;
						return src;
					};

					// Fetch box art from /boxes page for the best match
					const uniqueUrls = [...new Set(gameUrls)].slice(0, 1);
					for (const gameUrl of uniqueUrls) {
						try {
							// Go directly to the /boxes page for box art
							const boxesPageUrl = `https://gamefaqs.gamespot.com${gameUrl}/boxes`;
							const boxesResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(boxesPageUrl)}`);
							if (!boxesResponse.ok) continue;

							const boxesHtml = await boxesResponse.text();
							const boxesDoc = parser.parseFromString(boxesHtml, 'text/html');

							// Find all box art images
							boxesDoc.querySelectorAll('img[src*="/a/box/"]').forEach(img => {
								const src = img.getAttribute('src');
								if (src) {
									const thumbUrl = toAbsoluteUrl(src);
									const imgFullUrl = thumbUrl.replace('_thumb.jpg', '_front.jpg');
									if (!images.find(i => i.full === imgFullUrl)) {
										images.push({ thumb: thumbUrl, full: imgFullUrl });
									}
								}
							});
						} catch (e) { /* Ignore errors */ }

						if (images.length >= 10) break;
					}
				} catch (e) {
					console.log('GameFAQs search error:', e);
				}

				return images;
			}

			// Fetch game info (rating, difficulty, length) from GameFAQs
			async function fetchGameFAQsInfo(gameName, consoleName) {
				const infoDiv = document.getElementById('gameFaqsInfo');
				const ratingEl = document.getElementById('gfRating');
				const difficultyEl = document.getElementById('gfDifficulty');
				const lengthEl = document.getElementById('gfLength');
				const ratingTooltip = document.getElementById('gfRatingTooltip');
				const difficultyTooltip = document.getElementById('gfDifficultyTooltip');
				const lengthTooltip = document.getElementById('gfLengthTooltip');

				// Reset and hide while loading
				infoDiv.style.display = 'none';
				ratingEl.innerHTML = '<span class="icon solid fa-star"></span> --';
				difficultyEl.innerHTML = '<span class="icon solid fa-heartbeat"></span> --';
				lengthEl.innerHTML = '<span class="icon solid fa-clock"></span> --';
				ratingTooltip.innerHTML = '';
				difficultyTooltip.innerHTML = '';
				lengthTooltip.innerHTML = '';

				try {
					// Get platform code
					const consoleKey = getConsoleKey(consoleName);
					const platformCode = gameFaqsPlatformMap[consoleKey];
					const relatedPlatforms = {
						'gameboy': ['gameboy', 'gbc'],
						'gbc': ['gbc', 'gameboy'],
						'nes': ['nes'],
						'snes': ['snes'],
						'gba': ['gba'],
						'genesis': ['genesis'],
						'n64': ['n64'],
						'ps': ['ps'],
						'ds': ['ds']
					};
					const allowedPlatforms = platformCode ? (relatedPlatforms[platformCode] || [platformCode]) : null;

					// Search for the game
					const searchUrl = `https://gamefaqs.gamespot.com/ajax/home_game_search?term=${encodeURIComponent(gameName)}`;
					const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(searchUrl)}`);
					if (!response.ok) return;

					const data = await response.json();
					if (!Array.isArray(data)) return;

					// Find best matching game
					const searchLower = gameName.toLowerCase().replace(/[^a-z0-9]/g, '');
					let bestMatch = null;
					let bestScore = 0;

					for (const game of data) {
						if (!game.url || !game.platform_url) continue;
						const platformMatch = allowedPlatforms ? allowedPlatforms.includes(game.platform_url) : true;
						if (!platformMatch) continue;

						const gameNameLower = (game.game_name || '').toLowerCase().replace(/[^a-z0-9]/g, '');
						let score = 0;
						if (gameNameLower === searchLower) score = 100;
						else if (gameNameLower.includes(searchLower)) score = 50;
						else if (searchLower.includes(gameNameLower)) score = 25;
						if (game.platform_url === platformCode) score += 10;

						if (score > bestScore) {
							bestScore = score;
							bestMatch = game;
						}
					}

					if (!bestMatch) return;

					// Fetch the game page
					const gamePageUrl = `https://gamefaqs.gamespot.com${bestMatch.url}`;
					const gameResponse = await fetch(`https://corsproxy.io/?${encodeURIComponent(gamePageUrl)}`);
					if (!gameResponse.ok) return;

					const html = await gameResponse.text();

					// Parse rating with count
					let rating = null;
					let ratingCount = null;
					let ratingLabel = null;
					// Try "4.23 stars from 3375" pattern
					let ratingMatch = html.match(/(\d+\.\d+)\s*stars?\s*from\s*(\d+)/i);
					if (ratingMatch) {
						rating = parseFloat(ratingMatch[1]).toFixed(2);
						ratingCount = ratingMatch[2];
					}
					// Try text rating like "Great (3375 ratings)"
					const labelMatch = html.match(/(Outstanding|Great|Good|Average|Bad|Terrible)\s*\((\d+)\s*ratings?\)/i);
					if (labelMatch) {
						ratingLabel = labelMatch[1];
						if (!ratingCount) ratingCount = labelMatch[2];
					}

					// Parse difficulty with count
					let difficulty = null;
					let difficultyCount = null;
					const diffMatch = html.match(/(Very Easy|Easy|Just Right|Tough|Very Hard|Unforgiving)\s*\((\d+)\)/i);
					if (diffMatch) {
						difficulty = diffMatch[1];
						difficultyCount = diffMatch[2];
					}

					// Parse length with count
					let length = null;
					let lengthCount = null;
					const lengthMatch = html.match(/(\d+(?:\.\d+)?)\s*Hours?\s*\((\d+)\)/i);
					if (lengthMatch) {
						length = lengthMatch[1] + 'h';
						lengthCount = lengthMatch[2];
					}

					// Update UI if we found any data
					if (rating || ratingLabel || difficulty || length) {
						infoDiv.style.display = 'block';

						// Rating
						if (rating || ratingLabel) {
							const displayRating = rating || ratingLabel;
							ratingEl.innerHTML = `<span class="icon solid fa-star"></span> ${displayRating}`;
							let tooltipHtml = '';
							if (rating) tooltipHtml += `<div class="gf-tooltip-row"><span>Score:</span><span>${rating} / 5</span></div>`;
							if (ratingLabel) tooltipHtml += `<div class="gf-tooltip-row"><span>Verdict:</span><span>${ratingLabel}</span></div>`;
							if (ratingCount) tooltipHtml += `<div class="gf-tooltip-row"><span>Votes:</span><span>${parseInt(ratingCount).toLocaleString()}</span></div>`;
							ratingTooltip.innerHTML = tooltipHtml;
						}

						// Difficulty
						if (difficulty) {
							difficultyEl.innerHTML = `<span class="icon solid fa-heartbeat"></span> ${difficulty}`;
							let tooltipHtml = `<div class="gf-tooltip-row"><span>Difficulty:</span><span>${difficulty}</span></div>`;
							if (difficultyCount) tooltipHtml += `<div class="gf-tooltip-row"><span>Votes:</span><span>${parseInt(difficultyCount).toLocaleString()}</span></div>`;
							difficultyTooltip.innerHTML = tooltipHtml;
						}

						// Length
						if (length) {
							lengthEl.innerHTML = `<span class="icon solid fa-clock"></span> ${length}`;
							let tooltipHtml = `<div class="gf-tooltip-row"><span>Main Story:</span><span>${length}</span></div>`;
							if (lengthCount) tooltipHtml += `<div class="gf-tooltip-row"><span>Votes:</span><span>${parseInt(lengthCount).toLocaleString()}</span></div>`;
							lengthTooltip.innerHTML = tooltipHtml;
						}
					}
				} catch (e) {
					// Silently fail - info is optional
				}
			}

			function selectPickerImage(img) {
				document.querySelectorAll('#pickerGrid img').forEach(i => i.classList.remove('selected'));
				img.classList.add('selected');
				selectedPickerUrl = img.dataset.url;
				document.getElementById('pickerSelectBtn').disabled = false;
			}

			async function confirmImageSelection() {
				if (!selectedPickerUrl) return;
				closeImagePicker();
				document.getElementById('imageUrl').value = selectedPickerUrl;
				// Auto-download the selected image
				await downloadAndResizeImage();
			}

			function openGoogleImages() {
				const q = document.getElementById('pickerSearchQuery').value || document.getElementById('modalGameName').textContent;
				window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(q + ' box art cover')}`, '_blank');
			}

			function confirmDeleteGame() {
				const gameName = document.getElementById('modalGameName').textContent;
				document.getElementById('deleteConfirmText').textContent = `Are you sure you want to delete "${gameName}"? This will remove the ROM file and its box art image.`;
				document.getElementById('deleteModal').classList.add('active');
			}

			async function executeDeleteGame() {
				try {
					const gameFileName = currentGame; // e.g. "Donkey Kong Country.sfc"
					const baseName = gameFileName.substring(0, gameFileName.lastIndexOf('.'));
					const consoleName = gameConsole || currentConsole;
					const consoleHandle = consoles[consoleName].handle;
					const imageHandle = consoles[consoleName].imgsHandle || consoleHandle;

					// Delete the ROM file
					await consoleHandle.removeEntry(gameFileName);

					// Delete the image file if it exists (try both png and jpg)
					try {
						await imageHandle.removeEntry(baseName + '.png');
					} catch (e) {}
					try {
						await imageHandle.removeEntry(baseName + '.jpg');
					} catch (e) {}

					// Reset file inputs to prevent them from triggering
					document.getElementById('fileInput').value = '';
					document.getElementById('localImageInput').value = '';

					// Close all modals first
					closeModal('deleteModal');
					closeModal('gameModal');
					currentGame = null;

					// Remove focus from any element
					document.activeElement.blur();

					// Rescan and refresh view after short delay
					setTimeout(async () => {
						await scanExistingDirectory();
						// Check if console still exists after rescan
						if (consoles[consoleName]) {
							currentConsole = consoleName;
							await renderGames();
						} else {
							// Console folder is empty/deleted, go home
							showHome();
						}
					}, 100);

				} catch (e) {
					alert('Error deleting game: ' + e.message);
				}
			}

			// Context menu functions
			function showContextMenu(event, gameName, consoleName) {
				event.preventDefault();
				event.stopPropagation();
				contextMenuTarget = gameName;
				contextMenuConsole = consoleName || currentConsole;

				const menu = document.getElementById('contextMenu');
				menu.style.left = event.pageX + 'px';
				menu.style.top = event.pageY + 'px';
				menu.classList.add('active');
			}

			function hideContextMenu() {
				document.getElementById('contextMenu').classList.remove('active');
				contextMenuTarget = null;
				contextMenuConsole = null;
			}

			function contextMenuAction(action) {
				if (!contextMenuTarget) return;
				const gameName = contextMenuTarget;
				const consoleName = contextMenuConsole;
				hideContextMenu();

				switch (action) {
					case 'edit':
						openGameModal(gameName, consoleName);
						break;
					case 'search':
						openGameModal(gameName, consoleName);
						setTimeout(() => openImagePicker(), 100);
						break;
					case 'google':
						const baseName = gameName.substring(0, gameName.lastIndexOf('.'));
						window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(baseName + ' box art cover')}`, '_blank');
						break;
					case 'rename':
						openRenameModal(gameName, consoleName);
						break;
					case 'delete':
						openGameModal(gameName, consoleName);
						setTimeout(() => confirmDeleteGame(), 100);
						break;
				}
			}

			let renameTarget = null;
			let renameConsole = null;

			function openRenameModal(gameName, consoleName) {
				renameTarget = gameName;
				renameConsole = consoleName || currentConsole;
				const baseName = gameName.substring(0, gameName.lastIndexOf('.'));
				document.getElementById('renameInput').value = baseName;
				document.getElementById('renameStatus').className = 'status-msg';
				document.getElementById('renameStatus').style.display = 'none';
				document.getElementById('renameModal').classList.add('active');
				// Focus and select the input
				setTimeout(() => {
					const input = document.getElementById('renameInput');
					input.focus();
					input.select();
				}, 100);
			}

			function openRenameFromGameModal() {
				if (currentGame && gameConsole) {
					openRenameModal(currentGame, gameConsole);
				}
			}

			function autoCleanName() {
				const input = document.getElementById('renameInput');
				const currentName = input.value;
				// Use cleanGameName logic but without extension handling since we don't have extension in input
				let cleaned = currentName;
				for (const pattern of cleanupPatterns) {
					cleaned = cleaned.replace(pattern, pattern.source === '\\s+' ? ' ' : '');
				}
				cleaned = cleaned.trim();
				if (cleaned !== currentName) {
					input.value = cleaned;
					input.focus();
					input.select();
				}
			}

			async function executeRename() {
				const targetConsole = renameConsole || currentConsole;
				if (!renameTarget || !targetConsole) return;

				const newName = document.getElementById('renameInput').value.trim();
				const status = document.getElementById('renameStatus');

				if (!newName) {
					status.className = 'status-msg error';
					status.textContent = 'Please enter a name';
					status.style.display = 'block';
					return;
				}

				// Validate filename characters
				const invalidChars = /[\/\\:*?"<>|]/;
				if (invalidChars.test(newName)) {
					status.className = 'status-msg error';
					status.textContent = 'Name contains invalid characters: / \\ : * ? " < > |';
					status.style.display = 'block';
					return;
				}

				const oldFileName = renameTarget;
				const oldBaseName = oldFileName.substring(0, oldFileName.lastIndexOf('.'));
				const ext = oldFileName.substring(oldFileName.lastIndexOf('.'));
				const newFileName = newName + ext;

				// Check if name changed
				if (oldBaseName === newName) {
					closeModal('renameModal');
					return;
				}

				status.textContent = 'Renaming...';
				status.style.display = 'block';
				status.className = 'status-msg';

				try {
					const consoleHandle = consoles[targetConsole].handle;
					const imageHandle = consoles[targetConsole].imgsHandle || consoleHandle;

					// Read the old ROM file
					const oldRomHandle = await consoleHandle.getFileHandle(oldFileName);
					const oldRomFile = await oldRomHandle.getFile();
					const romData = await oldRomFile.arrayBuffer();

					// Create new ROM file with new name
					const newRomHandle = await consoleHandle.getFileHandle(newFileName, { create: true });
					const romWriter = await newRomHandle.createWritable();
					await romWriter.write(romData);
					await romWriter.close();

					// Delete old ROM file
					await consoleHandle.removeEntry(oldFileName);

					// Try to rename art file if it exists (check PNG first, then JPG)
					let artExt = null;
					try {
						await imageHandle.getFileHandle(oldBaseName + '.png');
						artExt = '.png';
					} catch {
						try {
							await imageHandle.getFileHandle(oldBaseName + '.jpg');
							artExt = '.jpg';
						} catch {}
					}

					if (artExt) {
						try {
							const oldArtHandle = await imageHandle.getFileHandle(oldBaseName + artExt);
							const oldArtFile = await oldArtHandle.getFile();
							const artData = await oldArtFile.arrayBuffer();

							// Create new art file (keep same extension)
							const newArtHandle = await imageHandle.getFileHandle(newName + artExt, { create: true });
							const artWriter = await newArtHandle.createWritable();
							await artWriter.write(artData);
							await artWriter.close();

							// Delete old art file
							await imageHandle.removeEntry(oldBaseName + artExt);
						} catch (e) {
							// Art file error, continue anyway
						}
					}

					status.className = 'status-msg success';
					status.textContent = 'Renamed successfully!';

					// Refresh after short delay
					setTimeout(async () => {
						closeModal('renameModal');

						// Update the game modal with new name
						if (currentGame === oldFileName) {
							currentGame = newFileName;
							const modalTitle = document.getElementById('modalGameName');
							modalTitle.textContent = newName;
							document.getElementById('gameTitleTooltip').textContent = newName;
							loadGameImage(newName);
						}

						renameTarget = null;
						renameConsole = null;
						await scanExistingDirectory();
						await renderGames();
						updateGameCountBadge();
					}, 500);

				} catch (e) {
					status.className = 'status-msg error';
					status.textContent = 'Error: ' + e.message;
				}
			}

			// Close context menu when clicking elsewhere
			document.addEventListener('click', (e) => {
				if (!e.target.closest('.context-menu')) {
					hideContextMenu();
				}
			});

			// Next Missing Art function
			function goToNextMissingArt() {
				const targetConsole = gameConsole || currentConsole;
				if (!targetConsole || !consoles[targetConsole]) return;

				const games = consoles[targetConsole].games;
				const currentIndex = games.findIndex(g => g.name === currentGame);

				// Find next game without art, starting after current game
				for (let i = 1; i <= games.length; i++) {
					const idx = (currentIndex + i) % games.length;
					if (!games[idx].hasImage) {
						closeModal('gameModal');
						setTimeout(() => openGameModal(games[idx].name, targetConsole), 100);
						return;
					}
				}

				// No more games without art
				alert('No more games without box art in this console!');
			}

			function updateNextGameButton() {
				const targetConsole = gameConsole || currentConsole;
				if (!targetConsole || !consoles[targetConsole]) return;
				const games = consoles[targetConsole].games;
				const hasMoreMissing = games.some(g => g.name !== currentGame && !g.hasImage);
				document.getElementById('nextGameBtn').disabled = !hasMoreMissing;
			}

			function selectSearchResult(img) {
				// Remove selected class from others
				document.querySelectorAll('#imageResults img').forEach(i => i.classList.remove('selected'));
				img.classList.add('selected');
				// Set the URL in the input field
				document.getElementById('imageUrl').value = img.dataset.url;
			}

			async function downloadAndResizeImage() {
				const url = document.getElementById('imageUrl').value.trim();
				const status = document.getElementById('imageStatus');
				if (!url) { status.className = 'status-msg error'; status.textContent = 'Enter a URL'; return; }
				status.textContent = 'Downloading...'; status.style.display = 'block'; status.className = 'status-msg';
				try {
					// Always use CORS proxy for external URLs to avoid CORS blocking
					const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;

					// Add timeout for fetch (30 seconds)
					const controller = new AbortController();
					const timeout = setTimeout(() => controller.abort(), 30000);

					const r = await fetch(proxyUrl, { signal: controller.signal });
					clearTimeout(timeout);

					if (!r.ok) throw new Error('Failed');
					await processAndSaveImage(await r.blob());
				} catch (e) {
					status.className = 'status-msg error';
					status.textContent = e.name === 'AbortError' ? 'Download timed out' : 'Error. Try Local instead.';
				}
			}

			function selectLocalImage() { document.getElementById('localImageInput').click(); }
			async function handleLocalImage(e) { if (e.target.files[0]) await processAndSaveImage(e.target.files[0]); }

			async function processAndSaveImage(blob) {
				const status = document.getElementById('imageStatus');
				const targetConsole = gameConsole || currentConsole;
				try {
					const img = await createImageBitmap(blob);
					const profile = deviceProfiles[currentDevice];
					const maxSize = profile.imageSize || 240;

					// Calculate scale factor to fit within maxSize while preserving aspect ratio
					const scale = Math.min(maxSize / img.width, maxSize / img.height);
					const newWidth = Math.round(img.width * scale);
					const newHeight = Math.round(img.height * scale);

					const canvas = document.createElement('canvas');
					canvas.width = newWidth;
					canvas.height = newHeight;

					// Use high quality image scaling
					const ctx = canvas.getContext('2d');
					ctx.imageSmoothingEnabled = true;
					ctx.imageSmoothingQuality = 'high';
					ctx.drawImage(img, 0, 0, newWidth, newHeight);

					const resized = await new Promise(r => canvas.toBlob(r, 'image/png'));

					const baseName = currentGame.substring(0, currentGame.lastIndexOf('.'));
					let imageDir;

					if (profile.catalogueStructure) {
						// Trimui Brick / MustardOS: Box art goes in MUOS/info/catalogue/<system>/box/
						if (consoles[targetConsole].boxHandle) {
							imageDir = consoles[targetConsole].boxHandle;
						} else {
							// Need to create box folder in catalogue structure
							try {
								const muosDir = await directoryHandle.getDirectoryHandle('MUOS', { create: true });
								const infoDir = await muosDir.getDirectoryHandle('info', { create: true });
								const catalogueDir = await infoDir.getDirectoryHandle('catalogue', { create: true });
								const catalogueName = consoles[targetConsole].catalogueName || targetConsole;
								const systemDir = await catalogueDir.getDirectoryHandle(catalogueName, { create: true });
								const boxDir = await systemDir.getDirectoryHandle('box', { create: true });
								consoles[targetConsole].boxHandle = boxDir;
								imageDir = boxDir;
							} catch (e) {
								// Fallback: create box in ROM folder
								const boxDir = await consoles[targetConsole].handle.getDirectoryHandle('box', { create: true });
								consoles[targetConsole].boxHandle = boxDir;
								imageDir = boxDir;
							}
						}
					} else if (profile.emoji === 'üßÖ') {
						// Onion OS: Create/get Imgs folder
						imageDir = consoles[targetConsole].imgsHandle || consoles[targetConsole].handle;
						if (!consoles[targetConsole].imgsHandle) {
							imageDir = await consoles[targetConsole].handle.getDirectoryHandle('Imgs', { create: true });
							consoles[targetConsole].imgsHandle = imageDir;
						}
					} else {
						// RG Nano / Generic: Save directly to console folder
						imageDir = consoles[targetConsole].handle;
					}

					const fh = await imageDir.getFileHandle(baseName + '.png', { create: true });
					const w = await fh.createWritable();
					await w.write(resized);
					await w.close();

					document.getElementById('modalImagePreview').innerHTML = `<img src="${await createObjectURL(resized)}">`;
					const game = consoles[targetConsole].games.find(g => g.name === currentGame);
					if (game) {
						game.hasImage = true;
						game.imageExt = '.png';
					}

					status.className = 'status-msg success';
					status.textContent = `Saved! (${newWidth}x${newHeight})`;
					renderConsoleList(); renderGames(); updateStats(); updateGameCountBadge();
					updateNextGameButton();
				} catch (e) { status.className = 'status-msg error'; status.textContent = 'Error: ' + e.message; }
			}

			function closeModal(id) { document.getElementById(id).classList.remove('active'); }

			function openUploadModal() {
				if (!directoryHandle) { alert('Scan a drive first'); return; }
				filesToUpload = [];
				document.getElementById('fileList').innerHTML = '';
				document.getElementById('uploadStatus').className = 'status-msg';
				// Pre-select current console if one is selected
				if (currentConsole) {
					document.getElementById('uploadConsoleSelect').value = currentConsole;
				}
				document.getElementById('uploadModal').classList.add('active');
			}

			document.addEventListener('DOMContentLoaded', () => {
				const dz = document.getElementById('dropZone');
				dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
				dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
				dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
				document.querySelectorAll('.modal-overlay').forEach(m => m.addEventListener('mousedown', e => { if (e.target === m) m.classList.remove('active'); }));
			});

			function handleFileSelect(e) { handleFiles(e.target.files); }
			function handleFiles(files) {
				const list = document.getElementById('fileList');
				for (const file of files) {
					const clean = cleanGameName(file.name);
					filesToUpload.push({ file, originalName: file.name, cleanName: clean });
					list.innerHTML += `<div class="file-item"><span class="original">${file.name}</span><span class="clean">‚Üí ${clean}</span></div>`;
				}
			}

			async function uploadFiles() {
				const consoleName = document.getElementById('uploadConsoleSelect').value;
				const status = document.getElementById('uploadStatus');
				if (!consoleName) { status.className = 'status-msg error'; status.textContent = 'Select a console'; return; }
				if (!filesToUpload.length) { status.className = 'status-msg error'; status.textContent = 'No files'; return; }

				status.textContent = 'Uploading...'; status.style.display = 'block';
				try {
					let ch;
					try { ch = await directoryHandle.getDirectoryHandle(consoleName); }
					catch { ch = await directoryHandle.getDirectoryHandle(consoleName, { create: true }); }

					for (const item of filesToUpload) {
						const fh = await ch.getFileHandle(item.cleanName, { create: true });
						const w = await fh.createWritable();
						await w.write(item.file);
						await w.close();
					}

					status.className = 'status-msg success';
					status.textContent = `Uploaded ${filesToUpload.length} file(s)!`;
					const uploadedToConsole = consoleName;
					const uploadedGames = filesToUpload.map(f => f.cleanName); // Keep full filename with extension
					filesToUpload = [];
					document.getElementById('fileList').innerHTML = '';

					// Reset file input to prevent it from triggering again
					document.getElementById('fileInput').value = '';

					// Close modal and refresh after brief delay to show success message
					setTimeout(async () => {
						closeModal('uploadModal');
						document.activeElement.blur();
						await scanExistingDirectory();
						// Refresh the view for the console we uploaded to
						if (consoles[uploadedToConsole]) {
							currentConsole = uploadedToConsole;
							document.getElementById('currentConsoleName').textContent = uploadedToConsole;
							document.getElementById('intro').style.display = 'none';
							document.getElementById('games').style.display = 'block';
							await renderGames();
							// Open game modal for the first uploaded game to add artwork
							if (uploadedGames.length > 0) {
								setTimeout(() => openGameModal(uploadedGames[0], uploadedToConsole), 300);
							}
						}
					}, 1000);
				} catch (e) { status.className = 'status-msg error'; status.textContent = 'Error: ' + e.message; }
			}

			// Register Service Worker for PWA
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', () => {
					navigator.serviceWorker.register('sw.js')
						.then(reg => console.log('NanoArcade: Service Worker registered', reg.scope))
						.catch(err => console.log('NanoArcade: Service Worker registration failed', err));
				});
			}

			// ============================================
			// Save Manager
			// ============================================

			// RG Nano emulator to console mapping (lowercase, .sav files)
			const rgNanoEmulatorMap = {
				'gambatte': ['Game Boy', 'Game Boy Color', 'GB', 'GBC'],
				'gpsp': ['Game Boy Advance', 'GBA'],
				'fceumm': ['NES', 'Nintendo Entertainment System', 'FC', 'Famicom'],
				'snes9x2005': ['SNES', 'Super Nintendo', 'SFC', 'Super Famicom'],
				'picodrive': ['Sega Genesis', 'Genesis', 'Mega Drive', 'MD', 'Game Gear', 'GG'],
				'pcsx_rearmed': ['PS1', 'PlayStation', 'PSX', 'PS']
			};

			// Onion OS emulator to console mapping (mixed case, .srm files)
			// Used by Miyoo Mini, Miyoo Mini+, Miyoo Flip
			const onionEmulatorMap = {
				'Gambatte': ['Game Boy', 'Game Boy Color', 'GB', 'GBC'],
				'gpSP': ['Game Boy Advance', 'GBA'],
				'FCEUmm': ['NES', 'Nintendo Entertainment System', 'FC', 'Famicom'],
				'Supafaust': ['SNES', 'Super Nintendo', 'SFC', 'Super Famicom'],
				'Snes9x 2005 Plus': ['SNES', 'Super Nintendo', 'SFC', 'Super Famicom'],
				'PicoDrive': ['Sega Genesis', 'Genesis', 'Mega Drive', 'MD', 'Game Gear', 'GG', 'Sega Master System', 'Master System', 'MS'],
				'Genesis Plus GX': ['Sega Genesis', 'Genesis', 'Mega Drive', 'MD', 'Game Gear', 'GG', 'Sega Master System', 'Master System', 'MS'],
				'PCSX-ReARMed': ['PS1', 'PlayStation', 'PSX', 'PS'],
				'Beetle PCE Fast': ['PC Engine', 'TurboGrafx-16', 'PCE', 'PCECD'],
				'Mednafen PCE Fast': ['PC Engine', 'TurboGrafx-16', 'PCE', 'PCECD'],
				'FinalBurn Neo': ['Arcade', 'Neo Geo', 'NEOGEO', 'CPS1', 'CPS2', 'CPS3'],
				'FB Alpha 2012': ['Arcade', 'Neo Geo', 'NEOGEO'],
				'FB Alpha 2012 CPS-3': ['CPS3'],
				'MAME 2003-Plus': ['Arcade', 'MAME'],
				'Beetle NeoPop': ['Neo Geo Pocket', 'Neo Geo Pocket Color', 'NGP', 'NGPC'],
				'Beetle WonderSwan': ['WonderSwan', 'WonderSwan Color', 'WS', 'WSC'],
				'Stella 2014': ['Atari 2600', 'Atari', '2600'],
				'Handy': ['Atari Lynx', 'Lynx']
			};

			function isOnionOS(deviceType) {
				return deviceType === 'onion' || deviceType === 'miyooflip';
			}

			function getSaveExtension(deviceType) {
				return isOnionOS(deviceType) ? '.srm' : '.sav';
			}

			function getEmulatorForConsole(consoleName, deviceType) {
				const emulatorMap = isOnionOS(deviceType) ? onionEmulatorMap : rgNanoEmulatorMap;
				for (const [emulator, consoleNames] of Object.entries(emulatorMap)) {
					if (consoleNames.some(c => c.toLowerCase() === consoleName.toLowerCase())) {
						return emulator;
					}
				}
				return null;
			}

			function openSaveManager() {
				const gameName = currentGame;
				const baseName = gameName.substring(0, gameName.lastIndexOf('.'));
				document.getElementById('saveGameName').textContent = baseName;
				document.getElementById('saveModal').classList.add('active');
				loadLocalSaves(baseName);
			}

			// Get the save folder handle based on device type
			async function getSaveFolderHandle(deviceType, emulator, create = false) {
				if (isOnionOS(deviceType)) {
					// Onion OS: Saves/CurrentProfile/saves/[emulator]/
					const savesHandle = await directoryHandle.getDirectoryHandle('Saves', { create }).catch(() => null);
					if (!savesHandle) return null;
					const profileHandle = await savesHandle.getDirectoryHandle('CurrentProfile', { create }).catch(() => null);
					if (!profileHandle) return null;
					const savesFolderHandle = await profileHandle.getDirectoryHandle('saves', { create }).catch(() => null);
					if (!savesFolderHandle) return null;
					return await savesFolderHandle.getDirectoryHandle(emulator, { create }).catch(() => null);
				} else {
					// RG Nano: FunKey/.picoarch/data/[emulator]/
					const funKeyHandle = await directoryHandle.getDirectoryHandle('FunKey', { create }).catch(() => null);
					if (!funKeyHandle) return null;
					const picoarchHandle = await funKeyHandle.getDirectoryHandle('.picoarch', { create }).catch(() => null);
					if (!picoarchHandle) return null;
					const dataHandle = await picoarchHandle.getDirectoryHandle('data', { create }).catch(() => null);
					if (!dataHandle) return null;
					return await dataHandle.getDirectoryHandle(emulator, { create }).catch(() => null);
				}
			}

			function getSaveLocationText(deviceType, emulator) {
				if (isOnionOS(deviceType)) {
					return `Saves/CurrentProfile/saves/${emulator}/`;
				} else {
					return `FunKey/.picoarch/data/${emulator}/`;
				}
			}

			async function loadLocalSaves(baseName) {
				const list = document.getElementById('localSavesList');
				list.innerHTML = '<div class="loading-container" style="padding: 2em;"><div class="spinner"></div><div class="loading-text">Checking for saves...</div></div>';

				// Check if device supports save management
				const supportsSaves = currentDevice === 'rgnano' || isOnionOS(currentDevice);
				if (!directoryHandle || !supportsSaves) {
					list.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); padding: 2em;">Save management is not available for this device.</p>';
					return;
				}

				const emulator = getEmulatorForConsole(gameConsole || currentConsole, currentDevice);
				if (!emulator) {
					list.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); padding: 2em;">Console not supported for save management.</p>';
					return;
				}

				const saveExt = getSaveExtension(currentDevice);

				try {
					const emulatorHandle = await getSaveFolderHandle(currentDevice, emulator, false);
					if (!emulatorHandle) {
						list.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); padding: 2em;">No saves found.</p>';
						return;
					}

					// Look for save files matching the game name
					const saves = [];
					for await (const entry of emulatorHandle.values()) {
						if (entry.kind === 'file' && entry.name.endsWith(saveExt)) {
							const saveBaseName = entry.name.substring(0, entry.name.lastIndexOf('.'));
							// Check if this save matches the current game (fuzzy match)
							if (saveBaseName.toLowerCase() === baseName.toLowerCase() ||
								saveBaseName.toLowerCase().includes(baseName.toLowerCase()) ||
								baseName.toLowerCase().includes(saveBaseName.toLowerCase())) {
								const file = await entry.getFile();
								saves.push({
									name: entry.name,
									handle: entry,
									size: file.size,
									modified: file.lastModified
								});
							}
						}
					}

					if (saves.length === 0) {
						const saveLocation = getSaveLocationText(currentDevice, emulator);
						list.innerHTML = `
							<div style="text-align: center; padding: 2em; color: rgba(255,255,255,0.6);">
								<span class="icon solid fa-folder-open" style="font-size: 2em; margin-bottom: 0.5em; display: block;"></span>
								<p>No save files found for this game.</p>
								<p style="font-size: 0.85em;">Save location: ${saveLocation}</p>
							</div>
						`;
						return;
					}

					// Display saves
					let html = '';
					for (const save of saves) {
						const date = new Date(save.modified).toLocaleDateString();
						const size = (save.size / 1024).toFixed(1) + ' KB';
						html += `
							<div style="display: flex; align-items: center; padding: 0.75em; background: rgba(34, 211, 238, 0.1); border-radius: 8px; margin-bottom: 0.5em;">
								<span class="icon solid fa-save" style="color: #22d3ee; margin-right: 0.75em; font-size: 1.2em;"></span>
								<div style="flex: 1;">
									<div style="font-weight: 500;">${save.name}</div>
									<div style="font-size: 0.8em; color: rgba(255,255,255,0.5);">${size} ‚Ä¢ ${date}</div>
								</div>
								<button class="btn-3d small" onclick="downloadSave('${save.name}')" title="Download">
									<span class="icon solid fa-download"></span>
								</button>
								<button class="btn-3d small red" onclick="event.stopPropagation(); deleteSave('${save.name}')" title="Delete" style="margin-left: 0.25em;">
									<span class="icon solid fa-trash"></span>
								</button>
							</div>
						`;
					}
					list.innerHTML = html;

				} catch (e) {
					console.error('Error loading saves:', e);
					list.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6); padding: 2em;">Error loading saves: ' + e.message + '</p>';
				}
			}

			async function downloadSave(saveName) {
				const emulator = getEmulatorForConsole(gameConsole || currentConsole, currentDevice);
				try {
					const emulatorHandle = await getSaveFolderHandle(currentDevice, emulator, false);
					if (!emulatorHandle) {
						alert('Save folder not found.');
						return;
					}
					const fileHandle = await emulatorHandle.getFileHandle(saveName);
					const file = await fileHandle.getFile();

					// Create download
					const url = URL.createObjectURL(file);
					const a = document.createElement('a');
					a.href = url;
					a.download = saveName;
					a.click();
					URL.revokeObjectURL(url);
				} catch (e) {
					alert('Error downloading save: ' + e.message);
				}
			}

			let pendingDeleteSave = null;

			function deleteSave(saveName) {
				pendingDeleteSave = saveName;
				document.getElementById('deleteSaveConfirmText').innerHTML = `Are you sure you want to delete <strong>"${saveName}"</strong>?<br><span style="font-size: 0.85em; color: rgba(255,255,255,0.6);">This cannot be undone.</span>`;
				document.getElementById('deleteSaveModal').classList.add('active');
			}

			async function executeDeleteSave() {
				if (!pendingDeleteSave) return;

				const saveName = pendingDeleteSave;
				const emulator = getEmulatorForConsole(gameConsole || currentConsole, currentDevice);
				try {
					const emulatorHandle = await getSaveFolderHandle(currentDevice, emulator, false);
					if (!emulatorHandle) {
						alert('Save folder not found.');
						return;
					}
					await emulatorHandle.removeEntry(saveName);

					closeModal('deleteSaveModal');
					pendingDeleteSave = null;

					// Reload saves list
					const baseName = currentGame.substring(0, currentGame.lastIndexOf('.'));
					loadLocalSaves(baseName);
				} catch (e) {
					alert('Error deleting save: ' + e.message);
				}
			}

			function uploadLocalSave() {
				document.getElementById('saveFileInput').click();
			}

			async function handleSaveUpload(event) {
				const file = event.target.files[0];
				if (!file) return;

				const emulator = getEmulatorForConsole(gameConsole || currentConsole, currentDevice);
				if (!emulator) {
					alert('Console not supported for save management.');
					return;
				}

				try {
					// Navigate to save folder, creating if needed
					const emulatorHandle = await getSaveFolderHandle(currentDevice, emulator, true);
					if (!emulatorHandle) {
						alert('Could not create save folder.');
						return;
					}

					// Write save file
					const fileHandle = await emulatorHandle.getFileHandle(file.name, { create: true });
					const writable = await fileHandle.createWritable();
					await writable.write(file);
					await writable.close();

					// Reload saves list
					const baseName = currentGame.substring(0, currentGame.lastIndexOf('.'));
					loadLocalSaves(baseName);

					// Clear file input
					event.target.value = '';
				} catch (e) {
					alert('Error uploading save: ' + e.message);
				}
			}

			// PWA Install functionality
			let deferredPrompt;

			window.addEventListener('beforeinstallprompt', (e) => {
				// Prevent Chrome from showing the default prompt
				e.preventDefault();
				// Save the event for later
				deferredPrompt = e;
				// Show our install button
				document.getElementById('installPwaBtn').style.display = 'inline-flex';
				console.log('NanoArcade: Install prompt ready');
			});

			window.addEventListener('appinstalled', () => {
				// Hide the install button after installation
				document.getElementById('installPwaBtn').style.display = 'none';
				deferredPrompt = null;
				console.log('NanoArcade: App installed successfully');
			});

			async function installPwa() {
				if (!deferredPrompt) {
					// Already installed or not supported
					alert('App is already installed or installation is not available in this browser.');
					return;
				}
				// Show the install prompt
				deferredPrompt.prompt();
				// Wait for user response
				const { outcome } = await deferredPrompt.userChoice;
				console.log('NanoArcade: Install prompt outcome:', outcome);
				// Clear the prompt
				deferredPrompt = null;
				// Hide button regardless of outcome
				document.getElementById('installPwaBtn').style.display = 'none';
			}
		</script>

	</body>
</html>
